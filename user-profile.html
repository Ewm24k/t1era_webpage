<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,viewport-fit=cover"/>
  <title>T1ERA — Profile</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Orbitron:wght@400;500;600;700;800;900&family=Fira+Code:wght@300;400;500&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/@phosphor-icons/web@2.1.1/src/index.js"></script>
  <style>
    /* ── ROOT ── */
    :root {
      --bg:#000; --bg-2:#090909; --bg-3:#111; --bg-4:#181818; --bg-card:#141414;
      --border:rgba(255,255,255,.08); --border-2:rgba(255,255,255,.12);
      --text:#fff; --text-2:rgba(255,255,255,.65); --text-3:rgba(255,255,255,.38);
      --pink:#c2185b; --pink-2:#e91e8c; --pink-glow:rgba(194,24,91,.25);
      --purple:#8b5cf6; --purple-glow:rgba(139,92,246,.2);
      --green:#10b981; --orange:#f97316; --gold:#f59e0b;
      --radius-sm:8px; --radius:14px; --radius-lg:20px;
      --font-display:"Orbitron",sans-serif;
      --font-body:"DM Sans",sans-serif;
      --font-mono:"Fira Code",monospace;
      --transition:cubic-bezier(.4,0,.2,1);
    }
    *,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }
    html { scroll-behavior:smooth; overflow-x:hidden; }
    body { font-family:var(--font-body); background:var(--bg); color:var(--text); min-height:100vh; -webkit-font-smoothing:antialiased; overflow-x:hidden; }
    ::-webkit-scrollbar { width:4px; }
    ::-webkit-scrollbar-thumb { background:rgba(194,24,91,.3); border-radius:4px; }

    /* ── TOPBAR ── */
    .topbar {
      position:sticky; top:0; z-index:200; height:52px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 max(16px,env(safe-area-inset-left)) 0 max(16px,env(safe-area-inset-right));
      background:rgba(0,0,0,.85); backdrop-filter:blur(20px);
      border-bottom:1px solid var(--border);
    }
    .topbar-logo { display:flex; align-items:center; gap:8px; font-family:var(--font-display); font-size:14px; font-weight:700; color:var(--text); text-decoration:none; letter-spacing:.06em; }
    .topbar-logo-mark { width:28px; height:28px; border-radius:7px; background:linear-gradient(135deg,var(--pink),var(--purple)); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:900; box-shadow:0 0 12px var(--pink-glow); }
    .topbar-back { display:flex; align-items:center; gap:6px; font-size:13px; color:var(--text-2); text-decoration:none; font-weight:500; transition:color .2s; cursor:pointer; background:none; border:none; }
    .topbar-back:hover { color:var(--text); }
    .topbar-back i { font-size:16px; }

    /* ── WRAP ── */
    .profile-wrap { max-width:720px; margin:0 auto; padding:0 0 calc(80px + env(safe-area-inset-bottom)); }

    /* ── BANNER PRESETS ── */
    .banner-preset-default { background: linear-gradient(135deg,rgba(194,24,91,.18) 0%,rgba(139,92,246,.12) 50%,rgba(0,0,0,.6) 100%), repeating-linear-gradient(60deg,transparent,transparent 40px,rgba(255,255,255,.012) 40px,rgba(255,255,255,.012) 41px) !important; background-color:#0d0009 !important; }
    .banner-preset-midnight { background:linear-gradient(135deg,#0f0c29 0%,#1a1a2e 40%,#16213e 70%,#0f3460 100%) !important; background-color:#0f0c29 !important; }
    .banner-preset-cyber { background: linear-gradient(135deg,rgba(0,255,136,.12) 0%,rgba(0,212,255,.1) 50%,rgba(0,0,0,.7) 100%), repeating-linear-gradient(90deg,transparent,transparent 60px,rgba(0,255,136,.03) 60px,rgba(0,255,136,.03) 61px) !important; background-color:#020a12 !important; }
    .banner-preset-pinky { background:linear-gradient(135deg,#ff9ec4 0%,#ffd6e8 30%,#fff0f6 55%,#ffc2dd 80%,#ff85b3 100%) !important; background-color:#ffb3d1 !important; }

    /* ── BANNER ── */
    .profile-banner { position:relative; height:200px; background:linear-gradient(135deg,rgba(194,24,91,.18) 0%,rgba(139,92,246,.12) 50%,rgba(0,0,0,.6) 100%); background-color:#0d0009; overflow:hidden; }
    .profile-banner::before { content:""; position:absolute; inset:0; background:radial-gradient(ellipse at 20% 50%,rgba(194,24,91,.22) 0%,transparent 60%),radial-gradient(ellipse at 80% 30%,rgba(139,92,246,.18) 0%,transparent 55%); animation:bannerPulse 6s ease-in-out infinite; }
    @keyframes bannerPulse { 0%,100%{opacity:1}50%{opacity:.7} }
    .banner-bg-img { position:absolute; inset:0; background-size:cover; background-position:center; background-repeat:no-repeat; z-index:0; }

    /* Rank badge */
    .rank-badge { position:absolute; top:16px; left:20px; display:flex; flex-direction:column; gap:3px; z-index:2; }
    .rank-level-chip { display:inline-flex; align-items:center; gap:6px; padding:4px 10px 4px 8px; background:rgba(0,0,0,.65); backdrop-filter:blur(12px); border:1px solid rgba(245,158,11,.35); border-radius:100px; }
    .rank-shield { width:20px; height:20px; flex-shrink:0; }
    .rank-level-num { font-family:var(--font-display); font-size:11px; font-weight:800; color:var(--gold); letter-spacing:.04em; }
    .rank-title-chip { display:inline-flex; align-items:center; padding:3px 8px; background:rgba(0,0,0,.5); backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,.1); border-radius:100px; }
    .rank-title-text { font-family:var(--font-display); font-size:9px; font-weight:600; color:rgba(255,255,255,.75); letter-spacing:.1em; text-transform:uppercase; }
    .callsign-chip { display:inline-flex; align-items:center; gap:4px; padding:2px 8px; background:rgba(194,24,91,.2); border:1px solid rgba(194,24,91,.3); border-radius:100px; }
    .callsign-text { font-family:var(--font-mono); font-size:9px; font-weight:500; color:var(--pink-2); letter-spacing:.06em; }

    /* ── IDENTITY ── */
    .profile-identity { padding:0 20px; margin-top:-50px; position:relative; z-index:3; }
    .avatar-wrap { width:88px; height:88px; position:relative; margin-bottom:14px; }
    .avatar-img, .avatar-fallback { width:88px; height:88px; border-radius:50%; object-fit:cover; border:3px solid var(--bg); }
    .avatar-fallback { background:linear-gradient(135deg,var(--pink),var(--purple)); display:flex; align-items:center; justify-content:center; font-size:28px; font-weight:700; font-family:var(--font-display); color:#fff; }
    .avatar-ring { position:absolute; inset:-3px; border-radius:50%; background:linear-gradient(135deg,var(--pink),var(--purple)); z-index:-1; }

    .identity-info { display:flex; flex-direction:column; gap:4px; }
    .identity-fullname { font-size:18px; font-weight:700; color:var(--text); line-height:1.2; }
    .identity-nickname { font-size:13px; color:var(--text-3); font-family:var(--font-mono); }

    /* badges */
    .badges-strip { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .acct-type-badge { display:inline-flex; align-items:center; gap:4px; padding:3px 9px; border-radius:100px; font-size:9.5px; font-weight:600; font-family:var(--font-body); letter-spacing:.04em; }
    .acct-type-badge.standard { background:rgba(139,92,246,.1); border:1px solid rgba(139,92,246,.25); color:var(--purple); }
    .acct-type-badge.free { background:var(--bg-3); border:1px solid var(--border); color:var(--text-3); }
    .acct-type-badge.pro { background:rgba(245,158,11,.1); border:1px solid rgba(245,158,11,.25); color:var(--gold); }
    .verified-tag { display:inline-flex; align-items:center; gap:4px; padding:3px 9px; border-radius:100px; font-size:9.5px; font-weight:600; font-family:var(--font-body); }
    .verified-tag.verified { background:rgba(16,185,129,.1); border:1px solid rgba(16,185,129,.3); color:var(--green); }
    .verified-tag.unverified { background:var(--bg-3); border:1px solid var(--border); color:var(--text-3); }

    /* bio & status */
    .bio-display { font-size:13px; color:var(--text-2); line-height:1.55; margin-top:8px; }
    .bio-link-pill { display:inline-flex; align-items:center; gap:5px; padding:3px 10px; border-radius:100px; background:rgba(139,92,246,.08); border:1px solid rgba(139,92,246,.2); color:var(--purple); font-size:11px; text-decoration:none; margin:4px 4px 0 0; transition:all .15s; }
    .bio-link-pill:hover { background:rgba(139,92,246,.18); }
    .status-line { display:flex; align-items:center; gap:7px; margin-top:8px; font-size:12px; color:var(--text-3); font-style:italic; }
    .status-label { font-size:9px; font-weight:700; letter-spacing:.12em; color:var(--text-3); font-family:var(--font-mono); white-space:nowrap; text-transform:uppercase; flex-shrink:0; }

    /* ── STATS ROW ── */
    .stats-row { display:flex; align-items:center; gap:0; padding:16px 20px; border-top:1px solid var(--border); border-bottom:1px solid var(--border); margin-top:16px; }
    .stat-block { flex:1; display:flex; flex-direction:column; align-items:center; gap:2px; padding:8px 4px; border-radius:10px; position:relative; }
    .stat-block:not(:last-child)::after { content:""; position:absolute; right:0; top:20%; height:60%; width:1px; background:var(--border); }
    .stat-num { font-family:var(--font-display); font-size:18px; font-weight:700; color:var(--text); letter-spacing:-.02em; }
    .stat-label { font-size:10px; color:var(--text-3); font-weight:500; letter-spacing:.06em; text-transform:uppercase; font-family:var(--font-mono); }

    /* ── CHIPS ── */
    .chips-row { display:flex; flex-wrap:wrap; gap:7px; padding:14px 20px; }
    .chip { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; border-radius:100px; font-size:10.5px; font-weight:500; color:var(--text-2); background:var(--bg-3); border:1px solid var(--border); font-family:var(--font-body); white-space:nowrap; }
    .chip i { font-size:12px; color:var(--text-3); }
    .chip.highlight { border-color:rgba(194,24,91,.25); color:rgba(194,24,91,.85); background:rgba(194,24,91,.06); }
    .chip.gold-chip { border-color:rgba(245,158,11,.25); color:rgba(245,158,11,.8); background:rgba(245,158,11,.05); }

    /* ── TABS ── */
    .tabs-wrap { padding:0 20px; margin-top:8px; }
    .tabs-header { display:flex; border-bottom:1px solid var(--border); }
    .tab-btn { flex:1; padding:11px 8px; font-size:11.5px; font-weight:600; color:var(--text-3); background:none; border:none; border-bottom:2px solid transparent; cursor:pointer; transition:all .2s; font-family:var(--font-body); letter-spacing:.04em; text-transform:uppercase; position:relative; bottom:-1px; }
    .tab-btn.active { color:var(--text); border-bottom-color:var(--pink); }
    .tab-panel { display:none; padding-top:20px; }
    .tab-panel.active { display:block; }

    /* Sparks */
    .sparks-grid { display:flex; flex-direction:column; gap:12px; }
    .spark-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; transition:border-color .2s; }
    .spark-card:hover { border-color:rgba(194,24,91,.2); }
    .spark-header { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .spark-avatar { width:34px; height:34px; border-radius:50%; object-fit:cover; border:1.5px solid rgba(194,24,91,.25); }
    .spark-avatar-fallback { width:34px; height:34px; border-radius:50%; background:linear-gradient(135deg,var(--pink),var(--purple)); display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; color:#fff; font-family:var(--font-display); flex-shrink:0; }
    .spark-meta { flex:1; }
    .spark-name { font-size:12.5px; font-weight:600; color:var(--text); }
    .spark-time { font-size:10px; color:var(--text-3); font-family:var(--font-mono); }
    .spark-rank-chip { font-family:var(--font-display); font-size:8px; color:rgba(245,158,11,.7); background:rgba(245,158,11,.07); border:1px solid rgba(245,158,11,.15); padding:2px 6px; border-radius:100px; letter-spacing:.06em; }
    .spark-body { font-size:13.5px; color:var(--text-2); line-height:1.6; margin-bottom:12px; }
    .spark-tag { display:inline-flex; align-items:center; color:var(--pink-2); font-size:13px; font-weight:500; }
    .spark-actions { display:flex; align-items:center; gap:16px; padding-top:10px; border-top:1px solid var(--border); }
    .spark-action { display:flex; align-items:center; gap:5px; font-size:11.5px; color:var(--text-3); background:none; border:none; font-family:var(--font-body); cursor:default; }
    .spark-action i { font-size:15px; }

    /* empty */
    .tab-empty { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:52px 20px; gap:10px; text-align:center; }
    .tab-empty-icon { width:52px; height:52px; border-radius:16px; background:var(--bg-3); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:24px; }
    .tab-empty-title { font-size:14px; font-weight:600; color:var(--text-2); }
    .tab-empty-sub { font-size:12px; color:var(--text-3); max-width:240px; line-height:1.5; }

    /* ── FOLLOW BUTTON (top-right of page) ── */
    .page-follow-btn {
      display: inline-flex; align-items:center; gap:7px;
      padding:8px 18px; border-radius:100px;
      background:var(--pink); border:none; color:#fff;
      font-size:12px; font-weight:700; font-family:var(--font-body);
      letter-spacing:.03em; cursor:pointer; transition:background .2s;
    }
    .page-follow-btn:hover { background:var(--pink-2); }
    .page-follow-btn.following { background:rgba(255,255,255,.07); border:1px solid var(--border-2); color:var(--text-2); }
    .page-follow-btn.following:hover { background:rgba(239,68,68,.08); border-color:rgba(239,68,68,.3); color:rgba(239,68,68,.8); }
    .page-follow-btn.friends { background:rgba(16,185,129,.1); border:1px solid rgba(16,185,129,.3); color:var(--green); }

    /* ── SKELETON ── */
    .skeleton { background:linear-gradient(90deg,var(--bg-3) 25%,rgba(255,255,255,.04) 50%,var(--bg-3) 75%); background-size:200% 100%; animation:shimmer 1.4s infinite; border-radius:6px; }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .fade-up { opacity:0; transform:translateY(16px); animation:fadeUp .5s forwards; }
    @keyframes fadeUp { to{opacity:1;transform:none} }

    /* ── TOAST ── */
    .page-toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(60px); background:rgba(10,6,14,.97); border:1px solid rgba(194,24,91,.3); border-radius:100px; padding:10px 20px; font-size:12px; font-weight:600; color:var(--text-2); z-index:300; transition:transform .3s,opacity .25s; opacity:0; white-space:nowrap; }
    .page-toast.show { transform:translateX(-50%) translateY(0); opacity:1; }
    .page-toast.success { border-color:rgba(16,185,129,.4); color:var(--green); }
    .page-toast.error { border-color:rgba(239,68,68,.3); color:rgba(239,68,68,.8); }

    /* ── ERROR STATE ── */
    .error-state { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:60vh; gap:16px; text-align:center; padding:40px 20px; }
    .error-state i { font-size:48px; opacity:.2; }
    .error-state h2 { font-size:18px; font-weight:700; color:var(--text-2); }
    .error-state p { font-size:13px; color:var(--text-3); max-width:260px; line-height:1.6; }

    /* Mobile responsive */
    @media (max-width:640px) {
      .profile-banner { height:160px; }
      .profile-identity { padding:0 14px; margin-top:-42px; }
      .avatar-wrap { width:76px; height:76px; }
      .avatar-img,.avatar-fallback { width:76px; height:76px; font-size:22px; }
      .identity-fullname { font-size:15px; }
      .stats-row { padding:12px 14px; }
      .chips-row,.tabs-wrap { padding:0 14px; }
    }
    @media (max-width:390px) {
      .profile-banner { height:140px; }
    }
  </style>
</head>
<body>

  <!-- TOPBAR -->
  <nav class="topbar">
    <button class="topbar-back" onclick="history.back()">
      <i class="ph-bold ph-arrow-left"></i>
      Back
    </button>
    <a href="home.html" class="topbar-logo">
      <div class="topbar-logo-mark">T1</div>
      T1ERA
    </a>
    <div style="width:52px"></div>
  </nav>

  <!-- LOADING STATE -->
  <div id="loadingState" style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:70vh;gap:16px;color:var(--text-3);font-size:13px;font-family:var(--font-body);">
    <div style="width:32px;height:32px;border:2px solid rgba(194,24,91,.2);border-top-color:var(--pink);border-radius:50%;animation:spin .7s linear infinite;"></div>
    Loading profile…
  </div>
  <style>@keyframes spin{to{transform:rotate(360deg)}}</style>

  <!-- ERROR STATE -->
  <div id="errorState" style="display:none;" class="error-state">
    <i class="ph-bold ph-user-slash"></i>
    <h2>Profile not found</h2>
    <p>This user doesn't exist or their profile is unavailable.</p>
    <button onclick="history.back()" style="padding:9px 22px;border-radius:100px;background:var(--pink);border:none;color:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:var(--font-body);">Go Back</button>
  </div>

  <!-- PROFILE CONTENT -->
  <div id="profileContent" class="profile-wrap" style="display:none;">

    <!-- BANNER -->
    <div class="profile-banner fade-up" id="profileBanner">
      <div class="banner-bg-img" id="bannerBgImg"></div>

      <!-- Rank badge -->
      <div class="rank-badge" id="rankBadge">
        <div class="rank-level-chip">
          <svg class="rank-shield" viewBox="0 0 24 24" fill="none">
            <path d="M12 2L4 6V12C4 16.42 7.56 20.55 12 22C16.44 20.55 20 16.42 20 12V6L12 2Z" fill="rgba(245,158,11,0.2)" stroke="#f59e0b" stroke-width="1.5" stroke-linejoin="round"/>
            <text x="12" y="16" text-anchor="middle" font-family="Orbitron" font-size="8" font-weight="800" fill="#f59e0b" id="rankLevelSvg">1</text>
          </svg>
          <span class="rank-level-num" id="rankLevelNum">LV 1</span>
        </div>
        <div class="rank-title-chip">
          <span class="rank-title-text" id="rankTitleText">Recruit</span>
        </div>
        <div class="callsign-chip">
          <span style="font-size:8px;color:rgba(194,24,91,.5)">⬡</span>
          <span class="callsign-text" id="callsignText">—</span>
        </div>
      </div>

      <!-- Follow button (top-right) -->
      <div style="position:absolute;top:12px;right:14px;z-index:5;">
        <button class="page-follow-btn" id="pageFollowBtn" onclick="togglePageFollow()">
          <i class="ph-bold ph-user-plus"></i> Follow
        </button>
      </div>
    </div>

    <!-- IDENTITY -->
    <div class="profile-identity fade-up" style="animation-delay:.08s;">
      <div class="avatar-wrap">
        <div class="avatar-ring"></div>
        <div id="avatarContainer">
          <div class="avatar-fallback" id="avatarFallback"></div>
        </div>
      </div>

      <div class="identity-info">
        <div class="identity-fullname" id="displayFullName">—</div>
        <div class="identity-nickname" id="displayNickname"></div>

        <!-- Badges -->
        <div class="badges-strip" id="badgesStrip"></div>

        <!-- Bio -->
        <div class="bio-display" id="bioDisplay"></div>
        <div id="bioLinksDisplay" style="margin-top:6px;display:flex;flex-wrap:wrap;gap:4px;"></div>

        <!-- Status -->
        <div class="status-line" id="statusLine" style="display:none;">
          <span class="status-label">Status :</span>
          <span id="statusText" style="font-style:italic;"></span>
        </div>
      </div>
    </div>

    <!-- STATS ROW -->
    <div class="stats-row fade-up" style="animation-delay:.16s;">
      <div class="stat-block">
        <span class="stat-num" id="sparkCount">—</span>
        <span class="stat-label">Sparks</span>
      </div>
      <div class="stat-block">
        <span class="stat-num" id="followersCount">—</span>
        <span class="stat-label">Followers</span>
      </div>
      <div class="stat-block">
        <span class="stat-num" id="followingCount">—</span>
        <span class="stat-label">Following</span>
      </div>
    </div>

    <!-- CHIPS -->
    <div class="chips-row fade-up" id="chipsRow" style="animation-delay:.24s;"></div>

    <!-- TABS: Sparks only (activity & intel are private) -->
    <div class="tabs-wrap fade-up" style="animation-delay:.32s;">
      <div class="tabs-header">
        <button class="tab-btn active" onclick="switchTab(0,this)">Sparks</button>
        <!-- Activity and Intel are private — not shown to visitors -->
      </div>

      <!-- TAB 0: SPARKS -->
      <div class="tab-panel active" id="tab-0">
        <div class="sparks-grid" id="sparksGrid">
          <!-- filled by JS -->
        </div>
      </div>
    </div>

  </div><!-- end profile-wrap -->

  <!-- TOAST -->
  <div class="page-toast" id="pageToast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, deleteDoc,
      collection, getDocs, query, where, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBnt9mbb8LdMVeguSHUmS20L6uBHIfxwAs",
      authDomain: "t1era-v2.firebaseapp.com",
      projectId: "t1era-v2",
      storageBucket: "t1era-v2.firebasestorage.app",
      messagingSenderId: "279266491659",
      appId: "1:279266491659:web:28a03c7b7300fcb152b60e",
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ── Get target UID from URL ── */
    const params    = new URLSearchParams(window.location.search);
    const targetUid = params.get('uid');

    if (!targetUid) {
      showError();
    }

    /* ── Auth state: get current viewer ── */
    let viewerUid    = null;
    let viewerData   = null;
    let isFollowing  = false;

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        viewerUid  = user.uid;
        // Fetch viewer data for follow operations
        try {
          const snap = await getDoc(doc(db, 'users', user.uid));
          if (snap.exists()) viewerData = snap.data();
        } catch (_) {}
        // Check if viewer follows target
        if (targetUid && targetUid !== viewerUid) {
          try {
            const followSnap = await getDoc(doc(db, 'follows', `${viewerUid}_${targetUid}`));
            isFollowing = followSnap.exists();
          } catch (_) {}
        }
      }
      if (targetUid) {
        loadProfile(targetUid);
      }
    });

    /* ═══════════════════════════════════════════
       LOAD PROFILE
    ═══════════════════════════════════════════ */
    async function loadProfile(uid) {
      try {
        const snap = await getDoc(doc(db, 'users', uid));
        if (!snap.exists()) { showError(); return; }

        const d = snap.data();
        applyProfile(d, uid);
        await Promise.all([
          loadSparks(uid, d),
          loadFollowCounts(uid),
        ]);
      } catch (e) {
        console.error('loadProfile error:', e);
        showError();
      }
    }

    /* ═══════════════════════════════════════════
       APPLY PROFILE DATA
    ═══════════════════════════════════════════ */
    function applyProfile(d, uid) {
      // Banner
      const bannerData = d.bannerImage;
      if (bannerData?.url && bannerData.source === 'cloudinary') {
        const layer = document.getElementById('bannerBgImg');
        if (layer) layer.style.backgroundImage = `url('${bannerData.url}')`;
      } else if (bannerData?.preset) {
        const banner = document.getElementById('profileBanner');
        const presetMap = { default:'banner-preset-default', midnight:'banner-preset-midnight', cyber:'banner-preset-cyber', pinky:'banner-preset-pinky' };
        const cls = presetMap[bannerData.preset];
        if (cls && banner) banner.classList.add(cls);
      }

      // Avatar
      const photoURL = d.profilePicture?.url || '';
      if (photoURL) {
        const container = document.getElementById('avatarContainer');
        const fallback  = document.getElementById('avatarFallback');
        const img = document.createElement('img');
        img.className = 'avatar-img';
        img.src = photoURL;
        img.referrerPolicy = 'no-referrer';
        img.onerror = () => { img.style.display = 'none'; };
        container.insertBefore(img, fallback);
        fallback.style.display = 'none';
      }
      const initial = (d.fullName || d.nickname || '?')[0].toUpperCase();
      const fb = document.getElementById('avatarFallback');
      if (fb) fb.textContent = initial;

      // Name
      document.getElementById('displayFullName').textContent = d.fullName || d.nickname || 'T1ERA User';
      const nick = d.nickname ? `@${d.nickname}` : '';
      document.getElementById('displayNickname').textContent = nick;

      // Rank — read directly from stored fields, same pattern as user-peek.js
      const lvl       = d.rank?.level   || 1;
      const rankTitle = d.rank?.title   || 'Recruit';

      document.getElementById('rankLevelSvg').textContent  = lvl;
      document.getElementById('rankLevelNum').textContent  = `LV ${lvl}`;
      document.getElementById('rankTitleText').textContent = rankTitle;
      document.getElementById('callsignText').textContent  = (d.callsign || '—').toUpperCase();

      // Account badges
      const badgesStrip = document.getElementById('badgesStrip');
      if (badgesStrip) {
        const isVer   = d.accountStatus?.verified || false;
        const acctTyp = d.accountStatus?.type || 'standard';
        const planTyp = d.plan?.type || 'free';
        badgesStrip.innerHTML = `
          <span class="acct-type-badge ${acctTyp}">${cap(acctTyp)}</span>
          <span class="acct-type-badge ${planTyp}">${cap(planTyp)} Plan</span>
          ${isVer ? '<span class="verified-tag verified">✓ Verified</span>' : ''}`;
      }

      // Bio
      const bioText  = d.userBio || '';
      const bioLinks = d.userBioLinks || [];
      const bioEl    = document.getElementById('bioDisplay');
      if (bioEl) bioEl.textContent = bioText;

      const linksEl = document.getElementById('bioLinksDisplay');
      if (linksEl && bioLinks.length > 0) {
        linksEl.innerHTML = bioLinks.filter(l=>l.trim()).map(url => {
          const href = url.startsWith('http') ? url : 'https://'+url;
          return `<a class="bio-link-pill" href="${href}" target="_blank" rel="noopener noreferrer">
            <i class="ph-bold ph-link"></i>${url.replace(/^https?:\/\//,'')}
          </a>`;
        }).join('');
      }

      // Status
      const statusVal = d.userStatus || '';
      if (statusVal) {
        const line = document.getElementById('statusLine');
        const txt  = document.getElementById('statusText');
        if (line) line.style.display = 'flex';
        if (txt)  txt.textContent = statusVal;
      }

      // Chips
      buildChips(d);

      // Follow button state
      updateFollowBtn();

      // Hide self from following themselves
      const followBtn = document.getElementById('pageFollowBtn');
      if (followBtn && viewerUid === uid) {
        followBtn.style.display = 'none';
      }

      // Show content
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('profileContent').style.display = 'block';
    }

    /* ═══════════════════════════════════════════
       LOAD SPARKS
    ═══════════════════════════════════════════ */
    async function loadSparks(uid, d) {
      const grid = document.getElementById('sparksGrid');
      if (!grid) return;
      try {
        const snap = await getDocs(
          query(collection(db,'sparks'), where('uid','==',uid), where('tab','==','standard'))
        );

        document.getElementById('sparkCount').textContent = snap.size;

        if (snap.empty) {
          grid.innerHTML = `<div class="tab-empty"><div class="tab-empty-icon">⚡</div><div class="tab-empty-title">No sparks yet</div><div class="tab-empty-sub">This user hasn't posted any Sparks.</div></div>`;
          return;
        }

        const docs = [];
        snap.forEach(ds => docs.push({ id:ds.id, data:ds.data() }));
        docs.sort((a,b) => (b.data.createdAt?.toMillis?.()||0) - (a.data.createdAt?.toMillis?.()||0));

        const name  = d.fullName || d.nickname || 'User';
        const photo = d.profilePicture?.url || '';
        const rank  = (d.rank?.title||'Recruit');
        const level = (d.rank?.level||1);

        grid.innerHTML = docs.map(({id, data:sp}) => {
          const time = sp.createdAt?.toDate
            ? sp.createdAt.toDate().toLocaleString('en-MY',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})
            : 'Just now';
          const txt = (sp.text||'')
            .replace(/(#\w+)/g,'<span class="spark-tag">$1</span>')
            .replace(/(@\w+)/g,'<span style="color:var(--purple)">$1</span>');
          const avHtml = photo
            ? `<img src="${photo}" referrerpolicy="no-referrer" class="spark-avatar" onerror="this.style.display='none'">`
            : `<div class="spark-avatar-fallback">${name[0].toUpperCase()}</div>`;
          const ytBlock = sp.youtubeId ? `
            <div style="margin-top:8px;border-radius:10px;overflow:hidden;border:1px solid var(--border-2);">
              <img src="https://i.ytimg.com/vi/${sp.youtubeId}/hqdefault.jpg" style="width:100%;display:block;">
            </div>` : '';
          return `
            <div class="spark-card">
              <div class="spark-header">
                ${avHtml}
                <div class="spark-meta">
                  <div class="spark-name">${name} <span class="spark-rank-chip">LV${level} · ${rank}</span></div>
                  <div class="spark-time">${time}</div>
                </div>
              </div>
              <div class="spark-body">${txt}${ytBlock}</div>
              <div class="spark-actions">
                <button class="spark-action"><i class="ph-bold ph-heart"></i> ${sp.likes||0}</button>
                <button class="spark-action"><i class="ph-bold ph-chat-circle"></i> ${sp.replies||0}</button>
                <button class="spark-action"><i class="ph-bold ph-arrows-clockwise"></i> ${sp.reposts||0}</button>
              </div>
            </div>`;
        }).join('');
      } catch(e) {
        console.error('loadSparks error:', e);
      }
    }

    /* ═══════════════════════════════════════════
       FOLLOW COUNTS
    ═══════════════════════════════════════════ */
    async function loadFollowCounts(uid) {
      try {
        const [fersSnap, fingSnap] = await Promise.all([
          getDocs(query(collection(db,'follows'), where('followedId','==',uid))),
          getDocs(query(collection(db,'follows'), where('followerId','==',uid))),
        ]);
        document.getElementById('followersCount').textContent = fersSnap.size;
        document.getElementById('followingCount').textContent = fingSnap.size;
      } catch(_) {}
    }

    /* ═══════════════════════════════════════════
       FOLLOW / UNFOLLOW
    ═══════════════════════════════════════════ */
    window.togglePageFollow = async function () {
      if (!viewerUid || !targetUid || viewerUid === targetUid) return;

      const followDocId = `${viewerUid}_${targetUid}`;
      const btn = document.getElementById('pageFollowBtn');
      if (btn) { btn.disabled = true; btn.style.opacity = '0.6'; }

      try {
        if (!isFollowing) {
          // Follow
          const fromName   = viewerData?.fullName   || viewerData?.nickname || '';
          const fromHandle = viewerData?.nickname   || viewerUid.slice(0,8);
          const fromPhoto  = viewerData?.profilePicture?.url || '';

          await setDoc(doc(db,'follows',followDocId), {
            followerId: viewerUid, followedId: targetUid,
            fromName, fromHandle, fromPhoto,
            createdAt: serverTimestamp(),
          });
          // Notification
          try {
            await setDoc(doc(db,'users',targetUid,'notifications',`follow_${viewerUid}_${targetUid}`), {
              type:'follow', fromUid:viewerUid, fromName, fromHandle, fromPhoto,
              message:`<strong>${fromName||'Someone'}</strong> started following you`,
              read:false, createdAt:serverTimestamp(),
            });
          } catch(_) {}

          isFollowing = true;
          showToast('✓ Now following!', 'success');
        } else {
          // Unfollow
          await deleteDoc(doc(db,'follows',followDocId));
          isFollowing = false;
          showToast('Unfollowed.', '');
        }
        updateFollowBtn();
        // Refresh count
        await loadFollowCounts(targetUid);
      } catch(e) {
        console.error('togglePageFollow error:', e);
        showToast('✗ Action failed. Try again.', 'error');
      } finally {
        if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
      }
    };

    function updateFollowBtn() {
      const btn = document.getElementById('pageFollowBtn');
      if (!btn) return;
      if (isFollowing) {
        btn.className = 'page-follow-btn friends';
        btn.innerHTML = '<i class="ph-bold ph-check"></i> Following';
      } else {
        btn.className = 'page-follow-btn';
        btn.innerHTML = '<i class="ph-bold ph-user-plus"></i> Follow';
      }
    }

    /* ═══════════════════════════════════════════
       CHIPS
    ═══════════════════════════════════════════ */
    function buildChips(d) {
      const row = document.getElementById('chipsRow');
      const items = [
        d.industry  ? { icon:'ph-briefcase', label:cap(d.industry) } : null,
        d.city      ? { icon:'ph-map-pin',   label:`${d.city}${d.country?', '+d.country:''}` } : null,
        d.language  ? { icon:'ph-translate', label:d.language.toUpperCase() } : null,
        d.aiLevel   ? { icon:'ph-robot',     label:`AI: ${cap(d.aiLevel)}`, cls:'highlight' } : null,
        d.plan?.type? { icon:'ph-crown',     label:`${cap(d.plan.type)} Plan`, cls:d.plan.type==='free'?'':'gold-chip' } : null,
      ].filter(Boolean);
      if (row) row.innerHTML = items.map(c => `<span class="chip ${c.cls||''}"><i class="ph-bold ${c.icon}"></i>${c.label}</span>`).join('');
    }

    /* ═══════════════════════════════════════════
       TABS
    ═══════════════════════════════════════════ */
    window.switchTab = function(idx, btn) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      const panel = document.getElementById(`tab-${idx}`);
      if (panel) panel.classList.add('active');
    };

    /* ═══════════════════════════════════════════
       TOAST
    ═══════════════════════════════════════════ */
    function showToast(msg, type) {
      const t = document.getElementById('pageToast');
      if (!t) return;
      t.textContent = msg;
      t.className = 'page-toast show ' + (type||'');
      clearTimeout(t._t);
      t._t = setTimeout(() => { t.className = 'page-toast'; }, 3000);
    }

    /* ═══════════════════════════════════════════
       HELPERS
    ═══════════════════════════════════════════ */
    function showError() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display   = 'flex';
    }

    function cap(str) {
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }
  </script>

</body>
</html>
