<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>T1ERA ‚Äî MinaThor Video Generator</title>
  <meta name="description" content="Generate cinematic AI videos powered by LTX-2 on Azure A10 GPU. Text-to-video up to 1080p." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       T1ERA CSS VARIABLES ‚Äî shared with index.html
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    :root {
      --bg-primary:    #000000;
      --bg-secondary:  #080810;
      --bg-tertiary:   #0f0f1a;
      --bg-card:       #131320;
      --bg-lift:       #1a1a2e;
      --border-primary:  rgba(255,255,255,0.07);
      --border-hover:    rgba(255,255,255,0.15);
      --border-glow:     rgba(68,170,255,0.3);
      --text-primary:   #f0f0ff;
      --text-secondary: rgba(240,240,255,0.6);
      --text-tertiary:  rgba(240,240,255,0.3);
      --accent-primary:   #3b82f6;
      --accent-secondary: #8b5cf6;
      --accent-tertiary:  #06b6d4;
      --accent-success:   #10b981;
      --accent-video:       #f97316;
      --accent-video-end:   #ec4899;
      --glow-video:         rgba(249,115,22,0.35);
      --glow-video-soft:    rgba(249,115,22,0.12);
      --glow-primary:       rgba(59,130,246,0.3);
      --glow-secondary:     rgba(139,92,246,0.3);
      --font-display: 'Bebas Neue', sans-serif;
      --font-body:    'Outfit', sans-serif;
      --font-mono:    'DM Mono', monospace;
      --ease: cubic-bezier(0.4,0,0.2,1);
      --ease-spring: cubic-bezier(0.34,1.56,0.64,1);
    }

    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    html { scroll-behavior: smooth; }

    body {
      font-family: var(--font-body);
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 9998;
      pointer-events: none;
      opacity: 0.025;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      background-size: 200px 200px;
    }

    .scene-bg { position: fixed; inset: 0; z-index: 0; overflow: hidden; }
    .scene-grid {
      position: absolute; inset: -20%;
      background-image:
        linear-gradient(rgba(249,115,22,0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(249,115,22,0.04) 1px, transparent 1px);
      background-size: 48px 48px;
      transform-origin: center;
      animation: gridDrift 20s linear infinite;
    }
    @keyframes gridDrift {
      0%   { transform: perspective(600px) rotateX(8deg) translateZ(0px); }
      100% { transform: perspective(600px) rotateX(8deg) translateZ(96px); }
    }
    .scene-radial {
      position: absolute; inset: 0;
      background:
        radial-gradient(ellipse 70% 45% at 50% 0%,   rgba(249,115,22,0.15) 0%, transparent 60%),
        radial-gradient(ellipse 40% 30% at 0%   60%,  rgba(236,72,153,0.07) 0%, transparent 50%),
        radial-gradient(ellipse 50% 40% at 100% 40%,  rgba(59,130,246,0.06)  0%, transparent 50%);
      pointer-events: none;
    }

    .page-wrap { position: relative; z-index: 1; }

    header {
      position: sticky; top: 0; z-index: 200;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(24px) saturate(180%);
      border-bottom: 1px solid var(--border-primary);
    }
    .nav {
      max-width: 1360px; margin: 0 auto; padding: 0 28px;
      height: 64px; display: flex; align-items: center;
      justify-content: space-between; gap: 20px;
    }
    .nav-brand { display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .brand-chip {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 9px; display: flex; align-items: center; justify-content: center;
      font-family: var(--font-display); font-size: 18px; color: #fff;
      box-shadow: 0 0 18px var(--glow-primary); letter-spacing: 0.05em;
    }
    .brand-name { font-family: var(--font-display); font-size: 22px; color: var(--text-primary); letter-spacing: 0.08em; }
    .brand-slash { color: var(--text-tertiary); font-family: var(--font-mono); font-size: 13px; padding: 0 8px; }
    .brand-page { font-family: var(--font-body); font-size: 13px; font-weight: 600; color: var(--accent-video); letter-spacing: 0.05em; }
    .nav-status {
      display: flex; align-items: center; gap: 8px;
      font-family: var(--font-mono); font-size: 11px; color: var(--text-secondary);
      padding: 6px 12px; background: var(--bg-card);
      border: 1px solid var(--border-primary); border-radius: 100px;
    }
    .status-pulse {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--accent-success); box-shadow: 0 0 8px var(--accent-success);
      animation: pulse-glow 2s ease-in-out infinite;
    }
    @keyframes pulse-glow { 0%,100% { opacity:1; transform:scale(1); } 50% { opacity:0.5; transform:scale(0.85); } }
    .nav-back {
      display: flex; align-items: center; gap: 6px;
      font-family: var(--font-mono); font-size: 11px; color: var(--text-secondary);
      text-decoration: none; padding: 8px 14px;
      border: 1px solid var(--border-primary); border-radius: 8px;
      transition: all 0.2s var(--ease);
    }
    .nav-back:hover { color: var(--text-primary); border-color: var(--border-hover); background: var(--bg-card); transform: translateX(-2px); }

    .page-hero { padding: 56px 28px 40px; max-width: 1360px; margin: 0 auto; }
    .hero-eyebrow {
      display: flex; align-items: center; gap: 10px;
      font-family: var(--font-mono); font-size: 11px; letter-spacing: 0.15em;
      color: var(--accent-video); text-transform: uppercase; margin-bottom: 14px;
    }
    .hero-eyebrow::before { content: ''; width: 20px; height: 1px; background: var(--accent-video); }
    .page-title {
      font-family: var(--font-display);
      font-size: clamp(52px, 8vw, 96px); line-height: 0.95;
      letter-spacing: 0.04em; color: var(--text-primary); margin-bottom: 14px;
    }
    .page-title .gradient-word {
      background: linear-gradient(90deg, var(--accent-video) 0%, var(--accent-video-end) 100%);
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
      background-size: 200% 100%; animation: slide-gradient 4s linear infinite;
    }
    @keyframes slide-gradient { 0%{background-position:0% 0%} 50%{background-position:100% 0%} 100%{background-position:0% 0%} }
    .page-sub { font-size: 16px; color: var(--text-secondary); line-height: 1.5; }
    .page-sub span { color: var(--text-primary); font-weight: 600; }

    .main-layout {
      max-width: 1360px; margin: 0 auto; padding: 0 28px 80px;
      display: grid; grid-template-columns: 1fr 320px; gap: 20px;
    }
    @media (max-width: 1100px) { .main-layout { grid-template-columns: 1fr; } }

    .card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 18px; overflow: hidden; position: relative; }
    .card-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 20px; border-bottom: 1px solid var(--border-primary); background: rgba(0,0,0,0.2);
    }
    .card-label { font-family: var(--font-mono); font-size: 10px; font-weight: 500; letter-spacing: 0.14em; text-transform: uppercase; color: var(--text-tertiary); }
    .card-badge { font-family: var(--font-mono); font-size: 10px; font-weight: 500; letter-spacing: 0.08em; padding: 3px 9px; border-radius: 4px; }
    .badge-orange { background: rgba(249,115,22,0.12); border: 1px solid rgba(249,115,22,0.3); color: var(--accent-video); }
    .badge-blue { background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.25); color: var(--accent-primary); }
    .badge-green { background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.25); color: var(--accent-success); }
    .card-body { padding: 20px; }

    .mode-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .mode-btn { padding: 14px 16px; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 10px; cursor: pointer; transition: all 0.2s var(--ease); text-align: center; }
    .mode-btn:hover { border-color: var(--border-hover); background: var(--bg-tertiary); }
    .mode-btn.active { background: rgba(249,115,22,0.1); border-color: rgba(249,115,22,0.45); box-shadow: 0 0 16px rgba(249,115,22,0.15); }
    .mode-icon { font-size: 24px; margin-bottom: 6px; }
    .mode-title { font-family: var(--font-display); font-size: 16px; letter-spacing: 0.08em; color: var(--text-secondary); margin-bottom: 2px; }
    .mode-btn.active .mode-title { color: var(--accent-video); }
    .mode-desc { font-family: var(--font-mono); font-size: 10px; color: var(--text-tertiary); }

    .prompt-wrap { margin-bottom: 16px; }
    .prompt-textarea {
      width: 100%; min-height: 140px; background: var(--bg-secondary);
      border: 1px solid var(--border-primary); border-radius: 12px;
      color: var(--text-primary); font-family: var(--font-body); font-size: 15px;
      line-height: 1.65; padding: 16px; resize: vertical; outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .prompt-textarea:focus { border-color: var(--border-glow); box-shadow: 0 0 0 3px rgba(68,170,255,0.08), inset 0 0 20px rgba(249,115,22,0.03); }
    .prompt-textarea::placeholder { color: var(--text-tertiary); }
    .prompt-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; padding: 0 2px; }
    .char-meter { font-family: var(--font-mono); font-size: 11px; color: var(--text-tertiary); }
    .char-meter .count { color: var(--text-secondary); }
    .prompt-tips { font-family: var(--font-mono); font-size: 10px; color: var(--text-tertiary); cursor: pointer; text-decoration: underline; text-underline-offset: 3px; }

    .upload-section { margin-top: 4px; }
    .upload-label { font-family: var(--font-mono); font-size: 10px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-tertiary); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .upload-label .optional { text-transform: none; letter-spacing: 0; opacity: 0.6; font-size: 10px; }
    .upload-label .required { text-transform: none; letter-spacing: 0; font-size: 10px; color: var(--accent-video); }
    .upload-drop { position: relative; border: 1px dashed rgba(249,115,22,0.2); border-radius: 10px; background: rgba(249,115,22,0.03); padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s var(--ease); }
    .upload-drop:hover, .upload-drop.over { border-color: rgba(249,115,22,0.5); background: rgba(249,115,22,0.07); }
    .upload-drop.required { border-color: rgba(249,115,22,0.4); background: rgba(249,115,22,0.05); }
    .upload-drop input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; }
    .upload-drop-icon { font-size: 22px; margin-bottom: 4px; }
    .upload-drop-text { font-size: 12px; color: var(--text-secondary); }
    .upload-drop-text strong { color: var(--accent-video); }
    .preview-strip { display: none; margin-top: 10px; position: relative; }
    .preview-strip img { width: 100%; max-height: 140px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border-primary); }
    .preview-clear { position: absolute; top: 6px; right: 6px; width: 22px; height: 22px; border-radius: 50%; background: rgba(0,0,0,0.8); border: 1px solid var(--border-hover); color: var(--text-secondary); font-size: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.15s; }
    .preview-clear:hover { color: #fff; border-color: #fff; }

    .settings-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; margin-bottom: 20px; }
    @media (max-width: 680px) { .settings-grid { grid-template-columns: 1fr; } }
    .setting-label { font-family: var(--font-mono); font-size: 10px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-tertiary); margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
    .setting-label .hint { font-size: 9px; text-transform: none; letter-spacing: 0; color: var(--text-tertiary); opacity: 0.7; }
    .pill-group { display: flex; gap: 6px; }
    .pill { flex: 1; padding: 9px 6px; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px; color: var(--text-secondary); font-family: var(--font-mono); font-size: 12px; font-weight: 500; cursor: pointer; text-align: center; transition: all 0.15s var(--ease); position: relative; overflow: hidden; user-select: none; }
    .pill:hover { border-color: var(--border-hover); color: var(--text-primary); }
    .pill.active { background: rgba(249,115,22,0.1); border-color: rgba(249,115,22,0.45); color: var(--accent-video); box-shadow: 0 0 12px rgba(249,115,22,0.15); }
    .ratio-pill { display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 10px 4px; }
    .ratio-shape { background: currentColor; border-radius: 2px; opacity: 0.7; }
    .ratio-label { font-size: 11px; line-height: 1; }
    .ratio-sub { font-size: 9px; opacity: 0.6; }
    .dur-pill { flex-direction: column; display: flex; align-items: center; gap: 2px; padding: 8px 4px; }
    .dur-seconds { font-size: 14px; font-weight: 600; }
    .dur-frames { font-size: 9px; opacity: 0.55; }
    .styled-select { width: 100%; padding: 9px 12px; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px; color: var(--text-primary); font-family: var(--font-mono); font-size: 12px; appearance: none; cursor: pointer; outline: none; transition: border-color 0.2s; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' fill='none'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23666' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }
    .styled-select:focus { border-color: var(--border-glow); }
    .styled-select option { background: var(--bg-tertiary); }

    .generate-btn { width: 100%; padding: 18px 24px; background: linear-gradient(135deg, var(--accent-video) 0%, var(--accent-video-end) 100%); border: none; border-radius: 14px; color: #fff; font-family: var(--font-display); font-size: 22px; letter-spacing: 0.1em; cursor: pointer; transition: all 0.25s var(--ease); box-shadow: 0 6px 28px var(--glow-video); position: relative; overflow: hidden; }
    .generate-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 60%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent); transition: left 0.5s var(--ease); }
    .generate-btn:hover::before { left: 150%; }
    .generate-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 40px var(--glow-video); }
    .generate-btn:active { transform: translateY(-1px); }
    .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .generate-btn .btn-inner { display: flex; align-items: center; justify-content: center; gap: 12px; }
    .generate-btn .spinner { display: none; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .status-bar { margin-top: 14px; border: 1px solid var(--border-primary); border-radius: 12px; background: var(--bg-secondary); overflow: hidden; display: none; }
    .status-bar.visible { display: block; }
    .status-top { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--border-primary); }
    .status-title { font-family: var(--font-mono); font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-secondary); }
    .status-live { display: flex; align-items: center; gap: 5px; font-family: var(--font-mono); font-size: 10px; color: var(--accent-success); }
    .live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent-success); animation: pulse-glow 1.2s ease-in-out infinite; }
    .status-rows { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background: var(--border-primary); }
    .status-cell { background: var(--bg-card); padding: 12px 14px; text-align: center; }
    .cell-val { font-family: var(--font-display); font-size: 22px; letter-spacing: 0.05em; color: var(--accent-video); line-height: 1; margin-bottom: 4px; }
    .cell-key { font-family: var(--font-mono); font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-tertiary); }

    .step-track { padding: 14px; }
    .step-track-label { font-family: var(--font-mono); font-size: 10px; letter-spacing: 0.1em; color: var(--text-tertiary); text-transform: uppercase; margin-bottom: 10px; }
    .steps-list { display: flex; flex-direction: column; gap: 6px; }
    .step-row { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 7px; transition: all 0.3s var(--ease); }
    .step-row.pending { opacity: 0.35; }
    .step-row.active { background: rgba(249,115,22,0.08); border: 1px solid rgba(249,115,22,0.2); opacity: 1; }
    .step-row.done { opacity: 0.7; }
    .step-dot-wrap { width: 18px; height: 18px; border-radius: 50%; border: 1px solid var(--border-primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 9px; }
    .step-row.active .step-dot-wrap { border-color: var(--accent-video); background: rgba(249,115,22,0.15); box-shadow: 0 0 10px rgba(249,115,22,0.3); }
    .step-row.done .step-dot-wrap { border-color: var(--accent-success); background: rgba(16,185,129,0.1); color: var(--accent-success); }
    .step-text { font-family: var(--font-mono); font-size: 12px; color: var(--text-secondary); }
    .step-row.active .step-text { color: var(--text-primary); }
    .step-spinner { margin-left: auto; width: 12px; height: 12px; border: 1.5px solid rgba(249,115,22,0.3); border-top-color: var(--accent-video); border-radius: 50%; display: none; animation: spin 0.8s linear infinite; }
    .step-row.active .step-spinner { display: block; }

    .progress-wrap { padding: 0 14px 14px; }
    .progress-rail { height: 4px; background: var(--bg-lift); border-radius: 100px; overflow: hidden; border: 1px solid var(--border-primary); }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-video), var(--accent-video-end)); border-radius: 100px; width: 0%; transition: width 0.6s var(--ease); box-shadow: 0 0 10px var(--glow-video); }

    /* ‚îÄ‚îÄ Elapsed timer display ‚îÄ‚îÄ */
    .elapsed-display { padding: 0 14px 14px; text-align: center; font-family: var(--font-mono); font-size: 12px; color: var(--text-tertiary); }
    .elapsed-display .elapsed-val { color: var(--accent-video); font-size: 14px; font-weight: 500; }

    .output-area { margin-top: 20px; }
    .output-placeholder { padding: 60px 20px; text-align: center; }
    .placeholder-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.2; animation: float 4s ease-in-out infinite; }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    .placeholder-text { font-family: var(--font-mono); font-size: 12px; color: var(--text-tertiary); line-height: 1.6; }
    .output-video-wrap { display: none; padding: 16px; }
    .video-player-container { position: relative; background: #000; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-primary); }
    .video-player-container video { width: 100%; display: block; max-height: 340px; object-fit: contain; }
    .video-overlay-bar { position: absolute; top: 0; left: 0; right: 0; background: linear-gradient(180deg, rgba(0,0,0,0.6), transparent); padding: 10px 14px; display: flex; align-items: center; gap: 8px; }
    .video-badge { font-family: var(--font-mono); font-size: 10px; letter-spacing: 0.08em; padding: 3px 7px; border-radius: 4px; background: rgba(249,115,22,0.2); border: 1px solid rgba(249,115,22,0.4); color: var(--accent-video); }
    .video-actions { display: flex; gap: 8px; margin-top: 12px; }
    .video-btn { flex: 1; padding: 11px 12px; border-radius: 9px; font-family: var(--font-mono); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s var(--ease); text-align: center; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .video-btn-dl { background: linear-gradient(135deg, var(--accent-video), var(--accent-video-end)); border: none; color: #fff; box-shadow: 0 4px 16px var(--glow-video); }
    .video-btn-dl:hover { transform: translateY(-2px); box-shadow: 0 6px 24px var(--glow-video); }
    .video-btn-share { background: var(--bg-secondary); border: 1px solid var(--border-primary); color: var(--text-secondary); }
    .video-btn-share:hover { border-color: var(--border-hover); color: var(--text-primary); }
    .video-btn-regen { background: var(--bg-secondary); border: 1px solid var(--border-primary); color: var(--text-secondary); }
    .video-btn-regen:hover { border-color: rgba(249,115,22,0.4); color: var(--accent-video); }

    .sidebar { display: flex; flex-direction: column; gap: 16px; }
    .spec-list { padding: 4px 0; }
    .spec-row { display: flex; justify-content: space-between; align-items: center; padding: 9px 20px; border-bottom: 1px solid var(--border-primary); }
    .spec-row:last-child { border-bottom: none; }
    .spec-key { font-family: var(--font-mono); font-size: 11px; color: var(--text-tertiary); }
    .spec-val { font-family: var(--font-mono); font-size: 11px; font-weight: 500; color: var(--accent-video); }
    .tips-list { padding: 12px 20px; display: flex; flex-direction: column; gap: 8px; }
    .tip-item { display: flex; gap: 8px; font-size: 12px; color: var(--text-secondary); line-height: 1.5; }
    .tip-num { font-family: var(--font-mono); font-size: 10px; color: var(--accent-video); flex-shrink: 0; padding-top: 2px; }
    .history-scroll { max-height: 260px; overflow-y: auto; padding: 10px; }
    .history-scroll::-webkit-scrollbar { width: 3px; }
    .history-scroll::-webkit-scrollbar-track { background: transparent; }
    .history-scroll::-webkit-scrollbar-thumb { background: var(--border-primary); border-radius: 2px; }
    .history-item { display: flex; gap: 10px; align-items: center; padding: 9px 10px; border-radius: 8px; cursor: pointer; transition: background 0.15s; border: 1px solid transparent; }
    .history-item:hover { background: var(--bg-lift); border-color: var(--border-primary); }
    .hist-thumb { width: 44px; height: 34px; border-radius: 5px; background: linear-gradient(135deg, rgba(249,115,22,0.2), rgba(236,72,153,0.15)); border: 1px solid var(--border-primary); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .hist-info { flex: 1; min-width: 0; }
    .hist-prompt { font-size: 11px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
    .hist-meta { font-family: var(--font-mono); font-size: 10px; color: var(--text-tertiary); }
    .history-empty { padding: 24px; text-align: center; font-family: var(--font-mono); font-size: 11px; color: var(--text-tertiary); }
    .history-clear { font-family: var(--font-mono); font-size: 10px; color: var(--text-tertiary); cursor: pointer; background: none; border: none; transition: color 0.15s; }
    .history-clear:hover { color: var(--accent-video); }

    .toast { position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%) translateY(16px); background: var(--bg-card); border-radius: 10px; padding: 12px 22px; font-family: var(--font-mono); font-size: 12px; opacity: 0; pointer-events: none; transition: all 0.3s var(--ease); z-index: 9000; white-space: nowrap; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.success { border: 1px solid rgba(16,185,129,0.4); color: var(--accent-success); }
    .toast.error   { border: 1px solid rgba(239,68,68,0.4); color: #f87171; }
    .toast.info    { border: 1px solid rgba(249,115,22,0.4); color: var(--accent-video); }

    @media (max-width: 768px) { .page-hero { padding: 36px 20px 24px; } .main-layout { padding: 0 20px 60px; } .nav { padding: 0 20px; } .nav-status { display: none; } .settings-grid { grid-template-columns: 1fr 1fr; } .page-title { font-size: 52px; } }
    @media (max-width: 480px) { .settings-grid { grid-template-columns: 1fr; } .page-title { font-size: 42px; } .mode-selector { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<div class="scene-bg">
  <div class="scene-grid"></div>
  <div class="scene-radial"></div>
</div>

<div class="page-wrap">
  <header>
    <nav class="nav">
      <a href="index.html" class="nav-brand">
        <div class="brand-chip">T1</div>
        <span class="brand-name">T1ERA</span>
        <span class="brand-slash">/</span>
        <span class="brand-page">VIDEO GEN</span>
      </a>
      <div class="nav-status">
        <span class="status-pulse"></span>
        <span id="gpuStatus">A10 ¬∑ 11.8GB ¬∑ ONLINE</span>
      </div>
      <a href="index.html" class="nav-back">‚Üê Back to Home</a>
    </nav>
  </header>

  <div class="page-hero">
    <div class="hero-eyebrow">LTX-2 Distilled ¬∑ Q4_K_M ¬∑ Azure A10 GPU</div>
    <h1 class="page-title">MINATHOR<br/><span class="gradient-word">VIDEO AI</span></h1>
    <p class="page-sub">
      <span>Text-to-video</span> and <span>image-to-video</span> ‚Äî up to 1080p ¬∑ 24fps cinematic output.
      Describe your scene, configure, hit generate.
    </p>
  </div>

  <div class="main-layout">
    <div>
      <!-- Mode Selector -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <span class="card-label">Generation Mode</span>
          <span class="card-badge badge-orange" id="modeBadge">TEXT-TO-VIDEO</span>
        </div>
        <div class="card-body">
          <div class="mode-selector">
            <div class="mode-btn active" id="modeText" data-mode="text-to-video">
              <div class="mode-icon">üìù</div>
              <div class="mode-title">TEXT-TO-VIDEO</div>
              <div class="mode-desc">Generate from prompt only</div>
            </div>
            <div class="mode-btn" id="modeImage" data-mode="image-to-video">
              <div class="mode-icon">üñºÔ∏è</div>
              <div class="mode-title">IMAGE-TO-VIDEO</div>
              <div class="mode-desc">Animate a reference image</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Prompt Card -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <span class="card-label">Video Description</span>
          <span class="card-badge badge-orange">Prompt</span>
        </div>
        <div class="card-body">
          <div class="prompt-wrap">
            <textarea class="prompt-textarea" id="promptInput" maxlength="700"
              placeholder="Describe your video scene with rich detail‚Ä¶&#10;&#10;e.g. Cinematic aerial drone shot flying low over Kuala Lumpur at golden hour, KLCC towers gleaming, warm atmospheric haze, slow motion, 4K ultra-realistic, depth of field"
            ></textarea>
            <div class="prompt-footer">
              <span class="char-meter"><span class="count" id="charCount">0</span>/700</span>
              <span class="prompt-tips" onclick="scrollToTips()">See prompt tips ‚Üì</span>
            </div>
          </div>
          <div class="upload-section" id="uploadSection">
            <div class="upload-label">
              Reference Image
              <span class="optional" id="uploadOptional">(optional for text-to-video mode)</span>
              <span class="required" id="uploadRequired" style="display:none;">(required for image-to-video mode)</span>
            </div>
            <div class="upload-drop" id="uploadDrop">
              <input type="file" id="imageFile" accept="image/png,image/jpeg,image/webp" />
              <div class="upload-drop-icon">üñºÔ∏è</div>
              <div class="upload-drop-text">Drop image or <strong>click to upload</strong> &nbsp;¬∑&nbsp; PNG / JPG / WEBP &nbsp;¬∑&nbsp; max 10MB</div>
            </div>
            <div class="preview-strip" id="previewStrip">
              <img id="previewImg" src="" alt="Reference image" />
              <button class="preview-clear" id="clearImg" title="Remove image">√ó</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Card -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <span class="card-label">Generation Settings</span>
          <span class="card-badge badge-blue">Configure</span>
        </div>
        <div class="card-body">
          <div class="settings-grid">
            <!-- Aspect Ratio -->
            <div class="setting-block">
              <div class="setting-label">Aspect Ratio</div>
              <div class="pill-group" id="ratioGroup">
                <button class="pill ratio-pill" data-ratio="9:16">
                  <div class="ratio-shape" style="width:13px;height:21px;"></div>
                  <span class="ratio-label">9:16</span><span class="ratio-sub">TikTok</span>
                </button>
                <button class="pill ratio-pill" data-ratio="1:1">
                  <div class="ratio-shape" style="width:16px;height:16px;"></div>
                  <span class="ratio-label">1:1</span><span class="ratio-sub">Square</span>
                </button>
                <button class="pill ratio-pill active" data-ratio="16:9">
                  <div class="ratio-shape" style="width:21px;height:13px;"></div>
                  <span class="ratio-label">16:9</span><span class="ratio-sub">YouTube</span>
                </button>
              </div>
            </div>
            <!-- Duration -->
            <div class="setting-block">
              <div class="setting-label">Duration <span class="hint" id="fpsHint">√ó 24fps</span></div>
              <div class="pill-group" id="durGroup">
                <button class="pill dur-pill active" data-dur="6"><span class="dur-seconds">6s</span><span class="dur-frames">145f</span></button>
                <button class="pill dur-pill" data-dur="8"><span class="dur-seconds">8s</span><span class="dur-frames">193f</span></button>
                <button class="pill dur-pill" data-dur="10"><span class="dur-seconds">10s</span><span class="dur-frames">241f</span></button>
              </div>
            </div>
            <!-- Resolution -->
            <div class="setting-block">
              <div class="setting-label">Resolution <span class="hint">default: 480p</span></div>
              <select class="styled-select" id="resSelect">
                <option value="480p" selected>480p ‚Äî Standard</option>
                <option value="720p">720p ‚Äî HD ‚≠ê</option>
                <option value="1080p">1080p ‚Äî Full HD ‚≠ê</option>
              </select>
            </div>
          </div>

          <!-- GENERATE BUTTON -->
          <button class="generate-btn" id="generateBtn">
            <div class="btn-inner">
              <div class="spinner" id="btnSpinner"></div>
              <span id="btnLabel">GENERATE VIDEO</span>
            </div>
          </button>

          <!-- Status Bar -->
          <div class="status-bar" id="statusBar">
            <div class="status-top">
              <span class="status-title">Generation Pipeline</span>
              <span class="status-live"><span class="live-dot"></span> LIVE</span>
            </div>
            <div class="status-rows">
              <div class="status-cell"><div class="cell-val" id="statRes">‚Äî</div><div class="cell-key">Resolution</div></div>
              <div class="status-cell"><div class="cell-val" id="statElapsed">0s</div><div class="cell-key">Elapsed</div></div>
              <div class="status-cell"><div class="cell-val" id="statFrames">‚Äî</div><div class="cell-key">Frames</div></div>
            </div>
            <div class="step-track">
              <div class="step-track-label">Progress</div>
              <div class="steps-list">
                <div class="step-row pending" id="step-0"><div class="step-dot-wrap"><span class="step-icon">1</span></div><span class="step-text">Sending request to GPU</span><div class="step-spinner"></div></div>
                <div class="step-row pending" id="step-1"><div class="step-dot-wrap"><span class="step-icon">2</span></div><span class="step-text">Loading model into VRAM</span><div class="step-spinner"></div></div>
                <div class="step-row pending" id="step-2"><div class="step-dot-wrap"><span class="step-icon">3</span></div><span class="step-text">Denoising frames on A10</span><div class="step-spinner"></div></div>
                <div class="step-row pending" id="step-3"><div class="step-dot-wrap"><span class="step-icon">4</span></div><span class="step-text">VAE decode + encoding</span><div class="step-spinner"></div></div>
                <div class="step-row pending" id="step-4"><div class="step-dot-wrap"><span class="step-icon">5</span></div><span class="step-text">Delivering your video</span><div class="step-spinner"></div></div>
              </div>
            </div>
            <div class="progress-wrap">
              <div class="progress-rail"><div class="progress-fill" id="progressFill"></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Output Card -->
      <div class="card output-area" id="outputCard">
        <div class="card-header">
          <span class="card-label">Output</span>
          <span class="card-badge" id="outputBadge" style="background:rgba(255,255,255,0.04);border:1px solid var(--border-primary);color:var(--text-tertiary);">Waiting</span>
        </div>
        <div class="output-placeholder" id="outputPlaceholder">
          <div class="placeholder-icon">üé¨</div>
          <div class="placeholder-text">Your generated video will appear here.<br/>Generation takes 5‚Äì9 minutes on A10.</div>
        </div>
        <div class="output-video-wrap" id="outputVideoWrap">
          <div class="video-player-container">
            <video id="outputVideo" controls playsinline loop></video>
            <div class="video-overlay-bar">
              <span class="video-badge" id="videoBadgeRes">480p</span>
              <span class="video-badge" id="videoBadgeRatio">16:9</span>
              <span class="video-badge" id="videoBadgeDur">6s</span>
              <span class="video-badge" id="videoBadgeTime"></span>
            </div>
          </div>
          <div class="video-actions">
            <button class="video-btn video-btn-dl" id="downloadBtn">‚¨á Download MP4</button>
            <button class="video-btn video-btn-share" id="shareBtn">‚Üó Share</button>
            <button class="video-btn video-btn-regen" id="regenBtn">‚Ü∫ Regenerate</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="card">
        <div class="card-header"><span class="card-label">Live Spec</span><span class="card-badge badge-blue">Auto</span></div>
        <div class="spec-list">
          <div class="spec-row"><span class="spec-key">Mode</span>       <span class="spec-val" id="sMode">Text-to-Video</span></div>
          <div class="spec-row"><span class="spec-key">Model</span>      <span class="spec-val">LTX-2 Q4_K_M</span></div>
          <div class="spec-row"><span class="spec-key">Resolution</span> <span class="spec-val" id="sRes">832√ó480</span></div>
          <div class="spec-row"><span class="spec-key">Ratio</span>      <span class="spec-val" id="sRatio">16:9</span></div>
          <div class="spec-row"><span class="spec-key">Frames</span>     <span class="spec-val" id="sFrames">145f</span></div>
          <div class="spec-row"><span class="spec-key">Duration</span>   <span class="spec-val" id="sDur">6s @ 24fps</span></div>
          <div class="spec-row"><span class="spec-key">GPU</span>        <span class="spec-val">Azure A10</span></div>
          <div class="spec-row"><span class="spec-key">VRAM</span>       <span class="spec-val">11.8 GB</span></div>
          <div class="spec-row"><span class="spec-key">Quant</span>      <span class="spec-val">Q4_K_M</span></div>
        </div>
      </div>
      <div class="card" id="tipCard">
        <div class="card-header"><span class="card-label">Prompt Tips</span><span class="card-badge badge-orange">Guide</span></div>
        <div class="tips-list">
          <div class="tip-item"><span class="tip-num">01</span><span>Start with camera movement: "cinematic drone shot", "slow dolly zoom", "handheld tracking"</span></div>
          <div class="tip-item"><span class="tip-num">02</span><span>Describe lighting: "golden hour", "neon-lit rain", "dramatic overcast sky"</span></div>
          <div class="tip-item"><span class="tip-num">03</span><span>Add style keywords: "ultra-realistic 4K", "film grain", "shallow depth of field"</span></div>
          <div class="tip-item"><span class="tip-num">04</span><span>Name a subject first: "A tiger walking through a misty forest at dawn‚Ä¶"</span></div>
          <div class="tip-item"><span class="tip-num">05</span><span>Longer prompts (100‚Äì300 chars) yield better controlled outputs.</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-label">History</span><button class="history-clear" id="clearHistory">Clear all</button></div>
        <div class="history-scroll" id="historyList">
          <div class="history-empty" id="historyEmpty">No videos yet</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   T1ERA MINATHOR ‚Äî FIXED GENERATION FLOW
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

   BUGS FIXED vs old generate.html:

   Bug 2 (critical): Old code expected check_status_url ‚Üí started polling.
     Response from proxy-background.js has video_url DIRECTLY.
     New code: one await fetch() ‚Üí read data.video_url ‚Üí show video.
     NO POLLING. The background function holds the connection open for
     the full generation duration (~5‚Äì9 min) and returns when done.

   Bug 7 (cosmetic): VRAM shown as "24GB" ‚Üí fixed to "11.8 GB"

   Everything else is IDENTICAL to the original.
   All HTML, CSS, mode selector, pills, upload, history, toast ‚Üí unchanged.
*/

// ‚îÄ‚îÄ SELECTORS ‚îÄ‚îÄ
const promptInput     = document.getElementById('promptInput');
const charCount       = document.getElementById('charCount');
const generateBtn     = document.getElementById('generateBtn');
const btnLabel        = document.getElementById('btnLabel');
const btnSpinner      = document.getElementById('btnSpinner');
const statusBar       = document.getElementById('statusBar');
const progressFill    = document.getElementById('progressFill');
const outputPlaceholder = document.getElementById('outputPlaceholder');
const outputVideoWrap = document.getElementById('outputVideoWrap');
const outputVideo     = document.getElementById('outputVideo');
const downloadBtn     = document.getElementById('downloadBtn');
const shareBtn        = document.getElementById('shareBtn');
const regenBtn        = document.getElementById('regenBtn');
const outputBadge     = document.getElementById('outputBadge');
const videoBadgeRes   = document.getElementById('videoBadgeRes');
const videoBadgeRatio = document.getElementById('videoBadgeRatio');
const videoBadgeDur   = document.getElementById('videoBadgeDur');
const modeText        = document.getElementById('modeText');
const modeImage       = document.getElementById('modeImage');
const modeBadge       = document.getElementById('modeBadge');
const uploadOptional  = document.getElementById('uploadOptional');
const uploadRequired  = document.getElementById('uploadRequired');
const uploadDrop      = document.getElementById('uploadDrop');
const sMode           = document.getElementById('sMode');
const sRes            = document.getElementById('sRes');
const sRatio          = document.getElementById('sRatio');
const sFrames         = document.getElementById('sFrames');
const sDur            = document.getElementById('sDur');
const statQueue       = document.getElementById('statQueue');
const statEta         = document.getElementById('statEta');
const statFrames      = document.getElementById('statFrames');

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let currentFileBase64 = null;
let currentFileType   = null;
let isGenerating      = false;
let currentVideoUrl   = null;
let selectedMode      = 'text-to-video';
let selectedRatio     = '16:9';
let selectedDuration  = 6;
let selectedRes       = '480p';
let elapsedTimer      = null;
let elapsedSecs       = 0;
let genHistory        = [];

const RESOLUTION_DIMS = {
  "480p:16:9":"832√ó480", "480p:9:16":"480√ó832", "480p:1:1":"480√ó480",
  "720p:16:9":"1280√ó720","720p:9:16":"720√ó1280","720p:1:1":"720√ó720",
  "1080p:16:9":"1920√ó1080","1080p:9:16":"1080√ó1920","1080p:1:1":"1080√ó1080",
};

// ‚îÄ‚îÄ CHAR COUNTER ‚îÄ‚îÄ
promptInput.addEventListener('input', () => { charCount.textContent = promptInput.value.length; });

// ‚îÄ‚îÄ MODE SELECTOR ‚îÄ‚îÄ
modeText.addEventListener('click', () => {
  selectedMode = 'text-to-video';
  modeText.classList.add('active'); modeImage.classList.remove('active');
  modeBadge.textContent = 'TEXT-TO-VIDEO';
  uploadOptional.style.display = 'inline'; uploadRequired.style.display = 'none';
  uploadDrop.classList.remove('required');
  if (sMode) sMode.textContent = 'Text-to-Video';
});

modeImage.addEventListener('click', () => {
  selectedMode = 'image-to-video';
  modeImage.classList.add('active'); modeText.classList.remove('active');
  modeBadge.textContent = 'IMAGE-TO-VIDEO';
  uploadOptional.style.display = 'none'; uploadRequired.style.display = 'inline';
  uploadDrop.classList.add('required');
  if (sMode) sMode.textContent = 'Image-to-Video';
});

// ‚îÄ‚îÄ PILLS ‚îÄ‚îÄ
document.querySelectorAll('#ratioGroup .pill').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#ratioGroup .pill').forEach(b => b.classList.remove('active'));
    btn.classList.add('active'); selectedRatio = btn.dataset.ratio; updateSpecReadout();
  });
});
document.querySelectorAll('#durGroup .pill').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#durGroup .pill').forEach(b => b.classList.remove('active'));
    btn.classList.add('active'); selectedDuration = parseInt(btn.dataset.dur); updateSpecReadout();
  });
});
document.getElementById('resSelect').addEventListener('change', e => {
  selectedRes = e.target.value; updateSpecReadout();
});

function updateSpecReadout() {
  const key    = `${selectedRes}:${selectedRatio}`;
  const dims   = RESOLUTION_DIMS[key] || '832√ó480';
  const frames = (selectedDuration * 24) + 1;
  if (sRes)    sRes.textContent    = dims;
  if (sRatio)  sRatio.textContent  = selectedRatio;
  if (sFrames) sFrames.textContent = `${frames}f`;
  if (sDur)    sDur.textContent    = `${selectedDuration}s @ 24fps`;
  if (statFrames) statFrames.textContent = `${frames}f`;
}
updateSpecReadout();

// ‚îÄ‚îÄ IMAGE UPLOAD ‚îÄ‚îÄ
const imageFile    = document.getElementById('imageFile');
const previewStrip = document.getElementById('previewStrip');
const previewImg   = document.getElementById('previewImg');
const clearImg     = document.getElementById('clearImg');

imageFile.addEventListener('change', e => { if (e.target.files[0]) handleImageFile(e.target.files[0]); });
uploadDrop.addEventListener('dragover',  e => { e.preventDefault(); uploadDrop.classList.add('over'); });
uploadDrop.addEventListener('dragleave', () => uploadDrop.classList.remove('over'));
uploadDrop.addEventListener('drop', e => {
  e.preventDefault(); uploadDrop.classList.remove('over');
  if (e.dataTransfer.files[0]) handleImageFile(e.dataTransfer.files[0]);
});
clearImg.addEventListener('click', () => {
  currentFileBase64 = null; currentFileType = null;
  previewStrip.style.display = 'none'; previewImg.src = ''; imageFile.value = '';
});

function handleImageFile(file) {
  if (!file.type.startsWith('image/')) { showToast('Please upload an image file', 'error'); return; }
  if (file.size > 10 * 1024 * 1024)   { showToast('Image must be under 10MB', 'error'); return; }
  const reader = new FileReader();
  reader.onload = e => {
    const dataUrl = e.target.result;
    currentFileBase64 = dataUrl.split(',')[1];
    currentFileType   = file.type;
    previewImg.src    = dataUrl;
    previewStrip.style.display = 'block';
  };
  reader.readAsDataURL(file);
}

// ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ
generateBtn.addEventListener('click', startGeneration);
regenBtn && regenBtn.addEventListener('click', () => {
  outputVideoWrap.style.display = 'none';
  outputPlaceholder.style.display = 'block';
  startGeneration();
});
shareBtn && shareBtn.addEventListener('click', async () => {
  if (!currentVideoUrl) return;
  if (navigator.share) {
    try { await navigator.share({ title: 'T1ERA AI Video', url: currentVideoUrl }); } catch {}
  } else {
    navigator.clipboard.writeText(currentVideoUrl);
    showToast('Video URL copied', 'success');
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAIN GENERATION ‚Äî Bug 2 fix: single fetch, no polling
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startGeneration() {
  const prompt = promptInput.value.trim();
  if (!prompt) { showToast('Please enter a video description', 'error'); return; }
  if (selectedMode === 'image-to-video' && !currentFileBase64) {
    showToast('Upload a reference image for image-to-video mode', 'error'); return;
  }
  if (isGenerating) return;

  setLoading(true);
  setStep(0);
  startElapsedTimer();
  scheduleStepAnimations();

  // JSON payload ‚Äî matches proxy-background.js expectations exactly
  const payload = {
    prompt,
    resolution:   selectedRes,       // "480p" | "720p" | "1080p"
    aspect_ratio: selectedRatio,     // "16:9" | "9:16" | "1:1"
    duration:     selectedDuration,  // 6 | 8 | 10
    num_steps:    30,
    guidance:     7.5,
    seed:         -1,
    image_base64: currentFileBase64 || null,
    image_type:   currentFileType   || null,
  };

  try {
    showToast('Sending to GPU ‚Äî generation takes 5‚Äì9 minutes‚Ä¶', 'info');

    // ONE fetch call. proxy-background.js holds connection until done.
    // The await resolves with the completed video URL ‚Äî no polling needed.
    const response = await fetch('/.netlify/functions/proxy-background', {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify(payload),
    });

    const rawText = await response.text();
    let data;
    try   { data = JSON.parse(rawText); }
    catch { throw new Error(`Server returned non-JSON: ${rawText.slice(0, 200)}`); }

    if (!response.ok) {
      throw new Error(data.message || data.error || `Server error ${response.status}`);
    }

    // Bug 2 fix: video_url is in the direct response ‚Äî no check_status_url needed
    if (!data.video_url) {
      throw new Error('No video_url in response. Check Netlify function logs.');
    }

    finishGeneration(data.video_url, data.wangp_status, data.elapsed_sec);

  } catch (e) {
    console.error('[generate]', e);
    showToast('Error: ' + e.message, 'error');
    setLoading(false);
    stopElapsedTimer();
    clearScheduledSteps();
  }
}

// ‚îÄ‚îÄ Animate steps on a time estimate (local, no polling) ‚îÄ‚îÄ
let stepTimeouts = [];
function scheduleStepAnimations() {
  clearScheduledSteps();
  // Approximate timing: queuing‚Üí0s, model load‚Üí15s, denoising‚Üí60s, vae‚Üí4min
  const schedule = [0, 15000, 60000, 270000];
  schedule.forEach((delay, i) => {
    stepTimeouts.push(setTimeout(() => setStep(i), delay));
  });
  // Smooth progress 0‚Üí90% over 8 minutes
  const start = Date.now();
  const tick = () => {
    if (!isGenerating) return;
    progressFill.style.width = Math.min(90, Math.round(((Date.now()-start) / 480000) * 90)) + '%';
    window._pgRaf = requestAnimationFrame(tick);
  };
  window._pgRaf = requestAnimationFrame(tick);
}
function clearScheduledSteps() {
  stepTimeouts.forEach(clearTimeout); stepTimeouts = [];
  cancelAnimationFrame(window._pgRaf);
}

// ‚îÄ‚îÄ Elapsed timer ‚îÄ‚îÄ
function startElapsedTimer() {
  elapsedSecs = 0; clearInterval(elapsedTimer);
  elapsedTimer = setInterval(() => {
    elapsedSecs++;
    if (statEta)   statEta.textContent   = formatTime(Math.max(0, 480 - elapsedSecs));
    if (statQueue) statQueue.textContent = '1';
  }, 1000);
}
function stopElapsedTimer() { clearInterval(elapsedTimer); }
function formatTime(s) { return s < 60 ? `${s}s` : `${Math.floor(s/60)}m${String(s%60).padStart(2,'0')}s`; }

// ‚îÄ‚îÄ Finish ‚îÄ‚îÄ
function finishGeneration(videoUrl, wangpStatus, elapsedSec) {
  clearScheduledSteps();
  stopElapsedTimer();
  currentVideoUrl = videoUrl;

  progressFill.style.width = '100%';
  setStep(4);

  outputVideo.src = videoUrl;
  outputVideo.load();

  if (videoBadgeRes)   videoBadgeRes.textContent   = selectedRes;
  if (videoBadgeRatio) videoBadgeRatio.textContent  = selectedRatio;
  if (videoBadgeDur)   videoBadgeDur.textContent    = `${selectedDuration}s`;
  if (outputBadge) {
    outputBadge.textContent = 'Ready ‚úì';
    outputBadge.style.cssText = 'background:rgba(16,185,129,0.12);border:1px solid rgba(16,185,129,0.4);color:#10b981;';
  }
  if (downloadBtn) downloadBtn.onclick = () => {
    const a = document.createElement('a');
    a.href = videoUrl; a.download = `t1era_${Date.now()}.mp4`; a.click();
  };

  setTimeout(() => {
    setLoading(false);
    outputPlaceholder.style.display = 'none';
    outputVideoWrap.style.display   = 'block';
    const timeStr = wangpStatus || (elapsedSec ? formatTime(elapsedSec) : '');
    showToast(`Video ready! ${timeStr}`, 'success');
    addToHistory(promptInput.value.trim(), videoUrl);
  }, 600);
}

// ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ
function setLoading(active) {
  isGenerating = active;
  generateBtn.disabled        = active;
  btnSpinner.style.display    = active ? 'block' : 'none';
  btnLabel.textContent        = active ? 'GENERATING‚Ä¶' : 'GENERATE VIDEO';
  statusBar.classList.toggle('visible', active);
  if (!active) setTimeout(() => { progressFill.style.width = '0%'; }, 1000);
}

function setStep(activeIndex) {
  document.querySelectorAll('.step-row').forEach((row, i) => {
    row.classList.remove('pending','active','done');
    if      (i < activeIndex)  row.classList.add('done');
    else if (i === activeIndex) row.classList.add('active');
    else                        row.classList.add('pending');
  });
}

// ‚îÄ‚îÄ History ‚îÄ‚îÄ
function addToHistory(prompt, videoUrl) {
  genHistory.unshift({ prompt, videoUrl, ts: Date.now() });
  if (genHistory.length > 10) genHistory.pop();
  renderHistory();
}
function renderHistory() {
  const list  = document.getElementById('historyList');
  const empty = document.getElementById('historyEmpty');
  if (!list) return;
  if (genHistory.length === 0) { if (empty) empty.style.display = 'block'; return; }
  if (empty) empty.style.display = 'none';
  Array.from(list.children).forEach(c => { if (c.id !== 'historyEmpty') c.remove(); });
  genHistory.forEach(item => {
    const div = document.createElement('div');
    div.className = 'history-item';
    div.innerHTML = `<div class="hist-thumb">üé¨</div><div class="hist-info"><div class="hist-prompt">${item.prompt.slice(0,60)}‚Ä¶</div><div class="hist-meta">${new Date(item.ts).toLocaleTimeString()}</div></div>`;
    div.onclick = () => {
      outputVideo.src = item.videoUrl; outputVideo.load();
      outputPlaceholder.style.display = 'none'; outputVideoWrap.style.display = 'block';
    };
    list.appendChild(div);
  });
}
document.getElementById('clearHistory').addEventListener('click', () => {
  genHistory = []; renderHistory();
  document.getElementById('historyEmpty').style.display = 'block';
});

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
function showToast(msg, type = 'info') {
  document.querySelectorAll('.toast.show').forEach(t => t.remove());
  const t = document.createElement('div');
  t.className = `toast show ${type}`; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 5000);
}

function scrollToTips() {
  const el = document.getElementById('tipCard');
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
</script>

</body>
</html>
