<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>T1ERA — Sparks</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Orbitron:wght@400;500;600;700;800;900&family=Fira+Code:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1/src/index.js"></script>
    <style>
      /* ══════════════════════════════════════════
   ROOT — T1ERA design system
══════════════════════════════════════════ */
      :root {
        --bg: #000000;
        --bg-2: #090909;
        --bg-3: #111111;
        --bg-4: #181818;
        --bg-card: #141414;
        --border: rgba(255, 255, 255, 0.08);
        --border-2: rgba(255, 255, 255, 0.13);
        --text: #ffffff;
        --text-2: rgba(255, 255, 255, 0.65);
        --text-3: rgba(255, 255, 255, 0.35);
        --pink: #c2185b;
        --pink-2: #e91e8c;
        --pink-glow: rgba(194, 24, 91, 0.25);
        --purple: #8b5cf6;
        --purple-glow: rgba(139, 92, 246, 0.2);
        --green: #10b981;
        --orange: #f97316;
        --gold: #f59e0b;
        --red: #ef4444;
        --r-sm: 8px;
        --r: 14px;
        --r-lg: 20px;
        --f-display: "Orbitron", sans-serif;
        --f-body: "DM Sans", sans-serif;
        --f-mono: "Fira Code", monospace;
        --ease: cubic-bezier(0.4, 0, 0.2, 1);
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        font-family: var(--f-body);
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
        overflow-x: hidden;
      }
      ::-webkit-scrollbar {
        width: 4px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(194, 24, 91, 0.3);
        border-radius: 4px;
      }
      button {
        font-family: var(--f-body);
        cursor: pointer;
      }
      a {
        text-decoration: none;
        color: inherit;
      }

      /* ══════════════════════════════════════════
   TOPBAR
══════════════════════════════════════════ */
      .topbar {
        position: sticky;
        top: 0;
        z-index: 300;
        height: 52px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        background: rgba(0, 0, 0, 0.88);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border);
      }
      .topbar-logo {
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: var(--f-display);
        font-size: 13px;
        font-weight: 700;
        color: var(--text);
        letter-spacing: 0.06em;
      }
      .topbar-logo-mark {
        width: 28px;
        height: 28px;
        border-radius: 7px;
        background: linear-gradient(135deg, var(--pink), var(--purple));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 900;
        box-shadow: 0 0 12px var(--pink-glow);
      }
      .topbar-back {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 13px;
        color: var(--text-2);
        font-weight: 500;
        transition: color 0.2s;
      }
      .topbar-back:hover {
        color: var(--text);
      }
      .topbar-actions {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .tb-icon-btn {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: none;
        border: 1px solid var(--border);
        color: var(--text-3);
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.18s;
      }
      .tb-icon-btn:hover {
        background: var(--pink-glow);
        border-color: rgba(194, 24, 91, 0.3);
        color: var(--pink-2);
      }

      /* ══════════════════════════════════════════
   LAYOUT — mobile single column / PC 3-col
══════════════════════════════════════════ */
      .page-wrap {
        display: block;
        max-width: 680px;
        margin: 0 auto;
      }

      /* PC 3-column */
      @media (min-width: 1080px) {
        .page-wrap {
          display: grid;
          grid-template-columns: 240px 1fr 280px;
          max-width: 1200px;
          gap: 0;
          align-items: start;
          padding: 0 24px;
        }
      }

      /* ══════════════════════════════════════════
   LEFT SIDEBAR — desktop only
══════════════════════════════════════════ */
      .sidebar-left {
        display: none;
      }
      @media (min-width: 1080px) {
        .sidebar-left {
          display: block;
          position: sticky;
          top: 68px;
          padding: 20px 16px 20px 0;
        }
      }
      .snav {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .snav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 11px 14px;
        border-radius: var(--r);
        font-size: 14px;
        font-weight: 600;
        color: var(--text-2);
        transition: all 0.15s;
        border: 1px solid transparent;
      }
      .snav-item:hover {
        background: rgba(194, 24, 91, 0.07);
        color: var(--text);
        border-color: rgba(194, 24, 91, 0.12);
      }
      .snav-item.active {
        background: rgba(194, 24, 91, 0.1);
        color: var(--pink-2);
        border-color: rgba(194, 24, 91, 0.2);
      }
      .snav-item i {
        font-size: 20px;
        flex-shrink: 0;
      }
      .snav-post-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        margin-top: 14px;
        padding: 12px 20px;
        border-radius: 100px;
        background: linear-gradient(135deg, var(--pink), var(--pink-2));
        border: none;
        color: #fff;
        font-size: 13px;
        font-weight: 700;
        letter-spacing: 0.03em;
        box-shadow: 0 0 20px var(--pink-glow);
        transition: all 0.2s;
      }
      .snav-post-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 24px var(--pink-glow);
      }

      /* ══════════════════════════════════════════
   CENTER FEED
══════════════════════════════════════════ */
      .feed-col {
        width: 100%;
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
        min-height: 100vh;
      }

      /* ══════════════════════════════════════════
   RIGHT SIDEBAR — desktop only
══════════════════════════════════════════ */
      .sidebar-right {
        display: none;
      }
      @media (min-width: 1080px) {
        .sidebar-right {
          display: block;
          position: sticky;
          top: 68px;
          padding: 20px 0 20px 16px;
        }
      }
      .widget {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--r-lg);
        padding: 16px;
        margin-bottom: 18px;
      }
      .widget-title {
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-3);
        font-family: var(--f-mono);
        margin-bottom: 14px;
      }
      /* WTF row */
      .wtf-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
      }
      .wtf-row:last-child {
        border-bottom: none;
      }
      .wtf-av {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
        font-family: var(--f-display);
        color: #fff;
      }
      .wtf-info {
        flex: 1;
        min-width: 0;
      }
      .wtf-name {
        font-size: 12px;
        font-weight: 700;
        color: var(--text);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .wtf-sub {
        font-size: 10px;
        color: var(--text-3);
        font-family: var(--f-mono);
      }
      .wtf-btn {
        padding: 4px 12px;
        border-radius: 100px;
        font-size: 10px;
        font-weight: 700;
        border: 1px solid var(--pink-2);
        color: var(--pink-2);
        background: transparent;
        transition: all 0.15s;
        white-space: nowrap;
      }
      .wtf-btn:hover {
        background: var(--pink-2);
        color: #fff;
      }
      .wtf-btn.on {
        border-color: var(--border-2);
        color: var(--text-3);
        background: var(--bg-3);
      }
      /* Trending rows */
      .trd-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: background 0.15s;
        border-radius: var(--r-sm);
        padding-inline: 6px;
      }
      .trd-row:last-child {
        border-bottom: none;
      }
      .trd-row:hover {
        background: rgba(255, 255, 255, 0.03);
      }
      .trd-num {
        font-family: var(--f-display);
        font-size: 16px;
        font-weight: 900;
        color: var(--border-2);
        width: 22px;
        text-align: center;
        flex-shrink: 0;
      }
      .trd-num.hot {
        color: var(--orange);
      }
      .trd-tag {
        font-size: 13px;
        font-weight: 700;
        color: var(--text);
      }
      .trd-cnt {
        font-size: 10px;
        color: var(--text-3);
        font-family: var(--f-mono);
        margin-top: 1px;
      }

      /* ══════════════════════════════════════════
   TABS (sticky under topbar)
══════════════════════════════════════════ */
      .tabs-bar {
        position: sticky;
        top: 52px;
        z-index: 200;
        background: rgba(0, 0, 0, 0.92);
        backdrop-filter: blur(16px);
        border-bottom: 1px solid var(--border);
        display: flex;
      }
      .tab-btn {
        flex: 1;
        padding: 14px 6px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-3);
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.02em;
        font-family: var(--f-body);
        transition: all 0.18s;
        white-space: nowrap;
      }
      .tab-btn.active {
        color: var(--text);
        border-bottom-color: var(--pink-2);
      }
      .tab-btn:hover:not(.active) {
        color: var(--text-2);
      }
      .tab-panel {
        display: none;
      }
      .tab-panel.active {
        display: block;
      }

      /* ══════════════════════════════════════════
   CREATE SPARK — TOGGLE BAR
══════════════════════════════════════════ */
      .compose-toggle {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: background 0.15s;
      }
      .compose-toggle:hover {
        background: rgba(255, 255, 255, 0.015);
      }
      .compose-mini-av {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        flex-shrink: 0;
        background: linear-gradient(135deg, var(--pink), var(--purple));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 800;
        font-family: var(--f-display);
        color: #fff;
      }
      .compose-placeholder {
        flex: 1;
        font-size: 14px;
        color: var(--text-3);
        font-style: italic;
      }
      .compose-plus-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: var(--pink);
        border: none;
        color: #fff;
        font-size: 17px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 12px var(--pink-glow);
        transition:
          background 0.18s,
          transform 0.18s;
        flex-shrink: 0;
      }
      .compose-toggle:hover .compose-plus-btn {
        background: var(--pink-2);
        transform: rotate(45deg);
      }

      /* ══════════════════════════════════════════
   CREATE SPARK — EXPANDED BOX
══════════════════════════════════════════ */
      .compose-box {
        display: none;
        flex-direction: column;
        background: var(--bg-2);
        border-bottom: 2px solid rgba(194, 24, 91, 0.2);
      }
      .compose-box.open {
        display: flex;
      }

      .compose-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px 10px;
        border-bottom: 1px solid var(--border);
      }
      .compose-label {
        font-family: var(--f-display);
        font-size: 11px;
        font-weight: 700;
        color: var(--pink-2);
        letter-spacing: 0.1em;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .compose-label i {
        font-size: 14px;
      }
      .compose-close-btn {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background: var(--bg-3);
        border: 1px solid var(--border);
        color: var(--text-3);
        font-size: 13px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }
      .compose-close-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.25);
        color: rgba(239, 68, 68, 0.8);
      }

      .compose-body {
        display: flex;
        gap: 12px;
        padding: 14px 16px 8px;
        min-width: 0;
      }
      .compose-av {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        flex-shrink: 0;
        background: linear-gradient(135deg, var(--pink), var(--purple));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 800;
        font-family: var(--f-display);
        color: #fff;
        border: 2px solid rgba(194, 24, 91, 0.3);
      }
      .compose-textarea {
        flex: 1;
        background: none;
        border: none;
        outline: none;
        color: var(--text);
        font-family: var(--f-body);
        font-size: 15px;
        line-height: 1.65;
        resize: none;
        min-height: 90px;
        padding-top: 2px;
        width: 100%;
        min-width: 0;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: pre-wrap;
      }
      .compose-textarea::placeholder {
        color: var(--text-3);
      }

      /* Media preview */
      .media-strip {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 0 16px 10px 68px;
      }
      .media-thumb {
        position: relative;
        width: 80px;
        height: 80px;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid var(--border-2);
        background: var(--bg-3);
      }
      .media-thumb img,
      .media-thumb video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .media-thumb-remove {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.75);
        border: none;
        color: #fff;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.15s;
      }
      .media-thumb-remove:hover {
        background: rgba(239, 68, 68, 0.8);
      }
      .media-type-tag {
        position: absolute;
        bottom: 4px;
        left: 4px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 4px;
        padding: 1px 5px;
        font-size: 7px;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.75);
        font-family: var(--f-mono);
        text-transform: uppercase;
      }

      /* Footer bar */
      .compose-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px 14px;
        border-top: 1px solid var(--border);
        gap: 8px;
      }
      .media-btns {
        display: flex;
        align-items: center;
        gap: 2px;
      }
      .media-btn {
        position: relative;
        width: 34px;
        height: 34px;
        border-radius: var(--r-sm);
        background: none;
        border: 1px solid transparent;
        color: var(--text-3);
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        overflow: hidden;
      }
      .media-btn:hover {
        background: rgba(194, 24, 91, 0.1);
        border-color: rgba(194, 24, 91, 0.2);
        color: var(--pink-2);
      }
      .media-btn input[type="file"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
        font-size: 0;
      }
      .compose-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .char-count {
        font-size: 11px;
        color: var(--text-3);
        font-family: var(--f-mono);
      }
      .char-count.warn {
        color: var(--orange);
      }
      .char-count.over {
        color: rgba(239, 68, 68, 0.8);
      }
      .spark-submit-btn {
        padding: 8px 22px;
        border-radius: 100px;
        background: linear-gradient(135deg, var(--pink), var(--pink-2));
        border: none;
        color: #fff;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.04em;
        box-shadow: 0 0 16px var(--pink-glow);
        transition: all 0.2s;
      }
      .spark-submit-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 20px var(--pink-glow);
      }
      .spark-submit-btn:disabled {
        opacity: 0.35;
        cursor: not-allowed;
        transform: none;
      }

      /* ══════════════════════════════════════════
   SPARK CARD
══════════════════════════════════════════ */
      .spark-card {
        padding: 16px 16px 0;
        border-bottom: 1px solid var(--border);
        transition: background 0.15s;
        cursor: pointer;
      }
      .spark-card:hover {
        background: rgba(255, 255, 255, 0.012);
      }

      /* Repost header */
      .repost-bar {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: var(--text-3);
        font-weight: 600;
        margin-bottom: 8px;
        margin-left: 52px;
      }
      .repost-bar i {
        font-size: 13px;
        color: var(--green);
      }

      /* Card header */
      .card-head {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 8px;
      }
      /* Avatar stack */
      .av-wrap {
        position: relative;
        flex-shrink: 0;
      }
      .spark-av {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 800;
        font-family: var(--f-display);
        color: #fff;
        border: 2px solid var(--border-2);
        cursor: pointer;
        transition:
          border-color 0.18s,
          transform 0.18s;
        object-fit: cover;
      }
      .spark-av:hover {
        border-color: var(--pink-2);
        transform: scale(1.05);
      }
      .online-dot {
        position: absolute;
        bottom: 1px;
        right: 1px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--green);
        border: 2px solid var(--bg);
        box-shadow: 0 0 6px var(--green);
      }

      /* Meta */
      .card-meta {
        flex: 1;
        min-width: 0;
      }
      .meta-row-1 {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }
      .author-name {
        font-size: 11px;
        font-weight: 600;
        color: var(--text-2);
        cursor: pointer;
        transition: color 0.15s;
        white-space: nowrap;
      }
      .author-name:hover {
        color: var(--pink-2);
      }
      .author-handle {
        font-size: 11px;
        color: var(--text-3);
        font-family: var(--f-mono);
        white-space: nowrap;
      }
      .spark-time {
        font-size: 11px;
        color: var(--text-3);
        white-space: nowrap;
        margin-left: auto;
      }
      /* Follow inline */
      .follow-pill {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        padding: 2px 9px;
        border-radius: 100px;
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.03em;
        border: 1px solid var(--pink-2);
        color: var(--pink-2);
        background: transparent;
        transition: all 0.18s;
        white-space: nowrap;
      }
      .follow-pill:hover {
        background: var(--pink-2);
        color: #fff;
      }
      .follow-pill.on {
        border-color: var(--border-2);
        color: var(--text-3);
        background: var(--bg-3);
      }
      .follow-pill.on:hover {
        border-color: rgba(239, 68, 68, 0.35);
        color: rgba(239, 68, 68, 0.7);
        background: rgba(239, 68, 68, 0.05);
      }

      /* Badges row */
      .badges-row {
        display: flex;
        align-items: center;
        gap: 4px;
        flex-wrap: wrap;
        margin-top: 3px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        padding: 1px 7px;
        border-radius: 100px;
        font-size: 9px;
        font-weight: 700;
        letter-spacing: 0.07em;
        text-transform: uppercase;
        font-family: var(--f-mono);
      }
      .badge.rank {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.25);
        color: var(--gold);
      }
      .badge.verified {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.25);
        color: var(--green);
      }
      .badge.prompt-tag {
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.25);
        color: var(--purple);
      }
      .badge.hot {
        background: rgba(249, 115, 22, 0.1);
        border: 1px solid rgba(249, 115, 22, 0.25);
        color: var(--orange);
      }
      .badge.follow-badge {
        background: rgba(16, 185, 129, 0.08);
        border: 1px solid rgba(16, 185, 129, 0.28);
        color: var(--green);
        cursor: pointer;
        font-family: var(--f-mono);
        transition:
          background 0.18s,
          border-color 0.18s,
          color 0.18s;
      }
      .badge.follow-badge:hover {
        background: rgba(16, 185, 129, 0.2);
        border-color: rgba(16, 185, 129, 0.55);
        color: #fff;
      }
      .badge.follow-badge.following {
        background: rgba(16, 185, 129, 0.15);
        border-color: rgba(16, 185, 129, 0.45);
        color: var(--green);
      }
      .badge.follow-badge.following:hover {
        background: rgba(239, 68, 68, 0.08);
        border-color: rgba(239, 68, 68, 0.35);
        color: rgba(239, 68, 68, 0.75);
      }
      .badge.follow-badge.loading {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
      }
      .follow-pill.loading {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
      }
      @keyframes follow-pulse {
        0%,
        100% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
      }

      /* Dots menu */
      .dots-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: none;
        border: none;
        color: var(--text-3);
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        flex-shrink: 0;
      }
      .dots-btn:hover {
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
      }

      /* Content area */
      .card-content {
        margin-left: 54px;
        margin-bottom: 8px;
      }
      .spark-text {
        font-size: 14px;
        line-height: 1.68;
        color: #ffffff;
        word-break: break-word;
        white-space: pre-wrap;
      }
      .spark-text .ht {
        color: var(--pink-2);
        cursor: pointer;
      }
      .spark-text .ht:hover {
        text-decoration: underline;
      }
      .spark-text .mn {
        color: var(--purple);
        cursor: pointer;
      }

      /* Media grid */
      .media-grid {
        margin-top: 10px;
        border-radius: var(--r);
        overflow: hidden;
        display: grid;
        gap: 2px;
      }
      .media-grid.g1 {
        grid-template-columns: 1fr;
      }
      .media-grid.g2 {
        grid-template-columns: 1fr 1fr;
      }
      .media-grid.g3 {
        grid-template-columns: 1fr 1fr;
      }
      .media-grid.g3 .mi:first-child {
        grid-row: span 2;
      }
      .media-grid.g4 {
        grid-template-columns: 1fr 1fr;
      }
      .mi {
        position: relative;
        overflow: hidden;
        background: var(--bg-3);
        cursor: pointer;
      }
      .media-grid.g1 .mi {
        height: 260px;
        border-radius: var(--r);
      }
      .media-grid.g2 .mi {
        height: 170px;
      }
      .media-grid.g3 .mi {
        height: 112px;
      }
      .media-grid.g3 .mi:first-child {
        height: 226px;
      }
      .media-grid.g4 .mi {
        height: 130px;
      }
      .mi img,
      .mi video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
      }
      .mi:hover img,
      .mi:hover video {
        transform: scale(1.04);
      }
      .mi-play {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.3);
      }
      .mi-play i {
        font-size: 38px;
        color: rgba(255, 255, 255, 0.9);
      }

      /* Prompt card */
      .prompt-card {
        margin-top: 10px;
        padding: 14px;
        background: linear-gradient(
          135deg,
          rgba(139, 92, 246, 0.07),
          rgba(194, 24, 91, 0.05)
        );
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: var(--r);
      }
      .prompt-label {
        font-size: 9px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--purple);
        font-family: var(--f-mono);
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 8px;
      }
      .prompt-q {
        font-size: 14px;
        font-weight: 600;
        color: var(--text);
        line-height: 1.5;
      }
      .prompt-replies {
        font-size: 11px;
        color: var(--text-3);
        margin-top: 8px;
        font-family: var(--f-mono);
      }

      /* Trending badge */
      .trending-pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 9px;
        border-radius: 100px;
        font-size: 9px;
        font-weight: 700;
        letter-spacing: 0.07em;
        text-transform: uppercase;
        font-family: var(--f-mono);
        background: rgba(249, 115, 22, 0.1);
        border: 1px solid rgba(249, 115, 22, 0.25);
        color: var(--orange);
        margin-bottom: 8px;
      }

      /* ── ACTION BAR ── */
      .action-bar {
        display: flex;
        align-items: center;
        margin-left: 54px;
        padding: 8px 0 12px;
        gap: 2px;
      }
      .act-btn {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px 9px;
        border-radius: var(--r-sm);
        background: none;
        border: none;
        color: var(--text-3);
        font-size: 12px;
        font-weight: 500;
        transition: all 0.15s;
      }
      .act-btn i {
        font-size: 17px;
      }
      .act-btn:hover {
        background: rgba(255, 255, 255, 0.04);
      }
      .act-btn.like:hover,
      .act-btn.liked {
        color: rgba(239, 68, 68, 0.8);
      }
      .act-btn.like:hover {
        background: rgba(239, 68, 68, 0.06);
      }
      .act-btn.liked {
        background: rgba(239, 68, 68, 0.05);
      }
      .act-btn.reply:hover {
        color: var(--purple);
        background: var(--purple-glow);
      }
      .act-btn.repost:hover,
      .act-btn.reposted {
        color: var(--green);
      }
      .act-btn.repost:hover {
        background: rgba(16, 185, 129, 0.08);
      }
      .act-btn.reposted {
        background: rgba(16, 185, 129, 0.05);
      }
      .act-btn.share:hover {
        color: var(--pink-2);
        background: var(--pink-glow);
      }
      .act-btn.bookmark:hover {
        color: var(--gold);
        background: rgba(245, 158, 11, 0.07);
      }

      /* ══════════════════════════════════════════
   TRENDING TAB HEADER
══════════════════════════════════════════ */
      .trend-header {
        padding: 16px 16px 12px;
        border-bottom: 1px solid var(--border);
      }
      .trend-header-label {
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-3);
        font-family: var(--f-mono);
        margin-bottom: 12px;
      }
      .trend-topic {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 8px;
        border-radius: var(--r-sm);
        cursor: pointer;
        transition: background 0.15s;
        border-bottom: 1px solid var(--border);
      }
      .trend-topic:last-child {
        border-bottom: none;
      }
      .trend-topic:hover {
        background: rgba(255, 255, 255, 0.025);
      }
      .trend-n {
        font-family: var(--f-display);
        font-size: 20px;
        font-weight: 900;
        color: var(--border-2);
        width: 32px;
        text-align: center;
        flex-shrink: 0;
      }
      .trend-n.hot {
        color: var(--orange);
      }
      .trend-info {
        flex: 1;
      }
      .trend-tag {
        font-size: 14px;
        font-weight: 700;
        color: var(--text);
      }
      .trend-count {
        font-size: 11px;
        color: var(--text-3);
        font-family: var(--f-mono);
        margin-top: 1px;
      }
      .trend-icon {
        font-size: 18px;
      }

      /* ══════════════════════════════════════════
   PROFILE POPUP — bottom sheet
══════════════════════════════════════════ */
      .popup-overlay {
        position: fixed;
        inset: 0;
        z-index: 500;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.25s,
          visibility 0.25s;
      }
      .popup-overlay.open {
        opacity: 1;
        visibility: visible;
      }
      .popup-sheet {
        width: 100%;
        max-width: 480px;
        background: rgba(9, 6, 13, 0.98);
        border: 1px solid rgba(194, 24, 91, 0.15);
        border-radius: 24px 24px 0 0;
        padding-bottom: 40px;
        transform: translateY(28px);
        transition: transform 0.3s cubic-bezier(0.34, 1.2, 0.64, 1);
      }
      .popup-overlay.open .popup-sheet {
        transform: translateY(0);
      }
      .popup-handle {
        width: 36px;
        height: 4px;
        border-radius: 2px;
        background: var(--border-2);
        margin: 12px auto 0;
      }
      .popup-banner {
        height: 88px;
        margin-top: 8px;
        background: linear-gradient(
          135deg,
          rgba(194, 24, 91, 0.35),
          rgba(139, 92, 246, 0.25)
        );
        position: relative;
      }
      .popup-av {
        position: absolute;
        bottom: -24px;
        left: 20px;
        width: 54px;
        height: 54px;
        border-radius: 50%;
        border: 3px solid rgba(9, 6, 13, 0.98);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: 800;
        font-family: var(--f-display);
        color: #fff;
      }
      .popup-follow-btn {
        position: absolute;
        bottom: -20px;
        right: 20px;
        padding: 7px 18px;
        border-radius: 100px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.04em;
        border: 1px solid var(--pink-2);
        color: var(--pink-2);
        background: transparent;
        transition: all 0.18s;
      }
      .popup-follow-btn:hover {
        background: var(--pink-2);
        color: #fff;
      }
      .popup-follow-btn.on {
        border-color: var(--border-2);
        color: var(--text-3);
        background: var(--bg-3);
      }
      .popup-info {
        padding: 34px 20px 16px;
      }
      .popup-name {
        font-size: 17px;
        font-weight: 700;
        color: var(--text);
      }
      .popup-handle-text {
        font-size: 12px;
        color: var(--text-3);
        font-family: var(--f-mono);
        margin-top: 2px;
      }
      .popup-bio-text {
        font-size: 13px;
        color: var(--text-2);
        line-height: 1.55;
        margin-top: 8px;
      }
      .popup-stats {
        display: flex;
        gap: 22px;
        margin-top: 12px;
      }
      .pstat-num {
        font-size: 15px;
        font-weight: 700;
        color: var(--text);
      }
      .pstat-label {
        font-size: 10px;
        color: var(--text-3);
        font-family: var(--f-mono);
        margin-top: 1px;
      }
      .popup-actions {
        display: flex;
        gap: 8px;
        padding: 0 20px 4px;
      }
      .popup-act-btn {
        flex: 1;
        padding: 9px;
        border-radius: var(--r-sm);
        background: var(--bg-3);
        border: 1px solid var(--border);
        color: var(--text-2);
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.18s;
      }
      .popup-act-btn i {
        font-size: 15px;
      }
      .popup-act-btn:hover {
        background: var(--pink-glow);
        border-color: rgba(194, 24, 91, 0.25);
        color: var(--pink-2);
      }

      @media (min-width: 1080px) {
        .popup-overlay {
          align-items: center;
        }
        .popup-sheet {
          border-radius: 20px;
          max-width: 400px;
        }
      }

      /* ══════════════════════════════════════════
   REPLY MODAL
══════════════════════════════════════════ */
      .reply-overlay {
        position: fixed;
        inset: 0;
        z-index: 510;
        background: rgba(0, 0, 0, 0.82);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.25s,
          visibility 0.25s;
      }
      .reply-overlay.open {
        opacity: 1;
        visibility: visible;
      }
      .reply-sheet {
        width: 100%;
        max-width: 520px;
        background: rgba(9, 6, 13, 0.99);
        border: 1px solid rgba(194, 24, 91, 0.15);
        border-radius: 24px 24px 0 0;
        max-height: 82vh;
        overflow-y: auto;
        transform: translateY(28px);
        transition: transform 0.3s cubic-bezier(0.34, 1.2, 0.64, 1);
      }
      .reply-overlay.open .reply-sheet {
        transform: translateY(0);
      }
      .reply-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px 10px;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        background: rgba(9, 6, 13, 0.99);
        z-index: 2;
        border-radius: 24px 24px 0 0;
      }
      .reply-title {
        font-family: var(--f-display);
        font-size: 11px;
        font-weight: 700;
        color: var(--pink-2);
        letter-spacing: 0.08em;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .reply-close {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background: var(--bg-3);
        border: 1px solid var(--border);
        color: var(--text-3);
        font-size: 13px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }
      .reply-close:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.25);
        color: rgba(239, 68, 68, 0.8);
      }

      /* Original spark preview */
      .reply-orig {
        opacity: 1;
        margin: 12px 16px 0;
        padding: 12px 14px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: var(--r);
      }
      .reply-orig-head {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
      }
      .reply-orig-av {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 800;
        font-family: var(--f-display);
        color: #fff;
        overflow: hidden;
      }
      .reply-orig-av img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        display: block;
      }
      .reply-orig-author {
        font-size: 13px;
        font-weight: 700;
        color: var(--text);
      }
      .reply-orig-tag {
        font-size: 11px;
        color: var(--text-3);
        font-family: var(--f-mono);
      }
      .reply-orig-text {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.82);
        line-height: 1.55;
        margin-left: 36px;
        margin-top: 2px;
      }

      /* Compose area */
      .reply-compose {
        display: flex;
        gap: 12px;
        padding: 14px 16px;
      }
      .reply-av {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        flex-shrink: 0;
        background: linear-gradient(135deg, var(--pink), var(--purple));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 800;
        font-family: var(--f-display);
        color: #fff;
      }
      .reply-textarea {
        flex: 1;
        background: none;
        border: none;
        outline: none;
        color: var(--text);
        font-family: var(--f-body);
        font-size: 14px;
        line-height: 1.65;
        resize: none;
        min-height: 80px;
      }
      .reply-textarea::placeholder {
        color: var(--text-3);
      }
      .reply-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px 14px;
        border-top: 1px solid var(--border);
      }
      .reply-media-row {
        display: flex;
        gap: 4px;
      }
      .reply-submit {
        padding: 8px 22px;
        border-radius: 100px;
        background: linear-gradient(135deg, var(--pink), var(--pink-2));
        border: none;
        color: #fff;
        font-size: 12px;
        font-weight: 700;
        box-shadow: 0 0 12px var(--pink-glow);
        transition: all 0.18s;
      }
      .reply-submit:hover {
        transform: translateY(-1px);
      }

      /* Existing replies */
      .replies-list {
        padding: 0 16px 4px;
      }
      .reply-item {
        display: flex;
        gap: 10px;
        padding: 12px 0;
        border-bottom: 1px solid var(--border);
      }
      .reply-item:last-child {
        border-bottom: none;
      }
      .ri-av {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 800;
        font-family: var(--f-display);
        color: #fff;
      }
      .ri-body {
        flex: 1;
      }
      .ri-author {
        font-size: 13px;
        font-weight: 700;
        color: var(--text);
      }
      .ri-time {
        font-size: 10px;
        color: var(--text-3);
        font-family: var(--f-mono);
        margin-left: 6px;
      }
      .ri-text {
        font-size: 13px;
        color: var(--text-2);
        line-height: 1.55;
        margin-top: 3px;
      }

      @media (min-width: 1080px) {
        .reply-overlay {
          align-items: center;
        }
        .reply-sheet {
          border-radius: 20px;
          max-width: 540px;
        }
      }

      /* ══════════════════════════════════════════
   MOBILE BOTTOM NAV
══════════════════════════════════════════ */
      .mob-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        z-index: 250;
        background: rgba(0, 0, 0, 0.92);
        backdrop-filter: blur(20px);
        border-top: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-around;
      }
      @media (min-width: 1080px) {
        .mob-nav {
          display: none;
        }
      }
      .mob-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        color: var(--text-3);
        font-size: 10px;
        font-family: var(--f-body);
        padding: 6px 12px;
        border-radius: var(--r-sm);
        background: none;
        border: none;
        transition: color 0.15s;
      }
      .mob-btn i {
        font-size: 22px;
      }
      .mob-btn.active {
        color: var(--pink-2);
      }
      .mob-btn:hover {
        color: var(--text);
      }
      .mob-post {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--pink), var(--pink-2));
        border: none;
        color: #fff;
        font-size: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 16px var(--pink-glow);
        transition:
          transform 0.18s,
          box-shadow 0.18s;
      }
      .mob-post:hover {
        transform: scale(1.1);
      }

      /* ══════════════════════════════════════════
   EMPTY STATE
══════════════════════════════════════════ */
      .empty-state {
        padding: 64px 20px;
        text-align: center;
      }
      .empty-state i {
        font-size: 44px;
        color: var(--border-2);
        display: block;
        margin-bottom: 14px;
      }
      .empty-title {
        font-size: 15px;
        font-weight: 700;
        color: var(--text-2);
        margin-bottom: 6px;
      }
      .empty-sub {
        font-size: 13px;
        color: var(--text-3);
        line-height: 1.6;
      }

      /* ══════════════════════════════════════════
   FADE IN
══════════════════════════════════════════ */

      /* ══════════════════════════════════════════
   SKELETON LOADER
══════════════════════════════════════════ */
      .skeleton-card {
        padding: 16px 16px 12px;
        border-bottom: 1px solid var(--border);
      }
      .skeleton-head {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 12px;
      }
      .skeleton-av {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        flex-shrink: 0;
        background: var(--bg-4);
        overflow: hidden;
        position: relative;
      }
      .skeleton-meta {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding-top: 4px;
      }
      .skeleton-line {
        height: 10px;
        border-radius: 6px;
        background: var(--bg-4);
        overflow: hidden;
        position: relative;
      }
      .skeleton-line.w60 {
        width: 60%;
      }
      .skeleton-line.w40 {
        width: 40%;
      }
      .skeleton-line.w90 {
        width: 90%;
        height: 12px;
        margin-left: 54px;
      }
      .skeleton-line.w75 {
        width: 75%;
        height: 12px;
        margin-left: 54px;
        margin-top: 6px;
      }
      .skeleton-actions {
        display: flex;
        gap: 18px;
        margin-left: 54px;
        margin-top: 14px;
      }
      .skeleton-act {
        width: 40px;
        height: 10px;
        border-radius: 6px;
        background: var(--bg-4);
        overflow: hidden;
        position: relative;
      }
      .skeleton-av::after,
      .skeleton-line::after,
      .skeleton-act::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(255, 255, 255, 0.06) 50%,
          transparent 100%
        );
        animation: shimmer 1.4s infinite;
      }
      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      /* ══════════════════════════════════════════
   FEED MINI HEADER
══════════════════════════════════════════ */
      .feed-mini-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px;
        border-bottom: 1px solid var(--border);
        background: var(--bg-2);
        position: sticky;
        top: 52px;
        z-index: 100;
        backdrop-filter: blur(12px);
      }
      .feed-mini-title {
        font-family: var(--f-display);
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.12em;
        color: var(--text-2);
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 7px;
      }
      .feed-mini-title i {
        color: var(--pink);
        font-size: 13px;
      }
      .feed-refresh-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-3);
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
      }
      .feed-refresh-btn:hover {
        background: rgba(194, 24, 91, 0.12);
        border-color: rgba(194, 24, 91, 0.4);
        color: var(--pink);
      }
      .feed-refresh-btn.spinning i {
        animation: spin 0.6s linear;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* ══════════════════════════════════════════
   NOTIFICATION BELL + PANEL
══════════════════════════════════════════ */
      .bell-wrap {
        position: relative;
        display: inline-flex;
      }
      .notif-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        min-width: 17px;
        height: 17px;
        border-radius: 100px;
        background: var(--red);
        color: #fff;
        font-size: 9px;
        font-weight: 700;
        font-family: var(--f-display);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 4px;
        border: 2px solid var(--bg);
        opacity: 0;
        transform: scale(0.6);
        transition:
          opacity 0.2s,
          transform 0.2s;
        pointer-events: none;
      }
      .notif-badge.visible {
        opacity: 1;
        transform: scale(1);
      }

      /* panel */
      .notif-panel {
        position: fixed;
        top: 52px;
        right: 0;
        width: 380px;
        max-width: 100vw;
        height: calc(100vh - 52px);
        background: var(--bg-2);
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        transition: transform 0.28s var(--ease);
        z-index: 400;
        overflow: hidden;
      }
      .notif-panel.open {
        transform: translateX(0);
      }
      .notif-backdrop {
        position: fixed;
        inset: 0;
        z-index: 399;
        background: rgba(0, 0, 0, 0.45);
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.28s,
          visibility 0.28s;
      }
      .notif-backdrop.open {
        opacity: 1;
        visibility: visible;
      }

      /* panel header */
      .notif-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 18px;
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
      }
      .notif-title {
        font-family: var(--f-display);
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.12em;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .notif-title i {
        color: var(--pink);
        font-size: 14px;
      }
      .notif-mark-all {
        font-size: 11px;
        color: var(--text-3);
        background: none;
        border: none;
        cursor: pointer;
        font-family: var(--f-body);
        transition: color 0.15s;
      }
      .notif-mark-all:hover {
        color: var(--pink-2);
      }

      /* scrollable list */
      .notif-list {
        flex: 1;
        overflow-y: auto;
        padding-bottom: 24px;
      }
      .notif-list::-webkit-scrollbar {
        width: 3px;
      }
      .notif-list::-webkit-scrollbar-thumb {
        background: rgba(194, 24, 91, 0.25);
        border-radius: 3px;
      }

      /* section accordion */
      .notif-section-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 18px 8px;
        cursor: pointer;
        user-select: none;
        transition: background 0.15s;
        position: relative;
      }
      .notif-section-header:hover {
        background: rgba(255, 255, 255, 0.02);
      }
      .notif-section-header.has-unread .notif-section-label {
        color: var(--pink-2);
      }
      .notif-section-header.has-unread .notif-section-dot {
        display: block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--pink);
        flex-shrink: 0;
      }
      .notif-section-dot {
        display: none;
      }
      .notif-section-label {
        font-size: 9px;
        font-weight: 700;
        letter-spacing: 0.12em;
        color: var(--text-3);
        font-family: var(--f-display);
        text-transform: uppercase;
        white-space: nowrap;
        flex: 1;
      }
      .notif-section-count {
        font-size: 9px;
        font-family: var(--f-mono);
        color: var(--text-3);
        margin-right: 4px;
      }
      .notif-section-count.has-new {
        color: var(--pink-2);
        font-weight: 700;
      }
      .notif-section-chevron {
        font-size: 11px;
        color: var(--text-3);
        transition: transform 0.22s var(--ease);
        flex-shrink: 0;
      }
      .notif-section-body {
        overflow: hidden;
        max-height: 0;
        transition: max-height 0.3s var(--ease);
      }
      .notif-section-body.open {
        max-height: 2000px;
      }

      /* individual notification row */
      .notif-row {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 10px 18px;
        cursor: pointer;
        transition: background 0.15s;
        position: relative;
      }
      .notif-row:hover {
        background: rgba(255, 255, 255, 0.03);
      }
      .notif-row.unread {
        background: rgba(194, 24, 91, 0.04);
      }
      .notif-row.unread::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: var(--pink);
        border-radius: 0 2px 2px 0;
      }
      .notif-av {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        flex-shrink: 0;
        background: linear-gradient(135deg, var(--pink), var(--purple));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 700;
        color: #fff;
        font-family: var(--f-display);
        overflow: hidden;
      }
      .notif-av img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
      }
      .notif-body {
        flex: 1;
        min-width: 0;
      }
      .notif-text {
        font-size: 12.5px;
        color: var(--text-2);
        line-height: 1.5;
      }
      .notif-text strong {
        color: var(--text);
        font-weight: 600;
      }
      .notif-sub {
        font-size: 11px;
        color: var(--text-3);
        margin-top: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .notif-time {
        font-size: 10px;
        color: var(--text-3);
        font-family: var(--f-mono);
        margin-top: 3px;
      }
      .notif-type-icon {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        flex-shrink: 0;
        margin-top: 4px;
      }
      .notif-type-icon.like {
        background: rgba(239, 68, 68, 0.12);
        color: #ef4444;
      }
      .notif-type-icon.bookmark {
        background: rgba(245, 158, 11, 0.12);
        color: var(--gold);
      }
      .notif-type-icon.reply {
        background: rgba(139, 92, 246, 0.12);
        color: var(--purple);
      }
      .notif-type-icon.follow {
        background: rgba(16, 185, 129, 0.12);
        color: var(--green);
      }
      .notif-type-icon.message {
        background: rgba(194, 24, 91, 0.12);
        color: var(--pink);
      }

      /* reply button inside notification row */
      .notif-reply-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        margin-top: 6px;
        padding: 4px 11px;
        border-radius: 100px;
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.03em;
        border: 1px solid rgba(139, 92, 246, 0.35);
        color: var(--purple);
        background: rgba(139, 92, 246, 0.07);
        cursor: pointer;
        font-family: var(--f-body);
        transition: all 0.15s;
      }
      .notif-reply-btn:hover {
        background: rgba(139, 92, 246, 0.18);
        border-color: var(--purple);
      }

      /* reply button on each reply item inside reply sheet */
      .ri-reply-btn {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        margin-top: 5px;
        padding: 3px 9px;
        border-radius: 100px;
        font-size: 10px;
        font-weight: 700;
        border: 1px solid var(--border-2);
        color: var(--text-3);
        background: none;
        cursor: pointer;
        font-family: var(--f-body);
        transition: all 0.15s;
      }
      .ri-reply-btn:hover {
        border-color: rgba(139, 92, 246, 0.4);
        color: var(--purple);
        background: rgba(139, 92, 246, 0.07);
      }

      /* placeholder */
      .notif-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 18px 24px;
        gap: 6px;
      }
      .notif-placeholder i {
        font-size: 22px;
        color: var(--text-3);
        opacity: 0.4;
      }
      .notif-placeholder span {
        font-size: 11px;
        color: var(--text-3);
      }

      /* empty state */
      .notif-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        gap: 10px;
      }
      .notif-empty i {
        font-size: 36px;
        color: var(--text-3);
        opacity: 0.3;
      }
      .notif-empty p {
        font-size: 13px;
        color: var(--text-3);
        text-align: center;
      }

      /* ══════════════════════════════════════════
   SETTINGS PANEL
══════════════════════════════════════════ */
      .settings-panel {
        position: fixed;
        top: 52px;
        right: 0;
        width: 340px;
        max-width: 100vw;
        height: calc(100vh - 52px);
        background: var(--bg-2);
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        transition: transform 0.28s var(--ease);
        z-index: 398;
        overflow: hidden;
      }
      .settings-panel.open {
        transform: translateX(0);
      }
      .settings-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 18px;
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
      }
      .settings-title {
        font-family: var(--f-display);
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.12em;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .settings-title i {
        color: var(--purple);
        font-size: 14px;
      }
      .settings-close {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: none;
        border: 1px solid var(--border);
        color: var(--text-3);
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }
      .settings-close:hover {
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
      }
      .settings-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px 18px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .settings-section-label {
        font-size: 9px;
        font-weight: 700;
        letter-spacing: 0.12em;
        color: var(--text-3);
        font-family: var(--f-display);
        text-transform: uppercase;
        margin-bottom: 8px;
      }
      .settings-placeholder {
        background: var(--bg-3);
        border: 1px solid var(--border);
        border-radius: var(--r);
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        text-align: center;
      }
      .settings-placeholder i {
        font-size: 24px;
        color: var(--text-3);
        opacity: 0.35;
      }
      .settings-placeholder span {
        font-size: 12px;
        color: var(--text-3);
      }

      /* mobile-only bell wrap — badge support */
      .mob-bell-wrap {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .mob-notif-badge {
        position: absolute;
        top: 0px;
        right: 0px;
        min-width: 15px;
        height: 15px;
        border-radius: 100px;
        background: var(--red);
        color: #fff;
        font-size: 8px;
        font-weight: 700;
        font-family: var(--f-display);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 3px;
        border: 2px solid var(--bg);
        opacity: 0;
        transform: scale(0.6);
        transition:
          opacity 0.2s,
          transform 0.2s;
        pointer-events: none;
      }
      .mob-notif-badge.visible {
        opacity: 1;
        transform: scale(1);
      }

      /* hide settings icon on mobile, show on desktop */
      .tb-settings-btn {
        display: none;
      }
      @media (min-width: 1080px) {
        .tb-settings-btn {
          display: flex;
        }
      }

      /* on mobile: hide desktop bell, show settings instead */
      .tb-bell-desktop {
        display: none;
      }
      @media (min-width: 1080px) {
        .tb-bell-desktop {
          display: inline-flex;
        }
      }
      .tb-settings-mobile {
        display: inline-flex;
      }
      @media (min-width: 1080px) {
        .tb-settings-mobile {
          display: none;
        }
      }
      .fu {
        opacity: 0;
        transform: translateY(10px);
        animation: fu 0.38s var(--ease) forwards;
      }
      @keyframes fu {
        to {
          opacity: 1;
          transform: none;
        }
      }
      .d1 {
        animation-delay: 0.06s;
      }
      .d2 {
        animation-delay: 0.12s;
      }
      .d3 {
        animation-delay: 0.18s;
      }

      /* body padding for mobile nav */
      @media (max-width: 1079px) {
        body {
          padding-bottom: 60px;
        }
      }

      /* ══════════════════════════════════════════
   DAILY QUOTA BANNER
══════════════════════════════════════════ */
      .quota-banner {
        display: none;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        font-size: 12px;
        font-weight: 600;
        border-bottom: 1px solid var(--border);
      }
      .quota-banner.show {
        display: flex;
      }
      .quota-banner.warn {
        background: rgba(245, 158, 11, 0.07);
        color: #f59e0b;
        border-color: rgba(245, 158, 11, 0.2);
      }
      .quota-banner.full {
        background: rgba(239, 68, 68, 0.07);
        color: #ef4444;
        border-color: rgba(239, 68, 68, 0.2);
      }
      .quota-banner i {
        font-size: 16px;
        flex-shrink: 0;
      }
      .quota-banner-reset {
        margin-left: auto;
        font-size: 10px;
        color: var(--text-3);
        font-family: var(--f-mono);
        white-space: nowrap;
      }

      /* ══════════════════════════════════════════
   PAGE-LEVEL SKELETON OVERLAY
══════════════════════════════════════════ */
      .sk-pulse {
        background: var(--bg-4);
        border-radius: 6px;
        overflow: hidden;
        position: relative;
      }
      .sk-pulse::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(255, 255, 255, 0.06) 50%,
          transparent 100%
        );
        animation: shimmer 1.4s infinite;
      }
      .sk-circle {
        border-radius: 50%;
      }

      /* left sidebar skeleton */
      .sk-snav-item {
        height: 42px;
        border-radius: var(--r);
        margin-bottom: 4px;
      }
      .sk-post-btn {
        height: 42px;
        border-radius: 100px;
        margin-top: 14px;
      }

      /* center feed skeleton */
      .sk-compose {
        height: 60px;
        border-radius: 0;
        margin-bottom: 0;
        border-bottom: 1px solid var(--border);
      }
      .sk-card {
        padding: 16px 16px 12px;
        border-bottom: 1px solid var(--border);
      }
      .sk-card-head {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 12px;
      }
      .sk-card-av {
        width: 42px;
        height: 42px;
        flex-shrink: 0;
      }
      .sk-card-meta {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding-top: 4px;
      }
      .sk-line {
        height: 10px;
        border-radius: 6px;
      }
      .sk-line.w60 {
        width: 60%;
      }
      .sk-line.w40 {
        width: 40%;
      }
      .sk-line.w90 {
        width: 90%;
        height: 12px;
        margin-left: 54px;
      }
      .sk-line.w70 {
        width: 70%;
        height: 12px;
        margin-left: 54px;
        margin-top: 6px;
      }
      .sk-card-acts {
        display: flex;
        gap: 18px;
        margin-left: 54px;
        margin-top: 14px;
      }
      .sk-act {
        width: 40px;
        height: 10px;
        border-radius: 6px;
      }

      /* right sidebar skeleton */
      .sk-widget {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--r-lg);
        padding: 16px;
        margin-bottom: 18px;
      }
      .sk-widget-title {
        height: 8px;
        width: 40%;
        border-radius: 4px;
        margin-bottom: 14px;
      }
      .sk-wtf-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
      }
      .sk-wtf-row:last-child {
        border-bottom: none;
      }
      .sk-wtf-av {
        width: 36px;
        height: 36px;
        flex-shrink: 0;
      }
      .sk-wtf-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .sk-wtf-name {
        height: 10px;
        width: 55%;
        border-radius: 4px;
      }
      .sk-wtf-sub {
        height: 8px;
        width: 35%;
        border-radius: 4px;
      }
      .sk-wtf-btn {
        width: 52px;
        height: 24px;
        border-radius: 100px;
        flex-shrink: 0;
      }
      .sk-trd-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
      }
      .sk-trd-row:last-child {
        border-bottom: none;
      }
      .sk-trd-num {
        width: 22px;
        height: 18px;
        border-radius: 4px;
        flex-shrink: 0;
      }
      .sk-trd-tag {
        height: 12px;
        width: 60%;
        border-radius: 4px;
      }

      /* hide/show helpers */
      .sk-page-overlay {
        display: contents;
      }
      .sk-page-overlay.sk-hidden {
        display: none;
      }
      .real-content {
        display: contents;
      }
      .real-content.sk-hidden {
        display: none;
      }

      /* ══════════════════════════════════════════
   YOUTUBE LINK PREVIEW & CARD
══════════════════════════════════════════ */
      .yt-preview-wrap {
        margin: 0 16px 10px 68px;
        border-radius: var(--r);
        overflow: hidden;
        border: 1px solid var(--border-2);
        background: var(--bg-3);
        position: relative;
        cursor: pointer;
      }
      .yt-thumb-wrap {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        overflow: hidden;
      }
      .yt-thumb-wrap img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transition: transform 0.3s;
      }
      .yt-preview-wrap:hover .yt-thumb-wrap img {
        transform: scale(1.03);
      }
      .yt-play-btn {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.35);
        transition: background 0.2s;
      }
      .yt-preview-wrap:hover .yt-play-btn {
        background: rgba(0, 0, 0, 0.55);
      }
      .yt-play-icon {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: rgba(255, 0, 0, 0.92);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 16px rgba(0, 0, 0, 0.5);
        transition: transform 0.2s;
      }
      .yt-preview-wrap:hover .yt-play-icon {
        transform: scale(1.1);
      }
      .yt-play-icon svg {
        width: 22px;
        height: 22px;
        fill: #fff;
        margin-left: 3px;
      }
      .yt-label {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        border-top: 1px solid var(--border);
      }
      .yt-logo {
        width: 20px;
        height: 14px;
        background: #ff0000;
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      .yt-logo svg {
        width: 12px;
        height: 12px;
        fill: #fff;
      }
      .yt-url-text {
        font-size: 11px;
        color: var(--text-3);
        font-family: var(--f-mono);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
      }
      .yt-remove-btn {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: none;
        background: var(--bg-4);
        color: var(--text-3);
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        flex-shrink: 0;
      }
      .yt-remove-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        color: var(--red);
      }

      /* in-feed YouTube card */
      .yt-card {
        margin-top: 10px;
        border-radius: var(--r);
        overflow: hidden;
        border: 1px solid var(--border-2);
        background: var(--bg-3);
        cursor: pointer;
      }
      .yt-card:hover .yt-thumb-wrap img {
        transform: scale(1.03);
      }
      .yt-card:hover .yt-play-btn {
        background: rgba(0, 0, 0, 0.55);
      }
      .yt-card:hover .yt-play-icon {
        transform: scale(1.1);
      }
      .yt-card .yt-label {
        font-size: 11px;
        color: var(--text-3);
        font-family: var(--f-mono);
      }

      /* YouTube fullscreen modal */
      .yt-modal-overlay {
        position: fixed;
        inset: 0;
        z-index: 600;
        background: rgba(0, 0, 0, 0.92);
        backdrop-filter: blur(12px);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.25s,
          visibility 0.25s;
      }
      .yt-modal-overlay.open {
        opacity: 1;
        visibility: visible;
      }
      .yt-modal-inner {
        width: 90vw;
        max-width: 900px;
        position: relative;
      }
      .yt-modal-close {
        position: absolute;
        top: -40px;
        right: 0;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.15s;
      }
      .yt-modal-close:hover {
        background: rgba(239, 68, 68, 0.4);
      }
      .yt-modal-iframe-wrap {
        width: 100%;
        aspect-ratio: 16/9;
        border-radius: var(--r-lg);
        overflow: hidden;
        background: #000;
      }
      .yt-modal-iframe-wrap iframe {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
      }

      /* ══════════════════════════════════════════
   TOAST NOTIFICATION
══════════════════════════════════════════ */
      .toast-msg {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(16px);
        background: rgba(16, 185, 129, 0.92);
        color: #fff;
        font-size: 13px;
        font-weight: 700;
        padding: 10px 22px;
        border-radius: 100px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.45);
        opacity: 0;
        pointer-events: none;
        transition:
          opacity 0.22s,
          transform 0.22s;
        z-index: 700;
        white-space: nowrap;
        font-family: var(--f-body);
      }
      .toast-msg.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      /* ══════════════════════════════════════════
   EMOJI PICKER POPUP
══════════════════════════════════════════ */
      .emoji-picker-overlay {
        position: fixed;
        inset: 0;
        z-index: 800;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(6px);
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.22s,
          visibility 0.22s;
      }
      .emoji-picker-overlay.open {
        opacity: 1;
        visibility: visible;
      }
      .emoji-picker-popup {
        background: var(--bg-2);
        border: 1px solid var(--border-2);
        border-radius: var(--r-lg);
        padding: 16px;
        width: 320px;
        max-width: 92vw;
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.6);
        transform: scale(0.93) translateY(10px);
        transition: transform 0.22s var(--ease);
      }
      .emoji-picker-overlay.open .emoji-picker-popup {
        transform: scale(1) translateY(0);
      }
      .emoji-picker-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .emoji-picker-title {
        font-family: var(--f-display);
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.1em;
        color: var(--text-3);
        text-transform: uppercase;
      }
      .emoji-picker-close {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: none;
        border: 1px solid var(--border);
        color: var(--text-3);
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }
      .emoji-picker-close:hover {
        background: rgba(239, 68, 68, 0.15);
        border-color: rgba(239, 68, 68, 0.3);
        color: var(--red);
      }
      .emoji-picker-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 4px;
      }
      .emoji-picker-grid button {
        width: 100%;
        aspect-ratio: 1;
        background: none;
        border: none;
        font-size: 22px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition:
          background 0.15s,
          transform 0.12s;
        line-height: 1;
      }
      .emoji-picker-grid button:hover {
        background: rgba(194, 24, 91, 0.12);
        transform: scale(1.18);
      }

      /* ══════════════════════════════════════════
   QUOTE BLOCK (in-feed)
══════════════════════════════════════════ */
      .quote-block {
        margin-top: 10px;
        padding: 12px 16px;
        background: rgba(139, 92, 246, 0.07);
        border-left: 3px solid var(--purple);
        border-radius: 0 var(--r-sm) var(--r-sm) 0;
        font-family: var(--f-mono);
        font-size: 11.5px;
        font-style: italic;
        color: rgba(255, 255, 255, 0.55);
        line-height: 1.65;
        word-break: break-word;
        white-space: pre-wrap;
      }
      .quote-block-label {
        font-size: 9px;
        font-weight: 700;
        letter-spacing: 0.1em;
        color: var(--purple);
        text-transform: uppercase;
        margin-bottom: 6px;
        font-family: var(--f-display);
        display: flex;
        align-items: center;
        gap: 5px;
      }
    </style>
  </head>
  <body>
    <!-- ═══════════════════════════
     TOPBAR
═══════════════════════════ -->
    <nav class="topbar">
      <a href="profile.html" class="topbar-back">
        <i class="ph-bold ph-arrow-left"></i>
        Profile
      </a>
      <a href="#" class="topbar-logo">
        <div class="topbar-logo-mark">T1</div>
        SPARKS
      </a>
      <div class="topbar-actions">
        <button class="tb-icon-btn" title="Search">
          <i class="ph-bold ph-magnifying-glass"></i>
        </button>
        <button
          class="tb-icon-btn tb-settings-btn"
          title="Settings"
          onclick="toggleSettingsPanel()"
        >
          <i class="ph-bold ph-gear"></i>
        </button>
        <div class="bell-wrap tb-bell-desktop">
          <button
            class="tb-icon-btn"
            id="bellBtn"
            title="Notifications"
            onclick="toggleNotifPanel()"
          >
            <i class="ph-bold ph-bell"></i>
          </button>
          <span class="notif-badge" id="notifBadge">0</span>
        </div>
        <button
          class="tb-icon-btn tb-settings-mobile"
          title="Settings"
          onclick="toggleSettingsPanel()"
        >
          <i class="ph-bold ph-gear"></i>
        </button>
      </div>
    </nav>

    <!-- ═══════════════════════════
     MAIN GRID
═══════════════════════════ -->
    <div class="page-wrap">
      <!-- ── LEFT SIDEBAR ── -->
      <aside class="sidebar-left">
        <!-- skeleton -->
        <div class="sk-page-overlay" id="skLeft">
          <div class="sk-pulse sk-snav-item"></div>
          <div class="sk-pulse sk-snav-item"></div>
          <div class="sk-pulse sk-snav-item"></div>
          <div class="sk-pulse sk-snav-item"></div>
          <div class="sk-pulse sk-snav-item"></div>
          <div class="sk-pulse sk-post-btn"></div>
        </div>
        <!-- real -->
        <div class="real-content sk-hidden" id="realLeft">
          <nav class="snav">
            <a class="snav-item active" href="#"
              ><i class="ph-bold ph-lightning"></i>Sparks Feed</a
            >
            <a class="snav-item" href="#"
              ><i class="ph-bold ph-fire"></i>Trending</a
            >
            <a class="snav-item" href="#"
              ><i class="ph-bold ph-chat-teardrop-dots"></i>Prompts</a
            >
            <a class="snav-item" href="profile.html"
              ><i class="ph-bold ph-user-circle"></i>My Profile</a
            >
            <a class="snav-item" href="Pod-Workflow.html"
              ><i class="ph-bold ph-squares-four"></i>Dashboard</a
            >
          </nav>
          <button class="snav-post-btn" onclick="openCompose()">
            <i class="ph-bold ph-lightning"></i> New Spark
          </button>
        </div>
      </aside>

      <!-- ── CENTER FEED ── -->
      <div class="feed-col">
        <!-- TABS -->
        <div class="tabs-bar">
          <button class="tab-btn active" onclick="switchTab(0, this)">
            ⚡ Standard Spark
          </button>
          <button class="tab-btn" onclick="switchTab(1, this)">
            💬 Spark Prompt
          </button>
          <button class="tab-btn" onclick="switchTab(2, this)">
            🔥 Trending
          </button>
        </div>

        <!-- ════════════════════════
         TAB 0 — STANDARD SPARK
    ════════════════════════ -->
        <div class="tab-panel active" id="panel-0">
          <!-- Center feed skeleton (shown until auth+data ready) -->
          <div class="sk-page-overlay" id="skFeed">
            <div
              class="sk-pulse sk-compose"
              style="
                margin: 0;
                border-radius: 0;
                height: 64px;
                border-bottom: 1px solid var(--border);
              "
            ></div>
            <div class="sk-card">
              <div class="sk-card-head">
                <div class="sk-pulse sk-circle sk-card-av"></div>
                <div class="sk-card-meta">
                  <div class="sk-pulse sk-line w60"></div>
                  <div class="sk-pulse sk-line w40"></div>
                </div>
              </div>
              <div class="sk-pulse sk-line w90"></div>
              <div class="sk-pulse sk-line w70"></div>
              <div class="sk-card-acts">
                <div class="sk-pulse sk-act"></div>
                <div class="sk-pulse sk-act"></div>
                <div class="sk-pulse sk-act"></div>
                <div class="sk-pulse sk-act"></div>
              </div>
            </div>
            <div class="sk-card">
              <div class="sk-card-head">
                <div class="sk-pulse sk-circle sk-card-av"></div>
                <div class="sk-card-meta">
                  <div class="sk-pulse sk-line w60"></div>
                  <div class="sk-pulse sk-line w40"></div>
                </div>
              </div>
              <div class="sk-pulse sk-line w90"></div>
              <div class="sk-pulse sk-line w70"></div>
              <div class="sk-card-acts">
                <div class="sk-pulse sk-act"></div>
                <div class="sk-pulse sk-act"></div>
                <div class="sk-pulse sk-act"></div>
                <div class="sk-pulse sk-act"></div>
              </div>
            </div>
            <div class="sk-card">
              <div class="sk-card-head">
                <div class="sk-pulse sk-circle sk-card-av"></div>
                <div class="sk-card-meta">
                  <div class="sk-pulse sk-line w60"></div>
                  <div class="sk-pulse sk-line w40"></div>
                </div>
              </div>
              <div class="sk-pulse sk-line w90"></div>
              <div class="sk-pulse sk-line w70"></div>
              <div class="sk-card-acts">
                <div class="sk-pulse sk-act"></div>
                <div class="sk-pulse sk-act"></div>
                <div class="sk-pulse sk-act"></div>
                <div class="sk-pulse sk-act"></div>
              </div>
            </div>
            <div class="sk-card">
              <div class="sk-card-head">
                <div class="sk-pulse sk-circle sk-card-av"></div>
                <div class="sk-card-meta">
                  <div class="sk-pulse sk-line w60"></div>
                  <div class="sk-pulse sk-line w40"></div>
                </div>
              </div>
              <div class="sk-pulse sk-line w90"></div>
              <div class="sk-pulse sk-line w70"></div>
              <div class="sk-card-acts">
                <div class="sk-pulse sk-act"></div>
                <div class="sk-pulse sk-act"></div>
                <div class="sk-pulse sk-act"></div>
                <div class="sk-pulse sk-act"></div>
              </div>
            </div>
          </div>

          <!-- real feed content (hidden until auth+data ready) -->
          <div class="real-content sk-hidden" id="realFeed">
            <!-- Feed Mini Header -->
            <div class="feed-mini-header">
              <div class="feed-mini-title">
                <i class="ph-bold ph-lightning"></i>
                Sparks Feed
              </div>
              <button
                class="feed-refresh-btn"
                id="feedRefreshBtn"
                onclick="triggerFeedRefresh()"
                title="Refresh feed"
              >
                <i class="ph-bold ph-arrows-clockwise" id="feedRefreshIcon"></i>
              </button>
            </div>

            <!-- Compose toggle -->
            <div
              class="compose-toggle"
              id="composeToggle"
              onclick="openCompose()"
            >
              <div class="compose-mini-av" id="miniAv">M</div>
              <span class="compose-placeholder">What's sparking today…</span>
              <button class="compose-plus-btn">
                <i class="ph-bold ph-plus"></i>
              </button>
            </div>

            <!-- Daily quota banner -->
            <div class="quota-banner" id="quotaBanner">
              <i class="ph-bold ph-warning"></i>
              <span id="quotaMsg"></span>
              <span class="quota-banner-reset" id="quotaReset"></span>
            </div>

            <!-- Compose box (hidden by default) -->
            <div class="compose-box" id="composeBox">
              <div class="compose-top">
                <span class="compose-label"
                  ><i class="ph-bold ph-lightning"></i> NEW SPARK</span
                >
                <button class="compose-close-btn" onclick="closeCompose()">
                  <i class="ph-bold ph-x"></i>
                </button>
              </div>
              <div class="compose-body">
                <div class="compose-av" id="composeAv">M</div>
                <div style="flex: 1; min-width: 0">
                  <textarea
                    class="compose-textarea"
                    id="composeTa"
                    placeholder="Share what's on your mind… use #hashtags and @mentions"
                    oninput="onComposeInput(this)"
                    maxlength="500"
                  ></textarea>
                </div>
              </div>
              <!-- Media preview strip -->
              <div class="media-strip" id="mediaStrip"></div>
              <!-- Footer -->
              <div class="compose-footer">
                <div class="media-btns">
                  <button class="media-btn" title="Photo">
                    <i class="ph-bold ph-image"></i>
                    <input
                      type="file"
                      accept="image/*"
                      multiple
                      onchange="attachMedia(this, 'image')"
                    />
                  </button>
                  <button class="media-btn" title="Video">
                    <i class="ph-bold ph-video-camera"></i>
                    <input
                      type="file"
                      accept="video/*"
                      onchange="attachMedia(this, 'video')"
                    />
                  </button>
                  <button
                    class="media-btn"
                    title="GIF"
                    onclick="alert('GIF picker — coming soon')"
                  >
                    <i class="ph-bold ph-gif"></i>
                  </button>
                  <button class="media-btn" title="File">
                    <i class="ph-bold ph-paperclip"></i>
                    <input
                      type="file"
                      accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip,.rar,.txt,.csv"
                      onchange="attachMedia(this, 'file')"
                    />
                  </button>
                  <button class="media-btn" title="Audio">
                    <i class="ph-bold ph-microphone"></i>
                    <input
                      type="file"
                      accept="audio/*"
                      onchange="attachMedia(this, 'audio')"
                    />
                  </button>
                  <button
                    class="media-btn"
                    title="Emoji"
                    onclick="openEmojiPicker('composeTa')"
                  >
                    <i class="ph-bold ph-smiley"></i>
                  </button>
                  <button
                    class="media-btn"
                    title="Quote"
                    onclick="insertQuoteFormat('composeTa')"
                  >
                    <i class="ph-bold ph-quotes"></i>
                  </button>
                </div>
                <div class="compose-right">
                  <span class="char-count" id="charCount">0 / 500</span>
                  <button
                    class="spark-submit-btn"
                    id="submitBtn"
                    disabled
                    onclick="submitSpark()"
                  >
                    Spark ⚡
                  </button>
                </div>
              </div>
            </div>

            <!-- ═══ DEMO SPARK CARDS ═══ -->

            <!-- Card 1: text + single image, already liked -->
            <article class="spark-card fu" onclick="openSparkDetail(this)">
              <div class="card-head">
                <div class="av-wrap">
                  <div
                    class="spark-av"
                    style="
                      background: linear-gradient(135deg, #c2185b, #8b5cf6);
                    "
                    onclick="
                      event.stopPropagation();
                      showProfile(
                        'Ikram Basri',
                        'ewm24k',
                        'LV 5 · Operative',
                        128,
                        947,
                        'Just shipped T1ERA. Building the future in public 🔥 Founder · Dev · Strategist',
                        '#c2185b',
                        true,
                      );
                    "
                  >
                    IB
                  </div>
                  <span class="online-dot"></span>
                </div>
                <div class="card-meta">
                  <div class="meta-row-1">
                    <span
                      class="author-name"
                      onclick="
                        event.stopPropagation();
                        showProfile(
                          'Ikram Basri',
                          'ewm24k',
                          'LV 5 · Operative',
                          128,
                          947,
                          'Just shipped T1ERA. Building the future in public 🔥 Founder · Dev · Strategist',
                          '#c2185b',
                          true,
                        );
                      "
                    >
                      Ikram Basri
                    </span>
                    <span class="author-handle">@ewm24k</span>
                    <button
                      class="follow-pill on"
                      onclick="
                        event.stopPropagation();
                        toggleFollow(this);
                      "
                    >
                      Following
                    </button>
                    <span class="spark-time">2m ago</span>
                  </div>
                  <div class="badges-row">
                    <span class="badge rank"
                      ><i class="ph-fill ph-shield-star"></i> LV 5</span
                    >
                    <span class="badge verified">✓ Verified</span>
                  </div>
                </div>
                <button class="dots-btn" onclick="event.stopPropagation()">
                  <i class="ph-bold ph-dots-three-vertical"></i>
                </button>
              </div>
              <div class="card-content">
                <p class="spark-text">
                  Just pushed a massive update to T1ERA 🚀 New profile page live
                  — bio, status, banner presets, Cloudinary photo upload, and
                  desktop layout. Really proud of this build.
                  <span class="ht">#T1ERA</span>
                  <span class="ht">#BuildInPublic</span>
                  <span class="mn">@team</span> 🔥
                </p>
                <div class="media-grid g1">
                  <div class="mi">
                    <img
                      src="https://images.unsplash.com/photo-1555066931-4365d14bab8c?w=700&q=80"
                      alt="code"
                      loading="lazy"
                    />
                  </div>
                </div>
              </div>
              <div class="action-bar">
                <button
                  class="act-btn like liked"
                  onclick="
                    event.stopPropagation();
                    toggleLike(this);
                  "
                >
                  <i class="ph-fill ph-heart"></i><span>142</span>
                </button>
                <button
                  class="act-btn reply"
                  onclick="
                    event.stopPropagation();
                    openReply(
                      'Ikram Basri',
                      'IB',
                      '#c2185b',
                      'Just pushed a massive update to T1ERA 🚀',
                    );
                  "
                >
                  <i class="ph-bold ph-chat-circle"></i><span>28</span>
                </button>
                <button
                  class="act-btn repost"
                  onclick="
                    event.stopPropagation();
                    toggleRepost(this);
                  "
                >
                  <i class="ph-bold ph-repeat"></i><span>19</span>
                </button>
                <button
                  class="act-btn share"
                  onclick="
                    event.stopPropagation();
                    shareSpark();
                  "
                >
                  <i class="ph-bold ph-share-network"></i><span>7</span>
                </button>
                <button
                  class="act-btn bookmark"
                  onclick="
                    event.stopPropagation();
                    toggleBookmark(this);
                  "
                  style="margin-left: auto"
                >
                  <i class="ph-bold ph-bookmark-simple"></i>
                </button>
              </div>
            </article>

            <!-- Card 2: reposted, text only -->
            <article class="spark-card fu d1" onclick="openSparkDetail(this)">
              <div class="repost-bar">
                <i class="ph-bold ph-repeat"></i> Danial reposted
              </div>
              <div class="card-head">
                <div class="av-wrap">
                  <div
                    class="spark-av"
                    style="
                      background: linear-gradient(135deg, #f59e0b, #f97316);
                    "
                    onclick="
                      event.stopPropagation();
                      showProfile(
                        'Wani Aisyah',
                        'waniaisyah',
                        'LV 3 · Scout',
                        64,
                        210,
                        'Tech enthusiast & T1ERA early adopter 🌟 Always building something new',
                        '#f59e0b',
                        false,
                      );
                    "
                  >
                    WA
                  </div>
                </div>
                <div class="card-meta">
                  <div class="meta-row-1">
                    <span
                      class="author-name"
                      onclick="
                        event.stopPropagation();
                        showProfile(
                          'Wani Aisyah',
                          'waniaisyah',
                          'LV 3 · Scout',
                          64,
                          210,
                          'Tech enthusiast & T1ERA early adopter 🌟',
                          '#f59e0b',
                          false,
                        );
                      "
                      >Wani Aisyah</span
                    >
                    <span class="author-handle">@waniaisyah</span>
                    <button
                      class="follow-pill"
                      onclick="
                        event.stopPropagation();
                        toggleFollow(this);
                      "
                    >
                      <i class="ph-bold ph-plus"></i> Follow
                    </button>
                    <span class="spark-time">15m ago</span>
                  </div>
                  <div class="badges-row">
                    <span class="badge rank">LV 3</span>
                  </div>
                </div>
                <button class="dots-btn" onclick="event.stopPropagation()">
                  <i class="ph-bold ph-dots-three-vertical"></i>
                </button>
              </div>
              <div class="card-content">
                <p class="spark-text">
                  The way AI is reshaping workflows in 2025 is genuinely insane.
                  Shoutout to everyone building in public — you inspire me more
                  than you know. Keep going 💪
                  <span class="ht">#BuildInPublic</span>
                  <span class="ht">#AI</span> <span class="ht">#T1ERA</span>
                </p>
              </div>
              <div class="action-bar">
                <button
                  class="act-btn like"
                  onclick="
                    event.stopPropagation();
                    toggleLike(this);
                  "
                >
                  <i class="ph-bold ph-heart"></i><span>87</span>
                </button>
                <button
                  class="act-btn reply"
                  onclick="
                    event.stopPropagation();
                    openReply(
                      'Wani Aisyah',
                      'WA',
                      '#f59e0b',
                      'The way AI is reshaping workflows in 2025...',
                    );
                  "
                >
                  <i class="ph-bold ph-chat-circle"></i><span>14</span>
                </button>
                <button
                  class="act-btn repost reposted"
                  onclick="
                    event.stopPropagation();
                    toggleRepost(this);
                  "
                >
                  <i class="ph-bold ph-repeat"></i><span>31</span>
                </button>
                <button
                  class="act-btn share"
                  onclick="
                    event.stopPropagation();
                    shareSpark();
                  "
                >
                  <i class="ph-bold ph-share-network"></i><span>4</span>
                </button>
                <button
                  class="act-btn bookmark"
                  onclick="
                    event.stopPropagation();
                    toggleBookmark(this);
                  "
                  style="margin-left: auto"
                >
                  <i class="ph-bold ph-bookmark-simple"></i>
                </button>
              </div>
            </article>

            <!-- Card 3: double image grid -->
            <article class="spark-card fu d2" onclick="openSparkDetail(this)">
              <div class="card-head">
                <div class="av-wrap">
                  <div
                    class="spark-av"
                    style="
                      background: linear-gradient(135deg, #10b981, #0ea5e9);
                    "
                    onclick="
                      event.stopPropagation();
                      showProfile(
                        'Luqman Faiz',
                        'luqmanf',
                        'LV 2 · Recruit',
                        22,
                        89,
                        'Designer × developer. UI obsessed.',
                        '#10b981',
                        false,
                      );
                    "
                  >
                    LF
                  </div>
                </div>
                <div class="card-meta">
                  <div class="meta-row-1">
                    <span
                      class="author-name"
                      onclick="
                        event.stopPropagation();
                        showProfile(
                          'Luqman Faiz',
                          'luqmanf',
                          'LV 2 · Recruit',
                          22,
                          89,
                          'Designer × developer. UI obsessed.',
                          '#10b981',
                          false,
                        );
                      "
                      >Luqman Faiz</span
                    >
                    <span class="author-handle">@luqmanf</span>
                    <button
                      class="follow-pill"
                      onclick="
                        event.stopPropagation();
                        toggleFollow(this);
                      "
                    >
                      <i class="ph-bold ph-plus"></i> Follow
                    </button>
                    <span class="spark-time">1h ago</span>
                  </div>
                  <div class="badges-row">
                    <span class="badge rank">LV 2</span>
                  </div>
                </div>
                <button class="dots-btn" onclick="event.stopPropagation()">
                  <i class="ph-bold ph-dots-three-vertical"></i>
                </button>
              </div>
              <div class="card-content">
                <p class="spark-text">
                  UI explorations this week — dark gradient interfaces with pink
                  accent systems. Which direction do you prefer? Drop your
                  thoughts 👇 <span class="ht">#UIDesign</span>
                  <span class="ht">#DarkMode</span>
                </p>
                <div class="media-grid g2">
                  <div class="mi">
                    <img
                      src="https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=400&q=80"
                      alt="ui1"
                      loading="lazy"
                    />
                  </div>
                  <div class="mi">
                    <img
                      src="https://images.unsplash.com/photo-1551650975-87deedd944c3?w=400&q=80"
                      alt="ui2"
                      loading="lazy"
                    />
                  </div>
                </div>
              </div>
              <div class="action-bar">
                <button
                  class="act-btn like"
                  onclick="
                    event.stopPropagation();
                    toggleLike(this);
                  "
                >
                  <i class="ph-bold ph-heart"></i><span>56</span>
                </button>
                <button
                  class="act-btn reply"
                  onclick="
                    event.stopPropagation();
                    openReply(
                      'Luqman Faiz',
                      'LF',
                      '#10b981',
                      'UI explorations this week...',
                    );
                  "
                >
                  <i class="ph-bold ph-chat-circle"></i><span>9</span>
                </button>
                <button
                  class="act-btn repost"
                  onclick="
                    event.stopPropagation();
                    toggleRepost(this);
                  "
                >
                  <i class="ph-bold ph-repeat"></i><span>12</span>
                </button>
                <button
                  class="act-btn share"
                  onclick="
                    event.stopPropagation();
                    shareSpark();
                  "
                >
                  <i class="ph-bold ph-share-network"></i><span>3</span>
                </button>
                <button
                  class="act-btn bookmark"
                  onclick="
                    event.stopPropagation();
                    toggleBookmark(this);
                  "
                  style="margin-left: auto"
                >
                  <i class="ph-bold ph-bookmark-simple"></i>
                </button>
              </div>
            </article>

            <!-- Card 4: triple image grid -->
            <article class="spark-card fu d3" onclick="openSparkDetail(this)">
              <div class="card-head">
                <div class="av-wrap">
                  <div
                    class="spark-av"
                    style="
                      background: linear-gradient(135deg, #8b5cf6, #c2185b);
                    "
                    onclick="
                      event.stopPropagation();
                      showProfile(
                        'Danial L.',
                        'danialL',
                        'LV 4 · Operative',
                        99,
                        301,
                        'Productivity nerd. Building the future. T1ERA power user.',
                        '#8b5cf6',
                        false,
                      );
                    "
                  >
                    DL
                  </div>
                </div>
                <div class="card-meta">
                  <div class="meta-row-1">
                    <span
                      class="author-name"
                      onclick="
                        event.stopPropagation();
                        showProfile(
                          'Danial L.',
                          'danialL',
                          'LV 4 · Operative',
                          99,
                          301,
                          'Productivity nerd. Building the future.',
                          '#8b5cf6',
                          false,
                        );
                      "
                      >Danial L.</span
                    >
                    <span class="author-handle">@danialL</span>
                    <button
                      class="follow-pill"
                      onclick="
                        event.stopPropagation();
                        toggleFollow(this);
                      "
                    >
                      <i class="ph-bold ph-plus"></i> Follow
                    </button>
                    <span class="spark-time">3h ago</span>
                  </div>
                  <div class="badges-row">
                    <span class="badge rank">LV 4</span>
                  </div>
                </div>
                <button class="dots-btn" onclick="event.stopPropagation()">
                  <i class="ph-bold ph-dots-three-vertical"></i>
                </button>
              </div>
              <div class="card-content">
                <p class="spark-text">
                  Workspace setup upgrade complete 🖥️ Three monitors, custom
                  desk, ambient lighting. Focus level: maximum.
                  <span class="ht">#SetupGoals</span>
                  <span class="ht">#WorkFromHome</span>
                </p>
                <div class="media-grid g3">
                  <div class="mi">
                    <img
                      src="https://images.unsplash.com/photo-1593640408182-31c228f2d2e1?w=500&q=80"
                      alt="desk1"
                      loading="lazy"
                    />
                  </div>
                  <div class="mi">
                    <img
                      src="https://images.unsplash.com/photo-1611532736597-de2d4265fba3?w=400&q=80"
                      alt="desk2"
                      loading="lazy"
                    />
                  </div>
                  <div class="mi">
                    <img
                      src="https://images.unsplash.com/photo-1498050108023-c5249f4df085?w=400&q=80"
                      alt="desk3"
                      loading="lazy"
                    />
                  </div>
                </div>
              </div>
              <div class="action-bar">
                <button
                  class="act-btn like"
                  onclick="
                    event.stopPropagation();
                    toggleLike(this);
                  "
                >
                  <i class="ph-bold ph-heart"></i><span>203</span>
                </button>
                <button
                  class="act-btn reply"
                  onclick="
                    event.stopPropagation();
                    openReply(
                      'Danial L.',
                      'DL',
                      '#8b5cf6',
                      'Workspace setup upgrade complete 🖥️',
                    );
                  "
                >
                  <i class="ph-bold ph-chat-circle"></i><span>41</span>
                </button>
                <button
                  class="act-btn repost"
                  onclick="
                    event.stopPropagation();
                    toggleRepost(this);
                  "
                >
                  <i class="ph-bold ph-repeat"></i><span>67</span>
                </button>
                <button
                  class="act-btn share"
                  onclick="
                    event.stopPropagation();
                    shareSpark();
                  "
                >
                  <i class="ph-bold ph-share-network"></i><span>18</span>
                </button>
                <button
                  class="act-btn bookmark"
                  onclick="
                    event.stopPropagation();
                    toggleBookmark(this);
                  "
                  style="margin-left: auto"
                >
                  <i class="ph-bold ph-bookmark-simple"></i>
                </button>
              </div>
            </article>
          </div>
          <!-- end realFeed -->
        </div>
        <!-- end panel-0 -->

        <!-- ════════════════════════
         TAB 1 — SPARK PROMPT
    ════════════════════════ -->
        <div class="tab-panel" id="panel-1">
          <div
            style="
              padding: 14px 16px;
              border-bottom: 1px solid var(--border);
              background: rgba(139, 92, 246, 0.04);
            "
          >
            <p
              style="
                font-size: 12px;
                color: var(--text-3);
                line-height: 1.65;
                font-family: var(--f-mono);
              "
            >
              <span style="color: var(--purple); font-weight: 700"
                >// SPARK PROMPTS</span
              >
              — Open questions from the community. Tap a prompt to reply. Your
              answer becomes a Spark on your profile.
            </p>
          </div>

          <!-- Prompt 1 -->
          <article
            class="spark-card fu"
            onclick="
              openReply(
                'Danial L.',
                'DL',
                '#8b5cf6',
                'What single habit completely changed your productivity?',
              )
            "
          >
            <div class="card-head">
              <div class="av-wrap">
                <div
                  class="spark-av"
                  style="background: linear-gradient(135deg, #8b5cf6, #c2185b)"
                  onclick="
                    event.stopPropagation();
                    showProfile(
                      'Danial L.',
                      'danialL',
                      'LV 4 · Operative',
                      99,
                      301,
                      'Productivity nerd. Building the future.',
                      '#8b5cf6',
                      false,
                    );
                  "
                >
                  DL
                </div>
              </div>
              <div class="card-meta">
                <div class="meta-row-1">
                  <span class="author-name">Danial L.</span>
                  <span class="author-handle">@danialL</span>
                  <button
                    class="follow-pill"
                    onclick="
                      event.stopPropagation();
                      toggleFollow(this);
                    "
                  >
                    <i class="ph-bold ph-plus"></i> Follow
                  </button>
                  <span class="spark-time">3h ago</span>
                </div>
                <div class="badges-row">
                  <span class="badge rank">LV 4</span>
                  <span class="badge prompt-tag"
                    ><i class="ph-bold ph-chat-teardrop-dots"></i> Prompt</span
                  >
                </div>
              </div>
              <button class="dots-btn" onclick="event.stopPropagation()">
                <i class="ph-bold ph-dots-three-vertical"></i>
              </button>
            </div>
            <div class="card-content">
              <div class="prompt-card">
                <div class="prompt-label">
                  <i class="ph-bold ph-question"></i> Open Prompt
                </div>
                <p class="prompt-q">
                  What is the single habit that completely changed your
                  productivity — and could you ever go back to life without it?
                </p>
                <p class="prompt-replies">
                  💬 47 people replied · tap to add your spark
                </p>
              </div>
            </div>
            <div class="action-bar">
              <button
                class="act-btn like"
                onclick="
                  event.stopPropagation();
                  toggleLike(this);
                "
              >
                <i class="ph-bold ph-heart"></i><span>203</span>
              </button>
              <button
                class="act-btn reply"
                onclick="
                  event.stopPropagation();
                  openReply(
                    'Danial L.',
                    'DL',
                    '#8b5cf6',
                    'What single habit completely changed your productivity?',
                  );
                "
              >
                <i class="ph-bold ph-chat-circle"></i><span>47</span>
              </button>
              <button
                class="act-btn repost"
                onclick="
                  event.stopPropagation();
                  toggleRepost(this);
                "
              >
                <i class="ph-bold ph-repeat"></i><span>61</span>
              </button>
              <button
                class="act-btn share"
                onclick="
                  event.stopPropagation();
                  shareSpark();
                "
              >
                <i class="ph-bold ph-share-network"></i><span>15</span>
              </button>
            </div>
          </article>

          <!-- Prompt 2 -->
          <article
            class="spark-card fu d1"
            onclick="
              openReply(
                'Wani Aisyah',
                'WA',
                '#f59e0b',
                'Best underrated tool for remote teams in 2025?',
              )
            "
          >
            <div class="card-head">
              <div class="av-wrap">
                <div
                  class="spark-av"
                  style="background: linear-gradient(135deg, #f59e0b, #f97316)"
                  onclick="
                    event.stopPropagation();
                    showProfile(
                      'Wani Aisyah',
                      'waniaisyah',
                      'LV 3 · Scout',
                      64,
                      210,
                      'Tech enthusiast & early adopter 🌟',
                      '#f59e0b',
                      false,
                    );
                  "
                >
                  WA
                </div>
              </div>
              <div class="card-meta">
                <div class="meta-row-1">
                  <span class="author-name">Wani Aisyah</span>
                  <span class="author-handle">@waniaisyah</span>
                  <button
                    class="follow-pill"
                    onclick="
                      event.stopPropagation();
                      toggleFollow(this);
                    "
                  >
                    <i class="ph-bold ph-plus"></i> Follow
                  </button>
                  <span class="spark-time">6h ago</span>
                </div>
                <div class="badges-row">
                  <span class="badge rank">LV 3</span>
                  <span class="badge prompt-tag"
                    ><i class="ph-bold ph-chat-teardrop-dots"></i> Prompt</span
                  >
                </div>
              </div>
              <button class="dots-btn" onclick="event.stopPropagation()">
                <i class="ph-bold ph-dots-three-vertical"></i>
              </button>
            </div>
            <div class="card-content">
              <div class="prompt-card">
                <div class="prompt-label">
                  <i class="ph-bold ph-question"></i> Open Prompt
                </div>
                <p class="prompt-q">
                  What is the most underrated tool for remote teams in 2025 that
                  most people still haven't discovered?
                </p>
                <p class="prompt-replies">
                  💬 23 people replied · tap to add your spark
                </p>
              </div>
            </div>
            <div class="action-bar">
              <button
                class="act-btn like"
                onclick="
                  event.stopPropagation();
                  toggleLike(this);
                "
              >
                <i class="ph-bold ph-heart"></i><span>88</span>
              </button>
              <button
                class="act-btn reply"
                onclick="
                  event.stopPropagation();
                  openReply(
                    'Wani Aisyah',
                    'WA',
                    '#f59e0b',
                    'Best underrated tool for remote teams in 2025?',
                  );
                "
              >
                <i class="ph-bold ph-chat-circle"></i><span>23</span>
              </button>
              <button
                class="act-btn repost"
                onclick="
                  event.stopPropagation();
                  toggleRepost(this);
                "
              >
                <i class="ph-bold ph-repeat"></i><span>17</span>
              </button>
              <button
                class="act-btn share"
                onclick="
                  event.stopPropagation();
                  shareSpark();
                "
              >
                <i class="ph-bold ph-share-network"></i><span>5</span>
              </button>
            </div>
          </article>

          <!-- Prompt 3 -->
          <article
            class="spark-card fu d2"
            onclick="
              openReply(
                'Ikram Basri',
                'IB',
                '#c2185b',
                'What does your ideal morning routine look like?',
              )
            "
          >
            <div class="card-head">
              <div class="av-wrap">
                <div
                  class="spark-av"
                  style="background: linear-gradient(135deg, #c2185b, #8b5cf6)"
                  onclick="
                    event.stopPropagation();
                    showProfile(
                      'Ikram Basri',
                      'ewm24k',
                      'LV 5 · Operative',
                      128,
                      947,
                      'Just shipped T1ERA. Building the future in public 🔥',
                      '#c2185b',
                      true,
                    );
                  "
                >
                  IB
                </div>
                <span class="online-dot"></span>
              </div>
              <div class="card-meta">
                <div class="meta-row-1">
                  <span class="author-name">Ikram Basri</span>
                  <span class="author-handle">@ewm24k</span>
                  <button
                    class="follow-pill on"
                    onclick="
                      event.stopPropagation();
                      toggleFollow(this);
                    "
                  >
                    Following
                  </button>
                  <span class="spark-time">Yesterday</span>
                </div>
                <div class="badges-row">
                  <span class="badge rank">LV 5</span>
                  <span class="badge verified">✓ Verified</span>
                  <span class="badge prompt-tag"
                    ><i class="ph-bold ph-chat-teardrop-dots"></i> Prompt</span
                  >
                </div>
              </div>
              <button class="dots-btn" onclick="event.stopPropagation()">
                <i class="ph-bold ph-dots-three-vertical"></i>
              </button>
            </div>
            <div class="card-content">
              <div class="prompt-card">
                <div class="prompt-label">
                  <i class="ph-bold ph-question"></i> Open Prompt
                </div>
                <p class="prompt-q">
                  Describe your ideal morning routine in 3 steps — be specific.
                  What time, what actions, and what outcome?
                </p>
                <p class="prompt-replies">
                  💬 112 people replied · tap to add your spark
                </p>
              </div>
            </div>
            <div class="action-bar">
              <button
                class="act-btn like liked"
                onclick="
                  event.stopPropagation();
                  toggleLike(this);
                "
              >
                <i class="ph-fill ph-heart"></i><span>318</span>
              </button>
              <button
                class="act-btn reply"
                onclick="
                  event.stopPropagation();
                  openReply(
                    'Ikram Basri',
                    'IB',
                    '#c2185b',
                    'Describe your ideal morning routine...',
                  );
                "
              >
                <i class="ph-bold ph-chat-circle"></i><span>112</span>
              </button>
              <button
                class="act-btn repost"
                onclick="
                  event.stopPropagation();
                  toggleRepost(this);
                "
              >
                <i class="ph-bold ph-repeat"></i><span>89</span>
              </button>
              <button
                class="act-btn share"
                onclick="
                  event.stopPropagation();
                  shareSpark();
                "
              >
                <i class="ph-bold ph-share-network"></i><span>22</span>
              </button>
            </div>
          </article>
        </div>
        <!-- end panel-1 -->

        <!-- ════════════════════════
         TAB 2 — TRENDING
    ════════════════════════ -->
        <div class="tab-panel" id="panel-2">
          <!-- Trending topics header -->
          <div class="trend-header">
            <p class="trend-header-label">🔥 Trending in T1ERA · Right Now</p>
            <div class="trend-topic">
              <div class="trend-n hot">1</div>
              <div class="trend-info">
                <div class="trend-tag">#T1ERA</div>
                <div class="trend-count">1,204 Sparks</div>
              </div>
              <span class="trend-icon">🔥</span>
            </div>
            <div class="trend-topic">
              <div class="trend-n hot">2</div>
              <div class="trend-info">
                <div class="trend-tag">#BuildInPublic</div>
                <div class="trend-count">847 Sparks</div>
              </div>
              <span class="trend-icon">🔥</span>
            </div>
            <div class="trend-topic">
              <div class="trend-n">3</div>
              <div class="trend-info">
                <div class="trend-tag">#UIDesign</div>
                <div class="trend-count">562 Sparks</div>
              </div>
            </div>
            <div class="trend-topic">
              <div class="trend-n">4</div>
              <div class="trend-info">
                <div class="trend-tag">#AI</div>
                <div class="trend-count">489 Sparks</div>
              </div>
            </div>
            <div class="trend-topic">
              <div class="trend-n">5</div>
              <div class="trend-info">
                <div class="trend-tag">#DarkMode</div>
                <div class="trend-count">317 Sparks</div>
              </div>
            </div>
            <div class="trend-topic">
              <div class="trend-n">6</div>
              <div class="trend-info">
                <div class="trend-tag">#SetupGoals</div>
                <div class="trend-count">241 Sparks</div>
              </div>
            </div>
          </div>

          <!-- Top trending spark -->
          <article class="spark-card fu" onclick="openSparkDetail(this)">
            <div class="trending-pill">
              <i class="ph-bold ph-fire"></i> Trending #1 · #T1ERA
            </div>
            <div class="card-head">
              <div class="av-wrap">
                <div
                  class="spark-av"
                  style="background: linear-gradient(135deg, #c2185b, #8b5cf6)"
                  onclick="
                    event.stopPropagation();
                    showProfile(
                      'Ikram Basri',
                      'ewm24k',
                      'LV 5 · Operative',
                      128,
                      947,
                      'Just shipped T1ERA. Building the future in public 🔥',
                      '#c2185b',
                      true,
                    );
                  "
                >
                  IB
                </div>
                <span class="online-dot"></span>
              </div>
              <div class="card-meta">
                <div class="meta-row-1">
                  <span class="author-name">Ikram Basri</span>
                  <span class="author-handle">@ewm24k</span>
                  <button
                    class="follow-pill on"
                    onclick="
                      event.stopPropagation();
                      toggleFollow(this);
                    "
                  >
                    Following
                  </button>
                  <span class="spark-time">2h ago</span>
                </div>
                <div class="badges-row">
                  <span class="badge rank">LV 5</span>
                  <span class="badge verified">✓ Verified</span>
                  <span class="badge hot"
                    ><i class="ph-bold ph-fire"></i> Trending</span
                  >
                </div>
              </div>
              <button class="dots-btn" onclick="event.stopPropagation()">
                <i class="ph-bold ph-dots-three-vertical"></i>
              </button>
            </div>
            <div class="card-content">
              <p class="spark-text">
                T1ERA just crossed <strong>1,000 signups</strong> in the first
                week of beta 🎉 This is only the beginning. Thank you to
                everyone who believed before there was anything to believe in.
                We build together. <span class="ht">#T1ERA</span>
                <span class="ht">#Milestone</span> 🚀
              </p>
            </div>
            <div class="action-bar">
              <button
                class="act-btn like liked"
                onclick="
                  event.stopPropagation();
                  toggleLike(this);
                "
              >
                <i class="ph-fill ph-heart"></i><span>1.2k</span>
              </button>
              <button
                class="act-btn reply"
                onclick="
                  event.stopPropagation();
                  openReply(
                    'Ikram Basri',
                    'IB',
                    '#c2185b',
                    'T1ERA just crossed 1,000 signups...',
                  );
                "
              >
                <i class="ph-bold ph-chat-circle"></i><span>284</span>
              </button>
              <button
                class="act-btn repost reposted"
                onclick="
                  event.stopPropagation();
                  toggleRepost(this);
                "
              >
                <i class="ph-bold ph-repeat"></i><span>401</span>
              </button>
              <button
                class="act-btn share"
                onclick="
                  event.stopPropagation();
                  shareSpark();
                "
              >
                <i class="ph-bold ph-share-network"></i><span>88</span>
              </button>
              <button
                class="act-btn bookmark"
                onclick="
                  event.stopPropagation();
                  toggleBookmark(this);
                "
                style="margin-left: auto"
              >
                <i class="ph-bold ph-bookmark-simple"></i>
              </button>
            </div>
          </article>

          <!-- Trending #2 -->
          <article class="spark-card fu d1" onclick="openSparkDetail(this)">
            <div class="trending-pill">
              <i class="ph-bold ph-fire"></i> Trending #2 · #BuildInPublic
            </div>
            <div class="card-head">
              <div class="av-wrap">
                <div
                  class="spark-av"
                  style="background: linear-gradient(135deg, #f59e0b, #f97316)"
                  onclick="
                    event.stopPropagation();
                    showProfile(
                      'Wani Aisyah',
                      'waniaisyah',
                      'LV 3 · Scout',
                      64,
                      210,
                      'Tech enthusiast & T1ERA early adopter 🌟',
                      '#f59e0b',
                      false,
                    );
                  "
                >
                  WA
                </div>
              </div>
              <div class="card-meta">
                <div class="meta-row-1">
                  <span class="author-name">Wani Aisyah</span>
                  <span class="author-handle">@waniaisyah</span>
                  <button
                    class="follow-pill"
                    onclick="
                      event.stopPropagation();
                      toggleFollow(this);
                    "
                  >
                    <i class="ph-bold ph-plus"></i> Follow
                  </button>
                  <span class="spark-time">4h ago</span>
                </div>
                <div class="badges-row">
                  <span class="badge rank">LV 3</span>
                  <span class="badge hot"
                    ><i class="ph-bold ph-fire"></i> Trending</span
                  >
                </div>
              </div>
              <button class="dots-btn" onclick="event.stopPropagation()">
                <i class="ph-bold ph-dots-three-vertical"></i>
              </button>
            </div>
            <div class="card-content">
              <p class="spark-text">
                Building in public taught me more in 3 months than 3 years of
                building alone ever did. The feedback loop is insane when people
                are watching. Share your journey — even the ugly parts.
                <span class="ht">#BuildInPublic</span>
                <span class="ht">#T1ERA</span>
              </p>
            </div>
            <div class="action-bar">
              <button
                class="act-btn like"
                onclick="
                  event.stopPropagation();
                  toggleLike(this);
                "
              >
                <i class="ph-bold ph-heart"></i><span>342</span>
              </button>
              <button
                class="act-btn reply"
                onclick="
                  event.stopPropagation();
                  openReply(
                    'Wani Aisyah',
                    'WA',
                    '#f59e0b',
                    'Building in public taught me more...',
                  );
                "
              >
                <i class="ph-bold ph-chat-circle"></i><span>76</span>
              </button>
              <button
                class="act-btn repost"
                onclick="
                  event.stopPropagation();
                  toggleRepost(this);
                "
              >
                <i class="ph-bold ph-repeat"></i><span>118</span>
              </button>
              <button
                class="act-btn share"
                onclick="
                  event.stopPropagation();
                  shareSpark();
                "
              >
                <i class="ph-bold ph-share-network"></i><span>29</span>
              </button>
              <button
                class="act-btn bookmark"
                onclick="
                  event.stopPropagation();
                  toggleBookmark(this);
                "
                style="margin-left: auto"
              >
                <i class="ph-bold ph-bookmark-simple"></i>
              </button>
            </div>
          </article>
        </div>
        <!-- end panel-2 -->
      </div>
      <!-- end feed-col -->

      <!-- ── RIGHT SIDEBAR ── -->
      <aside class="sidebar-right">
        <!-- skeleton -->
        <div class="sk-page-overlay" id="skRight">
          <div class="sk-widget">
            <div class="sk-pulse sk-widget-title"></div>
            <div class="sk-wtf-row">
              <div class="sk-pulse sk-circle sk-wtf-av"></div>
              <div class="sk-wtf-info">
                <div class="sk-pulse sk-wtf-name"></div>
                <div class="sk-pulse sk-wtf-sub"></div>
              </div>
              <div class="sk-pulse sk-wtf-btn"></div>
            </div>
            <div class="sk-wtf-row">
              <div class="sk-pulse sk-circle sk-wtf-av"></div>
              <div class="sk-wtf-info">
                <div class="sk-pulse sk-wtf-name"></div>
                <div class="sk-pulse sk-wtf-sub"></div>
              </div>
              <div class="sk-pulse sk-wtf-btn"></div>
            </div>
            <div class="sk-wtf-row">
              <div class="sk-pulse sk-circle sk-wtf-av"></div>
              <div class="sk-wtf-info">
                <div class="sk-pulse sk-wtf-name"></div>
                <div class="sk-pulse sk-wtf-sub"></div>
              </div>
              <div class="sk-pulse sk-wtf-btn"></div>
            </div>
          </div>
          <div class="sk-widget">
            <div class="sk-pulse sk-widget-title"></div>
            <div class="sk-trd-row">
              <div class="sk-pulse sk-trd-num"></div>
              <div class="sk-pulse sk-trd-tag"></div>
            </div>
            <div class="sk-trd-row">
              <div class="sk-pulse sk-trd-num"></div>
              <div class="sk-pulse sk-trd-tag"></div>
            </div>
            <div class="sk-trd-row">
              <div class="sk-pulse sk-trd-num"></div>
              <div class="sk-pulse sk-trd-tag"></div>
            </div>
            <div class="sk-trd-row">
              <div class="sk-pulse sk-trd-num"></div>
              <div class="sk-pulse sk-trd-tag"></div>
            </div>
          </div>
        </div>

        <!-- real -->
        <div class="real-content sk-hidden" id="realRight">
          <!-- Who to Follow -->
          <div class="widget">
            <p class="widget-title">Who to Follow</p>
            <div id="wtfList">
              <div
                class="sk-wtf-row"
                style="
                  display: flex;
                  align-items: center;
                  gap: 10px;
                  padding: 8px 0;
                "
              >
                <div
                  class="sk-pulse sk-circle sk-wtf-av"
                  style="
                    width: 36px;
                    height: 36px;
                    border-radius: 50%;
                    background: var(--bg-4);
                    flex-shrink: 0;
                  "
                ></div>
                <div class="sk-wtf-info" style="flex: 1">
                  <div
                    class="sk-pulse sk-wtf-name"
                    style="
                      height: 10px;
                      border-radius: 4px;
                      background: var(--bg-4);
                      width: 70%;
                      margin-bottom: 6px;
                    "
                  ></div>
                  <div
                    class="sk-pulse sk-wtf-sub"
                    style="
                      height: 8px;
                      border-radius: 4px;
                      background: var(--bg-4);
                      width: 50%;
                    "
                  ></div>
                </div>
                <div
                  class="sk-pulse sk-wtf-btn"
                  style="
                    height: 26px;
                    width: 56px;
                    border-radius: 100px;
                    background: var(--bg-4);
                  "
                ></div>
              </div>
              <div
                class="sk-wtf-row"
                style="
                  display: flex;
                  align-items: center;
                  gap: 10px;
                  padding: 8px 0;
                "
              >
                <div
                  class="sk-pulse sk-circle sk-wtf-av"
                  style="
                    width: 36px;
                    height: 36px;
                    border-radius: 50%;
                    background: var(--bg-4);
                    flex-shrink: 0;
                  "
                ></div>
                <div class="sk-wtf-info" style="flex: 1">
                  <div
                    class="sk-pulse sk-wtf-name"
                    style="
                      height: 10px;
                      border-radius: 4px;
                      background: var(--bg-4);
                      width: 70%;
                      margin-bottom: 6px;
                    "
                  ></div>
                  <div
                    class="sk-pulse sk-wtf-sub"
                    style="
                      height: 8px;
                      border-radius: 4px;
                      background: var(--bg-4);
                      width: 50%;
                    "
                  ></div>
                </div>
                <div
                  class="sk-pulse sk-wtf-btn"
                  style="
                    height: 26px;
                    width: 56px;
                    border-radius: 100px;
                    background: var(--bg-4);
                  "
                ></div>
              </div>
            </div>
          </div>

          <!-- Trending Topics -->
          <div class="widget">
            <p class="widget-title">Trending Topics</p>
            <div class="trd-row">
              <div class="trd-num hot">1</div>
              <div>
                <div class="trd-tag">#T1ERA 🔥</div>
                <div class="trd-cnt">1,204 Sparks</div>
              </div>
            </div>
            <div class="trd-row">
              <div class="trd-num hot">2</div>
              <div>
                <div class="trd-tag">#BuildInPublic 🔥</div>
                <div class="trd-cnt">847 Sparks</div>
              </div>
            </div>
            <div class="trd-row">
              <div class="trd-num">3</div>
              <div>
                <div class="trd-tag">#UIDesign</div>
                <div class="trd-cnt">562 Sparks</div>
              </div>
            </div>
            <div class="trd-row">
              <div class="trd-num">4</div>
              <div>
                <div class="trd-tag">#AI</div>
                <div class="trd-cnt">489 Sparks</div>
              </div>
            </div>
            <div class="trd-row">
              <div class="trd-num">5</div>
              <div>
                <div class="trd-tag">#DarkMode</div>
                <div class="trd-cnt">317 Sparks</div>
              </div>
            </div>
          </div>

          <!-- Active now -->
          <div class="widget">
            <p class="widget-title">Active Now</p>
            <div style="display: flex; flex-direction: column; gap: 10px">
              <div style="display: flex; align-items: center; gap: 10px">
                <div style="position: relative">
                  <div
                    class="wtf-av"
                    style="
                      background: linear-gradient(135deg, #c2185b, #8b5cf6);
                      width: 32px;
                      height: 32px;
                      font-size: 11px;
                    "
                  >
                    IB
                  </div>
                  <span
                    style="
                      position: absolute;
                      bottom: 0;
                      right: 0;
                      width: 9px;
                      height: 9px;
                      border-radius: 50%;
                      background: var(--green);
                      border: 2px solid var(--bg-card);
                    "
                  ></span>
                </div>
                <div>
                  <div class="wtf-name" style="font-size: 12px">
                    Ikram Basri
                  </div>
                  <div class="wtf-sub">Posting now</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 10px">
                <div style="position: relative">
                  <div
                    class="wtf-av"
                    style="
                      background: linear-gradient(135deg, #f59e0b, #f97316);
                      width: 32px;
                      height: 32px;
                      font-size: 11px;
                    "
                  >
                    WA
                  </div>
                  <span
                    style="
                      position: absolute;
                      bottom: 0;
                      right: 0;
                      width: 9px;
                      height: 9px;
                      border-radius: 50%;
                      background: var(--green);
                      border: 2px solid var(--bg-card);
                    "
                  ></span>
                </div>
                <div>
                  <div class="wtf-name" style="font-size: 12px">
                    Wani Aisyah
                  </div>
                  <div class="wtf-sub">Active 1m ago</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- end realRight -->
      </aside>
    </div>
    <!-- end page-wrap -->

    <!-- ═══════════════════════════
     MOBILE BOTTOM NAV
═══════════════════════════ -->
    <nav class="mob-nav">
      <a href="profile.html" class="mob-btn"
        ><i class="ph-bold ph-house"></i
      ></a>
      <button class="mob-btn active">
        <i class="ph-bold ph-lightning"></i>
      </button>
      <button class="mob-post" onclick="openCompose()">
        <i class="ph-bold ph-plus"></i>
      </button>
      <div class="mob-bell-wrap">
        <button class="mob-btn" onclick="toggleNotifPanel()">
          <i class="ph-bold ph-bell"></i>
        </button>
        <span class="mob-notif-badge" id="mobNotifBadge">0</span>
      </div>
      <a href="profile.html" class="mob-btn"
        ><i class="ph-bold ph-user-circle"></i
      ></a>
    </nav>

    <!-- ═══════════════════════════
     PROFILE POPUP
═══════════════════════════ -->
    <div
      class="popup-overlay"
      id="popupOverlay"
      onclick="if (event.target === this) closeProfile();"
    >
      <div class="popup-sheet">
        <div class="popup-handle"></div>
        <div class="popup-banner" id="popupBanner">
          <div class="popup-av" id="popupAv">U</div>
          <button
            class="popup-follow-btn"
            id="popupFollowBtn"
            onclick="togglePopupFollow(this)"
          >
            + Follow
          </button>
        </div>
        <div class="popup-info">
          <div class="popup-name" id="popupName">Name</div>
          <div class="popup-handle-text" id="popupHandle">@handle</div>
          <div class="popup-bio-text" id="popupBio"></div>
          <div class="popup-stats" id="popupStats"></div>
          <div
            class="badges-row"
            id="popupBadges"
            style="margin-top: 10px"
          ></div>
        </div>
        <div class="popup-actions">
          <a href="profile.html" class="popup-act-btn"
            ><i class="ph-bold ph-user-circle"></i> View Profile</a
          >
          <button
            class="popup-act-btn"
            onclick="
              closeProfile();
              openReply(_pName, _pAv, _pColor, '');
            "
          >
            <i class="ph-bold ph-paper-plane-tilt"></i> Message
          </button>
          <button class="popup-act-btn" onclick="closeProfile()">
            <i class="ph-bold ph-x"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- ═══════════════════════════
     REPLY MODAL
═══════════════════════════ -->
    <div
      class="reply-overlay"
      id="replyOverlay"
      onclick="if (event.target === this) closeReply();"
    >
      <div class="reply-sheet">
        <div class="reply-header">
          <span class="reply-title"
            ><i class="ph-bold ph-chat-circle"></i> REPLY SPARK</span
          >
          <button class="reply-close" onclick="closeReply()">
            <i class="ph-bold ph-x"></i>
          </button>
        </div>
        <!-- Original spark preview -->
        <div class="reply-orig">
          <div class="reply-orig-head">
            <div
              class="reply-orig-av"
              id="origAv"
              style="background: linear-gradient(135deg, #c2185b, #8b5cf6)"
            >
              U
            </div>
            <span class="reply-orig-author" id="origAuthor">Author</span>
            <span class="reply-orig-tag">· original spark</span>
          </div>
          <p class="reply-orig-text" id="origText"></p>
        </div>
        <!-- Compose reply -->
        <div class="reply-compose">
          <div class="reply-av">M</div>
          <textarea
            class="reply-textarea"
            id="replyTa"
            placeholder="Write your reply spark…"
            maxlength="500"
          ></textarea>
        </div>
        <div class="reply-footer">
          <div class="reply-media-row">
            <button
              class="media-btn"
              title="Image"
              style="width: 30px; height: 30px"
            >
              <i class="ph-bold ph-image"></i
              ><input type="file" accept="image/*" />
            </button>
            <button
              class="media-btn"
              title="GIF"
              style="width: 30px; height: 30px"
              onclick="alert('GIF picker coming soon')"
            >
              <i class="ph-bold ph-gif"></i>
            </button>
            <button
              class="media-btn"
              title="Emoji"
              style="width: 30px; height: 30px"
              onclick="openEmojiPicker('replyTa')"
            >
              <i class="ph-bold ph-smiley"></i>
            </button>
          </div>
          <button class="reply-submit" onclick="submitReply()">Reply ⚡</button>
        </div>
        <!-- Existing replies -->
        <div class="replies-list" id="repliesList">
          <div class="reply-item">
            <div
              class="ri-av"
              style="background: linear-gradient(135deg, #f59e0b, #f97316)"
            >
              WA
            </div>
            <div class="ri-body">
              <span class="ri-author">Wani Aisyah</span>
              <span class="ri-time">5m ago</span>
              <p class="ri-text">
                This is incredible! So proud of what you've built 🙌 Keep
                going!!
              </p>
            </div>
          </div>
          <div class="reply-item">
            <div
              class="ri-av"
              style="background: linear-gradient(135deg, #8b5cf6, #c2185b)"
            >
              DL
            </div>
            <div class="ri-body">
              <span class="ri-author">Danial L.</span>
              <span class="ri-time">12m ago</span>
              <p class="ri-text">
                Fire 🔥 Clean execution. When does the full app launch?
              </p>
            </div>
          </div>
          <div class="reply-item">
            <div
              class="ri-av"
              style="background: linear-gradient(135deg, #10b981, #0ea5e9)"
            >
              LF
            </div>
            <div class="ri-body">
              <span class="ri-author">Luqman Faiz</span>
              <span class="ri-time">28m ago</span>
              <p class="ri-text">
                The design is ✨ — especially the dark mode. Inspired to redo my
                own profile now.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      /* ══════════════════════════════════
   TABS
══════════════════════════════════ */
      function switchTab(i, btn) {
        document
          .querySelectorAll(".tab-btn")
          .forEach((b, j) => b.classList.toggle("active", j === i));
        document
          .querySelectorAll(".tab-panel")
          .forEach((p, j) => p.classList.toggle("active", j === i));
      }

      /* ══════════════════════════════════
   EMOJI PICKER
══════════════════════════════════ */
      const _EMOJIS = [
        "🪩",
        "🫧",
        "🌊",
        "🫠",
        "🥹",
        "🫶",
        "🦋",
        "🌸",
        "✨",
        "🔮",
        "🪄",
        "🫐",
        "🍄",
        "🦄",
        "🐉",
        "🌙",
        "⚡",
        "🔥",
        "💎",
        "🎯",
        "🫴",
        "🤌",
        "🫣",
        "🥷",
        "🌀",
        "🎪",
        "🪐",
        "🫀",
        "🧬",
        "🪬",
        "🛸",
        "🎭",
      ];
      let _emojiTargetId = "";

      function openEmojiPicker(targetId) {
        _emojiTargetId = targetId;
        const overlay = document.getElementById("emojiPickerOverlay");
        if (!overlay) return;
        const grid = document.getElementById("emojiPickerGrid");
        if (grid && grid.childElementCount === 0) {
          _EMOJIS.forEach((em) => {
            const btn = document.createElement("button");
            btn.textContent = em;
            btn.setAttribute("type", "button");
            btn.onclick = () => insertEmoji(em);
            grid.appendChild(btn);
          });
        }
        overlay.classList.add("open");
      }

      function closeEmojiPicker() {
        const overlay = document.getElementById("emojiPickerOverlay");
        if (overlay) overlay.classList.remove("open");
      }

      function insertEmoji(em) {
        const ta = document.getElementById(_emojiTargetId);
        if (!ta) {
          closeEmojiPicker();
          return;
        }
        const start = ta.selectionStart;
        const end = ta.selectionEnd;
        ta.value = ta.value.slice(0, start) + em + ta.value.slice(end);
        ta.selectionStart = ta.selectionEnd = start + em.length;
        ta.focus();
        // Trigger compose input update if it's the main compose box
        if (_emojiTargetId === "composeTa") onComposeInput(ta);
        closeEmojiPicker();
      }

      /* ══════════════════════════════════
   QUOTE FORMAT
══════════════════════════════════ */
      function insertQuoteFormat(targetId) {
        const ta = document.getElementById(targetId);
        if (!ta) return;
        const start = ta.selectionStart;
        const end = ta.selectionEnd;
        const selected = ta.value.slice(start, end);
        const quoteText = selected.length > 0 ? selected : "Your quote here";
        const insert = `\`\`\`quote\n${quoteText}\n\`\`\``;
        ta.value = ta.value.slice(0, start) + insert + ta.value.slice(end);
        ta.selectionStart = ta.selectionEnd = start + insert.length;
        ta.focus();
        if (targetId === "composeTa") onComposeInput(ta);
      }

      /* ══════════════════════════════════
   COMPOSE BOX
══════════════════════════════════ */
      function openCompose() {
        document.getElementById("composeBox").classList.add("open");
        document.getElementById("composeToggle").style.display = "none";
        setTimeout(() => document.getElementById("composeTa").focus(), 100);
      }
      function closeCompose() {
        document.getElementById("composeBox").classList.remove("open");
        document.getElementById("composeToggle").style.display = "flex";
        document.getElementById("composeTa").value = "";
        document.getElementById("charCount").textContent = "0 / 500";
        document.getElementById("charCount").className = "char-count";
        document.getElementById("submitBtn").disabled = true;
        document.getElementById("mediaStrip").innerHTML = "";
        // Clear any YouTube preview
        window._pendingYtId = null;
        const ytPrev = document.getElementById("ytComposePreview");
        if (ytPrev) ytPrev.remove();
      }
      function getYtId(text) {
        const m = text.match(
          /(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|shorts\/|v\/))([a-zA-Z0-9_-]{11})/,
        );
        return m ? m[1] : null;
      }

      function onComposeInput(ta) {
        const n = ta.value.length;
        const trim = ta.value.trim().length;
        const cc = document.getElementById("charCount");
        cc.textContent = `${n} / 500`;
        cc.className =
          "char-count" + (n >= 500 ? " over" : n >= 400 ? " warn" : "");
        document.getElementById("submitBtn").disabled = trim === 0;

        // Detect YouTube URL in compose text
        const ytId = getYtId(ta.value);
        const existing = document.getElementById("ytComposePreview");

        if (ytId) {
          window._pendingYtId = ytId;
          if (!existing) {
            // Insert preview above the compose footer
            const footer = document.querySelector(".compose-footer");
            const wrap = document.createElement("div");
            wrap.id = "ytComposePreview";
            wrap.className = "yt-preview-wrap";
            wrap.innerHTML = `
        <div class="yt-thumb-wrap" onclick="openYtModal('${ytId}')">
          <img src="https://i.ytimg.com/vi/${ytId}/hqdefault.jpg" alt="YouTube preview">
          <div class="yt-play-btn"><div class="yt-play-icon"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div></div>
        </div>
        <div class="yt-label">
          <div class="yt-logo"><svg viewBox="0 0 24 24"><path d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.5 3.5 12 3.5 12 3.5s-7.5 0-9.4.6A3 3 0 0 0 .5 6.2 31.4 31.4 0 0 0 0 12a31.4 31.4 0 0 0 .5 5.8 3 3 0 0 0 2.1 2.1c1.9.6 9.4.6 9.4.6s7.5 0 9.4-.6a3 3 0 0 0 2.1-2.1A31.4 31.4 0 0 0 24 12a31.4 31.4 0 0 0-.5-5.8zM9.7 15.5V8.5l6.3 3.5-6.3 3.5z"/></svg></div>
          <span class="yt-url-text">youtube.com/watch?v=${ytId}</span>
          <button class="yt-remove-btn" onclick="event.stopPropagation();removeYtPreview()"><i class="ph-bold ph-x"></i></button>
        </div>
      `;
            footer.parentNode.insertBefore(wrap, footer);
          }
        } else {
          window._pendingYtId = null;
          if (existing) existing.remove();
        }
      }

      function removeYtPreview() {
        window._pendingYtId = null;
        const el = document.getElementById("ytComposePreview");
        if (el) el.remove();
      }

      function openYtModal(videoId) {
        const wrap = document.getElementById("ytModalIframeWrap");
        wrap.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" allow="autoplay; encrypted-media; fullscreen" allowfullscreen></iframe>`;
        document.getElementById("ytModalOverlay").classList.add("open");
      }

      function closeYtModal() {
        document.getElementById("ytModalOverlay").classList.remove("open");
        document.getElementById("ytModalIframeWrap").innerHTML = "";
      }

      /* ══════════════════════════════════
   MEDIA ATTACH
══════════════════════════════════ */
      function attachMedia(input, type) {
        const strip = document.getElementById("mediaStrip");
        Array.from(input.files).forEach((file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const d = document.createElement("div");
            d.className = "media-thumb";
            const ext = file.name.split(".").pop().toUpperCase();
            let inner = "";
            if (type === "image")
              inner = `<img src="${e.target.result}" alt="">`;
            else if (type === "video")
              inner = `<video src="${e.target.result}" muted></video>`;
            else if (type === "audio")
              inner = `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-3);font-size:26px;"><i class="ph-bold ph-music-note"></i></div>`;
            else
              inner = `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-3);font-size:26px;"><i class="ph-bold ph-file-text"></i></div>`;
            d.innerHTML =
              inner +
              `<div class="media-type-tag">${type === "file" ? ext : type}</div><button class="media-thumb-remove" onclick="this.parentElement.remove()"><i class="ph-bold ph-x"></i></button>`;
            strip.appendChild(d);
          };
          reader.readAsDataURL(file);
        });
        document.getElementById("submitBtn").disabled = false;
        input.value = "";
      }

      function submitSpark() {
        // Delegated to Firebase module — window._submitSparkFn is set by the module script below
        if (typeof window._submitSparkFn === "function") {
          window._submitSparkFn();
        }
      }

      function toggleNotifPanel() {
        // Close settings if open
        document.getElementById("settingsPanel").classList.remove("open");
        const panel = document.getElementById("notifPanel");
        const backdrop = document.getElementById("notifBackdrop");
        const isOpen = panel.classList.toggle("open");
        backdrop.classList.toggle("open", isOpen);
        if (isOpen && typeof window._loadNotifsFn === "function")
          window._loadNotifsFn();
      }
      function closeNotifPanel() {
        document.getElementById("notifPanel").classList.remove("open");
        document.getElementById("notifBackdrop").classList.remove("open");
      }
      window.closeNotifPanel = closeNotifPanel;
      function toggleSettingsPanel() {
        // Close notif panel if open
        document.getElementById("notifPanel").classList.remove("open");
        const panel = document.getElementById("settingsPanel");
        const backdrop = document.getElementById("settingsBackdrop");
        const isOpen = panel.classList.toggle("open");
        backdrop.classList.toggle("open", isOpen);
      }
      function closeSettingsPanel() {
        document.getElementById("settingsPanel").classList.remove("open");
        document.getElementById("settingsBackdrop").classList.remove("open");
      }
      function markAllRead() {
        if (typeof window._markAllReadFn === "function")
          window._markAllReadFn();
      }

      function triggerFeedRefresh() {
        const btn = document.getElementById("feedRefreshBtn");
        const icon = document.getElementById("feedRefreshIcon");
        if (!btn) return;
        btn.classList.add("spinning");
        icon.style.animation = "spin .6s linear";
        setTimeout(() => {
          btn.classList.remove("spinning");
          icon.style.animation = "";
        }, 650);
        if (typeof window._startFeedFn === "function") window._startFeedFn();
      }

      /* ══════════════════════════════════
   LIKE / REPOST / SHARE / BOOKMARK
══════════════════════════════════ */
      function toggleLike(btn) {
        const card = btn.closest(".spark-card[data-spark-id]");

        // Demo cards (no data-spark-id) — local toggle only, no Firestore
        if (!card) {
          const on = btn.classList.toggle("liked");
          const icon = btn.querySelector("i");
          const cnt = btn.querySelector("span");
          const n = parseInt(cnt.textContent.replace(/[^0-9]/g, "")) || 0;
          icon.className = on ? "ph-fill ph-heart" : "ph-bold ph-heart";
          cnt.textContent = on ? n + 1 : Math.max(0, n - 1);
          return;
        }

        const sparkId = card.dataset.sparkId;
        const ownerUid = card.dataset.ownerUid;
        const sparkText =
          card.querySelector(".spark-text")?.textContent?.slice(0, 80) || "";

        // Optimistic UI update immediately
        const on = btn.classList.toggle("liked");
        const icon = btn.querySelector("i");
        const cnt = btn.querySelector("span");
        const n = parseInt(cnt.textContent.replace(/[^0-9]/g, "")) || 0;
        icon.className = on ? "ph-fill ph-heart" : "ph-bold ph-heart";
        cnt.textContent = on ? n + 1 : Math.max(0, n - 1);

        // Persist to Firestore via module
        if (typeof window._toggleLikeFn === "function") {
          window._toggleLikeFn({ liked: on, sparkId, ownerUid, sparkText });
        }
      }
      function toggleRepost(btn) {
        const on = btn.classList.toggle("reposted");
        const cnt = btn.querySelector("span");
        const n = parseInt(cnt.textContent.replace(/[^0-9]/g, "")) || 0;
        cnt.textContent = on ? n + 1 : Math.max(0, n - 1);
      }
      function toggleBookmark(btn) {
        const on = btn.classList.toggle("bookmarked");
        const icon = btn.querySelector("i");
        icon.className = on
          ? "ph-fill ph-bookmark-simple"
          : "ph-bold ph-bookmark-simple";
        if (on) btn.style.color = "var(--gold)";
        else btn.style.color = "";
        // Fire notification to post owner on bookmark (not on unbookmark)
        if (on && typeof window._sendNotifFn === "function") {
          const card = btn.closest(".spark-card[data-spark-id]");
          if (card) {
            const sparkId = card.dataset.sparkId;
            const ownerUid = card.dataset.ownerUid;
            const sparkText =
              card.querySelector(".spark-text")?.textContent?.slice(0, 80) ||
              "";
            window._sendNotifFn({
              type: "bookmark",
              ownerUid,
              sparkId,
              sparkText,
            });
          }
        }
      }
      function shareSpark() {
        if (navigator.share)
          navigator.share({ title: "T1ERA Spark", url: location.href });
        else
          navigator.clipboard
            .writeText(location.href)
            .then(() => alert("Link copied!"));
      }

      /* ══════════════════════════════════
   FOLLOW TOGGLES
══════════════════════════════════ */
      function toggleFollow(btn) {
        // pill buttons on demo cards (no data-spark-id on parent) — delegate to _followFn if ownerUid available
        const card = btn.closest(".spark-card");
        const ownerUid = card ? card.dataset.ownerUid : "";
        if (ownerUid && typeof window._followFn === "function") {
          window._followFn({ ownerUid, btn, type: "pill" });
        } else {
          // fallback UI-only for demo static cards
          const on = btn.classList.toggle("on");
          btn.innerHTML = on
            ? "Following"
            : '<i class="ph-bold ph-plus"></i> Follow';
        }
      }
      function toggleWtf(btn) {
        const on = btn.classList.toggle("on");
        btn.textContent = on ? "✓ Following" : "+ Follow";
      }
      function togglePopupFollow(btn) {
        const on = btn.classList.toggle("on");
        btn.textContent = on ? "✓ Following" : "+ Follow";
      }
      // Follow badge on feed cards — wired to Firestore
      function toggleFollowBadge(btn) {
        const card = btn.closest(".spark-card");
        const ownerUid = card ? card.dataset.ownerUid : "";
        if (ownerUid && typeof window._followFn === "function") {
          window._followFn({ ownerUid, btn, type: "badge" });
        }
      }

      /* ══════════════════════════════════
   PROFILE POPUP
══════════════════════════════════ */
      let _pName = "",
        _pAv = "",
        _pColor = "";
      function showProfile(
        name,
        handle,
        rank,
        following,
        followers,
        bio,
        color,
        verified,
      ) {
        _pName = name;
        _pAv = handle[0].toUpperCase();
        _pColor = color;
        document.getElementById("popupName").textContent = name;
        document.getElementById("popupHandle").textContent = "@" + handle;
        document.getElementById("popupBio").textContent = bio;
        document.getElementById("popupAv").textContent = name[0].toUpperCase();
        document.getElementById("popupAv").style.background =
          `linear-gradient(135deg,${color},#8b5cf6)`;
        document.getElementById("popupBanner").style.background =
          `linear-gradient(135deg,${color}66,rgba(139,92,246,.35))`;
        document.getElementById("popupStats").innerHTML = `
    <div class="popup-stat"><div class="pstat-num">${following}</div><div class="pstat-label">Following</div></div>
    <div class="popup-stat"><div class="pstat-num">${followers}</div><div class="pstat-label">Followers</div></div>
    <div class="popup-stat"><div class="pstat-num">${Math.floor(Math.random() * 80 + 5)}</div><div class="pstat-label">Sparks</div></div>
  `;
        document.getElementById("popupBadges").innerHTML =
          `<span class="badge rank">${rank}</span>` +
          (verified ? '<span class="badge verified">✓ Verified</span>' : "");
        // reset follow btn
        const fb = document.getElementById("popupFollowBtn");
        fb.classList.remove("on");
        fb.textContent = "+ Follow";
        if (handle === "ewm24k") {
          fb.classList.add("on");
          fb.textContent = "✓ Following";
        }
        document.getElementById("popupOverlay").classList.add("open");
      }
      function closeProfile() {
        document.getElementById("popupOverlay").classList.remove("open");
      }

      /* ══════════════════════════════════
   REPLY MODAL
══════════════════════════════════ */
      // Global reply context — set when reply sheet opens
      window._replyCtx = {};

      function openReply(
        author,
        initials,
        color,
        text,
        sparkId,
        ownerUid,
        ownerHandle,
        ownerPhoto,
      ) {
        // Store context for submitReply
        window._replyCtx = {
          sparkId: sparkId || "",
          ownerUid: ownerUid || "",
          ownerHandle: ownerHandle || "",
          author: author || "",
        };

        // Populate origAv — photo if available, else initial
        const origAvEl = document.getElementById("origAv");
        origAvEl.style.background = `linear-gradient(135deg,${color || "#c2185b"},#8b5cf6)`;
        if (ownerPhoto) {
          origAvEl.innerHTML = `<img src="${ownerPhoto}" referrerpolicy="no-referrer" alt="" onerror="this.parentElement.innerHTML='${initials || "?"}';this.parentElement.style.background='linear-gradient(135deg,${color || "#c2185b"},#8b5cf6)'">`;
        } else {
          origAvEl.textContent = initials || "?";
        }
        document.getElementById("origAuthor").textContent = author || "";
        document.getElementById("origText").textContent = text || "";

        // Auto-mention the post owner in the textarea
        const mention = ownerHandle ? `@${ownerHandle} ` : "";
        document.getElementById("replyTa").value = mention;

        document.getElementById("replyOverlay").classList.add("open");

        // Load real replies from Firestore if sparkId present
        if (sparkId && typeof window._loadRepliesFn === "function") {
          window._loadRepliesFn(sparkId);
        } else {
          // clear static demo replies for demo cards
          document.getElementById("repliesList").innerHTML = "";
        }

        setTimeout(() => {
          const ta = document.getElementById("replyTa");
          ta.focus();
          // Move cursor to end
          ta.selectionStart = ta.selectionEnd = ta.value.length;
        }, 320);
      }

      function closeReply() {
        document.getElementById("replyOverlay").classList.remove("open");
        window._replyCtx = {};
      }
      window.closeReply = closeReply; // expose to module script

      function submitReply() {
        const txt = document.getElementById("replyTa").value.trim();
        if (!txt) return;
        if (typeof window._submitReplyFn === "function") {
          window._submitReplyFn(txt);
        }
      }

      /* ══════════════════════════════════
   SPARK DETAIL (click card body)
══════════════════════════════════ */
      function openSparkDetail(card) {
        const nameEl = card.querySelector(".author-name");
        const textEl = card.querySelector(".spark-text");
        const avEl = card.querySelector(".spark-av");
        const handleEl = card.querySelector(".author-handle");
        if (!nameEl || !textEl) return;

        const sparkId = card.dataset.sparkId || "";
        const ownerUid = card.dataset.ownerUid || "";
        const ownerHandle = handleEl
          ? handleEl.textContent.trim().replace("@", "")
          : "";
        const initial = avEl ? avEl.textContent.trim() : "?";
        // Extract photo URL from spark-av img if present
        const avImg = avEl ? avEl.querySelector("img") : null;
        const ownerPhoto = avImg ? avImg.src : "";

        openReply(
          nameEl.textContent.trim(),
          initial,
          "#c2185b",
          textEl.textContent.trim().slice(0, 120),
          sparkId,
          ownerUid,
          ownerHandle,
          ownerPhoto,
        );
      }

      /* ══════════════════════════════════
   KEYBOARD
══════════════════════════════════ */
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeProfile();
          closeReply();
          closeCompose();
        }
      });

      /* ══════════════════════════════════
   TOAST
══════════════════════════════════ */
      function showToast(msg) {
        let t = document.getElementById("globalToast");
        if (!t) {
          t = document.createElement("div");
          t.id = "globalToast";
          t.className = "toast-msg";
          document.body.appendChild(t);
        }
        t.textContent = msg;
        t.classList.add("show");
        clearTimeout(t._hideTimer);
        t._hideTimer = setTimeout(() => {
          t.classList.remove("show");
        }, 2600);
      }
      window.showToast = showToast;

      /* ══════════════════════════════════
   REPLY FROM NOTIFICATION
══════════════════════════════════ */
      function replyFromNotif(
        sparkId,
        ownerUid,
        fromName,
        fromHandle,
        sparkText,
        notifId,
        ownerPhoto,
      ) {
        closeNotifPanel();
        openReply(
          fromName,
          fromName[0].toUpperCase(),
          "#8b5cf6",
          sparkText || "",
          sparkId,
          ownerUid,
          fromHandle,
          ownerPhoto || "",
        );
        // Store notifId so _submitReplyFn can mark it as read on successful reply
        if (window._replyCtx) window._replyCtx.notifId = notifId || "";
      }
      window.replyFromNotif = replyFromNotif;

      /* ══════════════════════════════════
   REPLY TO A REPLY ITEM (in-sheet)
══════════════════════════════════ */
      function replyToReplyItem(authorHandle, mentionedUid) {
        const ta = document.getElementById("replyTa");
        if (!ta) return;
        const mention = authorHandle ? `@${authorHandle} ` : "";
        ta.value = mention;
        ta.focus();
        ta.selectionStart = ta.selectionEnd = ta.value.length;
        ta.scrollIntoView({ behavior: "smooth", block: "center" });
        // Store mentionedUid so _submitReplyFn can notify the person you're replying to
        if (window._replyCtx) {
          window._replyCtx.mentionedUid = mentionedUid || "";
          window._replyCtx.mentionedHandle = authorHandle || "";
        }
      }
      window.replyToReplyItem = replyToReplyItem;

      /* ══════════════════════════════════
   FOLLOW BACK FROM NOTIFICATION
══════════════════════════════════ */
      function notifFollowBack(btn, targetUid, notifId) {
        if (!targetUid || typeof window._followFn !== "function") return;
        // Mark notification as read
        if (notifId && window._sparkUser?.uid) {
          const row = btn.closest(".notif-row");
          markOneRead(window._sparkUser.uid, notifId, row);
        }
        // Delegate to the same _followFn used everywhere else
        window._followFn({ ownerUid: targetUid, btn, type: "followback" });
      }
      window.notifFollowBack = notifFollowBack;

      // Internal markOneRead reference exposed so notifFollowBack can call it
      function markOneRead(uid, notifId, rowEl) {
        if (typeof window._markOneReadFn === "function")
          window._markOneReadFn(uid, notifId, rowEl);
      }
    </script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        where,
        getDocs,
        doc,
        getDoc,
        setDoc,
        deleteDoc,
        serverTimestamp,
        onSnapshot,
        updateDoc,
        writeBatch,
        increment,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // ── CONFIG ──
      const firebaseConfig = {
        apiKey: "AIzaSyBnt9mbb8LdMVeguSHUmS20L6uBHIfxwAs",
        authDomain: "t1era-v2.firebaseapp.com",
        projectId: "t1era-v2",
        storageBucket: "t1era-v2.firebasestorage.app",
        messagingSenderId: "279266491659",
        appId: "1:279266491659:web:28a03c7b7300fcb152b60e",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const DAILY_LIMIT = 3;
      const DEV_EMAIL = "ewm24k@gmail.com";
      const SPARKS_COL = "sparks";

      // ── AUTH STATE ──
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.replace("home.html");
          return;
        }

        window._sparkUser = user;

        // Load user profile for avatar / name
        try {
          const snap = await getDoc(doc(db, "users", user.uid));
          const d = snap.exists() ? snap.data() : {};
          window._sparkUserData = d;
          const photoURL = d.profilePicture?.url || user.photoURL || "";
          const initial = (d.fullName ||
            user.displayName ||
            user.email ||
            "U")[0].toUpperCase();
          applyComposeAvatar(photoURL, initial);
        } catch (e) {
          window._sparkUserData = {};
          applyComposeAvatar(
            "",
            (user.displayName || user.email || "U")[0].toUpperCase(),
          );
        }

        // Ensure point map fields exist (initializes to 0 if missing, no-op if already set)
        ensurePointMap(user.uid);

        // Check quota
        await checkQuota(user.uid);

        // Reveal real content, hide skeletons
        hidePageSkeleton();

        // Start live feed — loads existing posts and listens for new ones
        startFeed();

        // Auto-refresh feed every 35 seconds
        if (window._feedAutoRefreshTimer)
          clearInterval(window._feedAutoRefreshTimer);
        window._feedAutoRefreshTimer = setInterval(() => {
          if (typeof triggerFeedRefresh === "function") triggerFeedRefresh();
        }, 35000);

        // Start notification listener — live badge count
        startNotifListener(user.uid);

        // Load the set of UIDs the current user is following (used to hydrate follow buttons)
        await loadFollowingSet(user.uid);

        // Load real users into Who to Follow widget
        await loadWhoToFollow(user.uid);
      });

      // ── ENSURE point map fields exist on first load ──
      async function ensurePointMap(uid) {
        try {
          const snap = await getDoc(doc(db, "users", uid));
          const existing = snap.exists()
            ? snap.data().accountStatus?.point || snap.data().point || {}
            : {};
          const patch = {};

          // spark and reply: only initialize if missing (no reliable backfill source)
          if (existing.spark === undefined) patch["point.spark"] = 0;
          if (existing.reply === undefined) patch["point.reply"] = 0;
          if (existing.follower === undefined) patch["point.follower"] = 0;

          // like: ALWAYS recalculate from actual sparks/{sparkId}/likes/{uid} subcollection
          // This is the source of truth — fixes any dirty/wrong values from previous bugs
          try {
            const sparksSnap = await getDocs(
              query(collection(db, SPARKS_COL), where("tab", "==", "standard")),
            );
            let likeCount = 0;
            const likeChecks = sparksSnap.docs.map((sparkDoc) =>
              getDoc(doc(db, SPARKS_COL, sparkDoc.id, "likes", uid))
                .then((l) => {
                  if (l.exists()) likeCount++;
                })
                .catch(() => {}),
            );
            await Promise.all(likeChecks);
            patch["point.like"] = likeCount;
          } catch (le) {
            console.warn("like backfill error:", le);
            if (existing.like === undefined) patch["point.like"] = 0;
          }

          if (Object.keys(patch).length > 0) {
            await updateDoc(doc(db, "users", uid), patch);
          }
        } catch (e) {
          console.warn("ensurePointMap error:", e);
        }
      }

      // ── WHO TO FOLLOW — fetch real users from Firestore ──
      async function loadWhoToFollow(currentUid) {
        const container = document.getElementById("wtfList");
        if (!container) return;

        try {
          // Fetch all users
          const snap = await getDocs(collection(db, "users"));
          if (snap.empty) {
            container.innerHTML =
              '<div style="font-size:12px;color:var(--text-3);padding:8px 0;">No users found.</div>';
            return;
          }

          // Filter out current user, shuffle, pick up to 4
          const allUsers = [];
          snap.forEach((d) => {
            if (d.id !== currentUid) {
              allUsers.push({ uid: d.id, data: d.data() });
            }
          });

          // Fisher-Yates shuffle
          for (let i = allUsers.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [allUsers[i], allUsers[j]] = [allUsers[j], allUsers[i]];
          }

          const picked = allUsers.slice(0, 4);

          if (picked.length === 0) {
            container.innerHTML =
              '<div style="font-size:12px;color:var(--text-3);padding:8px 0;">No other users yet.</div>';
            return;
          }

          container.innerHTML = "";

          // Gradient palette for avatars without photos
          const gradients = [
            "linear-gradient(135deg,#8b5cf6,#c2185b)",
            "linear-gradient(135deg,#f59e0b,#f97316)",
            "linear-gradient(135deg,#10b981,#0ea5e9)",
            "linear-gradient(135deg,#ef4444,#f97316)",
          ];

          picked.forEach(({ uid, data: u }, idx) => {
            const name =
              u.fullName ||
              u.nickname ||
              u.email?.split("@")[0] ||
              "T1ERA User";
            const handle = u.nickname || u.email?.split("@")[0] || "user";
            const photo = u.profilePicture?.url || u.photoURL || "";
            const initial = name[0].toUpperCase();
            const grad = gradients[idx % gradients.length];

            const isFollowing =
              window._followingSet && window._followingSet.has(uid);

            const avHtml = photo
              ? `<img src="${photo}" referrerpolicy="no-referrer" style="width:100%;height:100%;object-fit:cover;border-radius:50%;display:block;" onerror="this.style.display='none';this.parentElement.textContent='${initial}'">`
              : initial;

            const row = document.createElement("div");
            row.className = "wtf-row";
            row.dataset.uid = uid;
            row.innerHTML = `
              <div class="wtf-av" style="background:${grad};overflow:hidden;">${avHtml}</div>
              <div class="wtf-info">
                <div class="wtf-name">${name}</div>
                <div class="wtf-sub">@${handle}</div>
              </div>
              <button class="wtf-btn${isFollowing ? " on" : ""}" onclick="window._wtfFollowClick(this,'${uid}')">${isFollowing ? "✓ Following" : "+ Follow"}</button>
            `;
            container.appendChild(row);
          });
        } catch (e) {
          console.warn("loadWhoToFollow error:", e);
          const container2 = document.getElementById("wtfList");
          if (container2)
            container2.innerHTML =
              '<div style="font-size:12px;color:var(--text-3);padding:8px 0;">Could not load.</div>';
        }
      }

      // ── WTF FOLLOW BUTTON CLICK — wired to same _followFn used by feed cards ──
      window._wtfFollowClick = function (btn, ownerUid) {
        if (!ownerUid || typeof window._followFn !== "function") {
          // Fallback UI-only toggle
          const on = btn.classList.toggle("on");
          btn.textContent = on ? "✓ Following" : "+ Follow";
          return;
        }
        window._followFn({ ownerUid, btn, type: "wtf" });
      };

      // ── EXPOSE startFeed to non-module scripts ──
      window._startFeedFn = startFeed;

      // ══════════════════════════════════════════════════════
      // FOLLOW MODULE
      // ══════════════════════════════════════════════════════

      // In-memory set of UIDs the current user follows — loaded once on auth
      window._followingSet = new Set();

      // Load who the current user is following into memory
      // Reads from /follows where followerId == uid (matches Firestore rules)
      async function loadFollowingSet(uid) {
        try {
          const snap = await getDocs(
            query(collection(db, "follows"), where("followerId", "==", uid)),
          );
          window._followingSet = new Set(
            snap.docs.map((d) => d.data().followedId),
          );
        } catch (e) {
          console.warn("loadFollowingSet error:", e.code, e.message);
          window._followingSet = new Set();
        }
      }

      // Core follow/unfollow toggle — called by both pill and badge buttons
      window._followFn = async function ({ ownerUid, btn, type }) {
        const user = window._sparkUser;
        if (!user || !ownerUid || ownerUid === user.uid) return;

        const isFollowing = window._followingSet.has(ownerUid);
        const willFollow = !isFollowing;

        // ── Show loading state immediately on the clicked button ──
        btn.disabled = true;
        if (type === "badge") {
          btn.classList.add("loading");
          btn.innerHTML =
            '<i class="ph-bold ph-circle-dashed" style="animation:follow-pulse .8s ease infinite"></i> …';
        } else if (type === "followback") {
          btn.style.opacity = "0.6";
          btn.style.pointerEvents = "none";
          btn.innerHTML =
            '<i class="ph-bold ph-circle-dashed" style="animation:follow-pulse .8s ease infinite"></i> …';
        } else {
          btn.classList.add("loading");
          btn.innerHTML =
            '<i class="ph-bold ph-circle-dashed" style="animation:follow-pulse .8s ease infinite"></i> …';
        }

        // ── Update in-memory set immediately (optimistic) ──
        if (willFollow) {
          window._followingSet.add(ownerUid);
        } else {
          window._followingSet.delete(ownerUid);
        }

        // ── Persist to Firestore ──
        const ud = window._sparkUserData || {};
        const fromName =
          ud.fullName ||
          user.displayName ||
          user.email?.split("@")[0] ||
          "Someone";
        const fromHandle = ud.nickname || user.email?.split("@")[0] || "user";
        const fromPhoto = ud.profilePicture?.url || user.photoURL || "";

        try {
          if (willFollow) {
            // ── Write to /follows/{myUid}_{targetUid} — matches rules: create if followerId == auth.uid ──
            const followDocId = `${user.uid}_${ownerUid}`;
            await setDoc(doc(db, "follows", followDocId), {
              followerId: user.uid,
              followedId: ownerUid,
              fromName,
              fromHandle,
              fromPhoto,
              createdAt: serverTimestamp(),
            });

            // ── Send follow notification to target — rules allow create if isSignedIn() ──
            const notifId = `follow_${user.uid}_${ownerUid}`;
            try {
              await setDoc(
                doc(db, "users", ownerUid, "notifications", notifId),
                {
                  type: "follow",
                  fromUid: user.uid,
                  fromName,
                  fromHandle,
                  fromPhoto,
                  sparkId: "",
                  sparkText: "",
                  message: `<strong>${fromName}</strong> started following you`,
                  read: false,
                  createdAt: serverTimestamp(),
                },
              );
            } catch (ne) {
              console.warn("follow notif error:", ne.code, ne.message);
            }

            // ── Award +25 XP to followed user (increment point.follower by 1; profile.html multiplies by 25) ──
            try {
              await updateDoc(doc(db, "users", ownerUid), {
                "point.follower": increment(1),
              });
            } catch (fe) {
              console.warn("follower XP award error:", fe.code, fe.message);
            }

            // ── Log to YOUR activity history — rules allow write if isOwner(userId) ──
            try {
              await addDoc(
                collection(db, "users", user.uid, "activityHistory"),
                {
                  type: "follow",
                  icon: "ph-user-plus",
                  iconColor: "var(--green)",
                  bgClass: "green-bg",
                  text: `<strong>Followed</strong> @${fromHandle}`,
                  createdAt: serverTimestamp(),
                },
              );
            } catch (ae) {
              console.warn("follow activity log error:", ae.code, ae.message);
            }

            // Toast confirmation
            if (typeof window.showToast === "function")
              window.showToast("Now following! 🤝");
          } else {
            // ── Unfollow: delete /follows/{myUid}_{targetUid} — rules allow delete if followerId == auth.uid ──
            const followDocId = `${user.uid}_${ownerUid}`;
            await deleteDoc(doc(db, "follows", followDocId));

            // Toast confirmation
            if (typeof window.showToast === "function")
              window.showToast("Unfollowed");
          }

          // ── Settle button into final state after Firestore confirms ──
          btn.disabled = false;
          if (type === "badge") {
            btn.classList.remove("loading");
            if (willFollow) {
              btn.classList.add("following");
              btn.innerHTML = '<i class="ph-bold ph-check"></i> Following';
            } else {
              btn.classList.remove("following");
              btn.innerHTML = '<i class="ph-bold ph-user-plus"></i> Follow';
            }
          } else if (type === "followback") {
            btn.style.opacity = "";
            btn.style.pointerEvents = "";
            if (willFollow) {
              btn.innerHTML = '<i class="ph-bold ph-check"></i> Following';
              btn.style.borderColor = "rgba(16,185,129,.4)";
              btn.style.color = "var(--green)";
              btn.style.background = "rgba(16,185,129,.08)";
            } else {
              btn.innerHTML =
                '<i class="ph-bold ph-user-plus"></i> Follow Back';
              btn.style.borderColor = "";
              btn.style.color = "";
              btn.style.background = "";
            }
          } else {
            btn.classList.remove("loading");
            if (willFollow) {
              btn.classList.add("on");
              btn.innerHTML = "Following";
            } else {
              btn.classList.remove("on");
              btn.innerHTML = '<i class="ph-bold ph-plus"></i> Follow';
            }
          }

          // ── Sync all other buttons on page for the same user ──
          document.querySelectorAll(".spark-card").forEach((card) => {
            if (card.dataset.ownerUid !== ownerUid) return;
            card.querySelectorAll(".badge.follow-badge").forEach((b) => {
              if (b === btn) return;
              if (willFollow) {
                b.classList.add("following");
                b.innerHTML = '<i class="ph-bold ph-check"></i> Following';
              } else {
                b.classList.remove("following");
                b.innerHTML = '<i class="ph-bold ph-user-plus"></i> Follow';
              }
            });
            card.querySelectorAll(".follow-pill").forEach((b) => {
              if (b === btn) return;
              if (willFollow) {
                b.classList.add("on");
                b.innerHTML = "Following";
              } else {
                b.classList.remove("on");
                b.innerHTML = '<i class="ph-bold ph-plus"></i> Follow';
              }
            });
          });
        } catch (e) {
          console.error("_followFn Firestore error:", e.code, e.message);
          // Rollback in-memory set
          if (willFollow) {
            window._followingSet.delete(ownerUid);
          } else {
            window._followingSet.add(ownerUid);
          }
          // Rollback button UI
          btn.disabled = false;
          if (type === "badge") {
            btn.classList.remove("loading");
            if (!willFollow) {
              btn.classList.add("following");
              btn.innerHTML = '<i class="ph-bold ph-check"></i> Following';
            } else {
              btn.classList.remove("following");
              btn.innerHTML = '<i class="ph-bold ph-user-plus"></i> Follow';
            }
          } else if (type === "followback") {
            btn.style.opacity = "";
            btn.style.pointerEvents = "";
            if (!willFollow) {
              btn.innerHTML = '<i class="ph-bold ph-check"></i> Following';
              btn.style.borderColor = "rgba(16,185,129,.4)";
              btn.style.color = "var(--green)";
              btn.style.background = "rgba(16,185,129,.08)";
            } else {
              btn.innerHTML =
                '<i class="ph-bold ph-user-plus"></i> Follow Back';
              btn.style.borderColor = "";
              btn.style.color = "";
              btn.style.background = "";
            }
          } else {
            btn.classList.remove("loading");
            if (!willFollow) {
              btn.classList.add("on");
              btn.innerHTML = "Following";
            } else {
              btn.classList.remove("on");
              btn.innerHTML = '<i class="ph-bold ph-plus"></i> Follow';
            }
          }
          if (typeof window.showToast === "function")
            window.showToast("Action failed — try again");
        }
      };

      // ── LISTEN for current user's unread notifications ──
      let _notifUnsub = null;

      function startNotifListener(uid) {
        if (_notifUnsub) _notifUnsub();
        const notifCol = collection(db, "users", uid, "notifications");
        _notifUnsub = onSnapshot(
          query(notifCol, where("read", "==", false)),
          (snap) => {
            const count = snap.size;
            const label = count > 99 ? "99+" : String(count);
            const visible = count > 0;
            // Desktop badge
            const badge = document.getElementById("notifBadge");
            if (badge) {
              badge.textContent = label;
              badge.classList.toggle("visible", visible);
            }
            // Mobile badge
            const mobBadge = document.getElementById("mobNotifBadge");
            if (mobBadge) {
              mobBadge.textContent = label;
              mobBadge.classList.toggle("visible", visible);
            }
            // If the panel is currently open, refresh its list live so new follow notifs appear instantly
            const panel = document.getElementById("notifPanel");
            if (
              panel &&
              panel.classList.contains("open") &&
              typeof window._loadNotifsFn === "function"
            ) {
              window._loadNotifsFn();
            }
          },
          (err) => console.error("notif listener:", err),
        );
      }

      // ── SEND a notification to another user ──
      window._sendNotifFn = async function ({
        type,
        ownerUid,
        sparkId,
        sparkText,
        extraMsg,
      }) {
        const currentUser = window._sparkUser;
        if (!currentUser || !ownerUid) return;
        // Never notify yourself
        if (ownerUid === currentUser.uid) return;

        const ud = window._sparkUserData || {};
        const fromName =
          ud.fullName ||
          currentUser.displayName ||
          currentUser.email?.split("@")[0] ||
          "Someone";
        const fromPhoto = ud.profilePicture?.url || currentUser.photoURL || "";

        const messages = {
          like: `<strong>${fromName}</strong> liked your Spark`,
          bookmark: `<strong>${fromName}</strong> bookmarked your Spark`,
          reply: `<strong>${fromName}</strong> replied to your Spark`,
        };

        try {
          await addDoc(collection(db, "users", ownerUid, "notifications"), {
            type,
            fromUid: currentUser.uid,
            fromName,
            fromPhoto,
            sparkId: sparkId || "",
            sparkText: sparkText || "",
            message:
              extraMsg ||
              messages[type] ||
              `<strong>${fromName}</strong> interacted with your Spark`,
            read: false,
            createdAt: serverTimestamp(),
          });
        } catch (e) {
          console.error("sendNotif error:", e.code, e.message);
        }
      };

      // ── TOGGLE LIKE — write to Firestore ──
      window._toggleLikeFn = async function ({
        liked,
        sparkId,
        ownerUid,
        sparkText,
      }) {
        const user = window._sparkUser;
        if (!user || !sparkId) return;

        // likes subcollection: sparks/{sparkId}/likes/{uid}
        const likeRef = doc(db, "sparks", sparkId, "likes", user.uid);

        // Deterministic notification ID so we can delete it on unlike
        // Pattern: like_{likerUid}_{sparkId}
        const notifId = `like_${user.uid}_${sparkId}`;
        const notifRef =
          ownerUid && ownerUid !== user.uid
            ? doc(db, "users", ownerUid, "notifications", notifId)
            : null;

        try {
          if (liked) {
            // 1. Record the like
            await setDoc(likeRef, {
              uid: user.uid,
              createdAt: serverTimestamp(),
            });

            // 2. Award +10 XP only if liking someone else's post (not own post)
            if (ownerUid !== user.uid) {
              try {
                await updateDoc(doc(db, "users", user.uid), {
                  "point.like": increment(1),
                });
              } catch (xpe) {
                console.warn("XP like award error:", xpe);
              }
            }

            // 3. Write like notification with deterministic ID (overwrites if already exists)
            if (notifRef) {
              const ud = window._sparkUserData || {};
              const fromName =
                ud.fullName ||
                user.displayName ||
                user.email?.split("@")[0] ||
                "Someone";
              const fromPhoto = ud.profilePicture?.url || user.photoURL || "";
              try {
                await setDoc(notifRef, {
                  type: "like",
                  fromUid: user.uid,
                  fromName,
                  fromPhoto,
                  sparkId: sparkId || "",
                  sparkText: sparkText || "",
                  message: `<strong>${fromName}</strong> liked your Spark`,
                  read: false,
                  createdAt: serverTimestamp(),
                });
              } catch (ne) {
                console.warn("like notif error:", ne);
              }
            }
          } else {
            // 1. Remove the like record
            await deleteDoc(likeRef);

            // 2. Deduct XP only if unliking someone else's post (never go below 0)
            if (ownerUid !== user.uid) {
              try {
                const userSnap = await getDoc(doc(db, "users", user.uid));
                const currentLike = userSnap.exists()
                  ? userSnap.data().point?.like || 0
                  : 0;
                await updateDoc(doc(db, "users", user.uid), {
                  "point.like": increment(currentLike > 0 ? -1 : 0),
                });
              } catch (xpe) {
                console.warn("XP unlike deduct error:", xpe);
              }
            }

            // 3. Delete the like notification from post owner (if it exists and unread)
            if (notifRef) {
              try {
                const notifSnap = await getDoc(notifRef);
                if (notifSnap.exists() && !notifSnap.data().read) {
                  await deleteDoc(notifRef);
                }
              } catch (ne) {
                console.warn("unlike notif cleanup error:", ne);
              }
            }
          }
        } catch (e) {
          console.error("toggleLike Firestore error:", e.code, e.message);
        }
      };

      // ── LOAD notifications into the panel ──
      window._loadNotifsFn = async function () {
        const uid = window._sparkUser?.uid;
        if (!uid) return;
        const list = document.getElementById("notifList");
        const empty = document.getElementById("notifEmpty");
        if (!list) return;

        try {
          const snap = await getDocs(
            collection(db, "users", uid, "notifications"),
          );
          if (snap.empty) {
            if (empty) empty.style.display = "flex";
            list.innerHTML = "";
            list.appendChild(empty);
            return;
          }

          // Sort newest first client-side
          const docs = [];
          snap.forEach((d) => docs.push({ id: d.id, data: d.data() }));
          docs.sort((a, b) => {
            const ta = a.data.createdAt?.toMillis?.() || 0;
            const tb = b.data.createdAt?.toMillis?.() || 0;
            return tb - ta;
          });

          // Bucket by type — followers is a separate bucket from follow
          const buckets = {
            like: [],
            bookmark: [],
            reply: [],
            follow: [],
            message: [],
          };
          docs.forEach((d) => {
            const t = d.data.type || "message";
            if (buckets[t] !== undefined) buckets[t].push(d);
            else buckets.message.push(d);
          });

          // Clear list
          list.innerHTML = "";

          const sectionMeta = [
            {
              key: "follow",
              label: "Followers",
              icon: "ph-user-plus",
              cls: "follow",
            },
            { key: "like", label: "Likes", icon: "ph-heart", cls: "like" },
            {
              key: "reply",
              label: "Replies & Mentions",
              icon: "ph-chat-circle",
              cls: "reply",
            },
            {
              key: "bookmark",
              label: "Bookmarks",
              icon: "ph-bookmark-simple",
              cls: "bookmark",
            },
            {
              key: "message",
              label: "System",
              icon: "ph-bell",
              cls: "message",
            },
          ];

          let hasAny = false;

          sectionMeta.forEach(({ key, label, icon, cls }) => {
            const items = buckets[key];

            // Skip empty sections entirely — no clutter
            if (!items || items.length === 0) return;

            hasAny = true;

            // Check if any item in this section is unread
            const hasUnread = items.some(({ data: d }) => !d.read);
            const unreadCount = items.filter(({ data: d }) => !d.read).length;

            // ── Section header (clickable accordion toggle) ──
            const header = document.createElement("div");
            header.className =
              "notif-section-header" + (hasUnread ? " has-unread" : "");
            header.innerHTML = `
        <span class="notif-section-dot"></span>
        <span class="notif-section-label"><i class="ph-bold ${icon}" style="margin-right:5px;font-size:10px"></i>${label}</span>
        <span class="notif-section-count ${hasUnread ? "has-new" : ""}">${hasUnread ? unreadCount + " new" : items.length}</span>
        <i class="ph-bold ph-caret-down notif-section-chevron" style="${hasUnread ? "transform:rotate(180deg)" : ""}"></i>
      `;

            // ── Section body (collapsible) ──
            const body = document.createElement("div");
            body.className = "notif-section-body" + (hasUnread ? " open" : "");

            // Toggle on header click
            header.addEventListener("click", () => {
              const isOpen = body.classList.toggle("open");
              const chevron = header.querySelector(".notif-section-chevron");
              if (chevron)
                chevron.style.transform = isOpen
                  ? "rotate(180deg)"
                  : "rotate(0deg)";
            });

            // ── Build notification rows ──
            items.forEach(({ id, data: d }) => {
              const avInner = d.fromPhoto
                ? `<img src="${d.fromPhoto}" referrerpolicy="no-referrer" onerror="this.style.display='none'">`
                : (d.fromName?.[0] || "?").toUpperCase();

              const ts = d.createdAt?.toDate?.();
              const timeStr = ts
                ? ts.toLocaleString("en-MY", {
                    day: "numeric",
                    month: "short",
                    hour: "2-digit",
                    minute: "2-digit",
                  })
                : "Just now";

              const row = document.createElement("div");
              row.className = "notif-row" + (d.read ? "" : " unread");
              row.dataset.notifId = id;

              const replyBtn =
                key === "reply" && d.sparkId
                  ? `<button class="notif-reply-btn" onclick="event.stopPropagation();replyFromNotif('${d.sparkId}','${d.fromUid || ""}','${(d.fromName || "").replace(/'/g, "\\'")}','${(d.fromHandle || d.fromName || "").replace(/'/g, "\\'")}','${(d.sparkText || "").replace(/'/g, "\\'").slice(0, 60)}','${id}','${(d.fromPhoto || "").replace(/'/g, "\\'")}')"><i class="ph-bold ph-chat-circle"></i> Reply</button>`
                  : "";

              const alreadyFollowingBack =
                window._followingSet &&
                window._followingSet.has(d.fromUid || "");
              const followBackBtn =
                key === "follow" &&
                d.fromUid &&
                d.fromUid !== window._sparkUser?.uid
                  ? `<button class="notif-reply-btn notif-follow-back-btn" data-target-uid="${d.fromUid}" style="${alreadyFollowingBack ? "border-color:rgba(16,185,129,.4);color:var(--green);background:rgba(16,185,129,.08)" : ""}" onclick="event.stopPropagation();notifFollowBack(this,'${d.fromUid}','${id}')"><i class="ph-bold ${alreadyFollowingBack ? "ph-check" : "ph-user-plus"}"></i> ${alreadyFollowingBack ? "Following" : "Follow Back"}</button>`
                  : "";

              row.innerHTML = `
          <div class="notif-av">${avInner}</div>
          <div class="notif-body">
            <div class="notif-text">${d.message || `<strong>${d.fromName}</strong> interacted with your account`}</div>
            ${d.sparkText ? `<div class="notif-sub">"${d.sparkText}"</div>` : ""}
            <div class="notif-time">${timeStr}</div>
            ${replyBtn}${followBackBtn}
          </div>
          <div class="notif-type-icon ${cls}"><i class="ph-bold ${icon}"></i></div>
        `;

              row.addEventListener("click", () => {
                markOneRead(uid, id, row);
                // Update unread count in header after marking read
                const stillUnread =
                  body.querySelectorAll(".notif-row.unread").length - 1;
                const countEl = header.querySelector(".notif-section-count");
                if (stillUnread <= 0) {
                  header.classList.remove("has-unread");
                  if (countEl) {
                    countEl.classList.remove("has-new");
                    countEl.textContent = items.length;
                  }
                  const dot = header.querySelector(".notif-section-dot");
                  if (dot) dot.style.display = "none";
                } else {
                  if (countEl) countEl.textContent = stillUnread + " new";
                }
              });

              body.appendChild(row);
            });

            list.appendChild(header);
            list.appendChild(body);
          });

          if (empty) empty.style.display = hasAny ? "none" : "flex";
        } catch (e) {
          console.error("loadNotifs error:", e);
        }
      };

      // ── MARK ONE notification as read ──
      async function markOneRead(uid, notifId, rowEl) {
        try {
          await updateDoc(doc(db, "users", uid, "notifications", notifId), {
            read: true,
          });
          if (rowEl) rowEl.classList.remove("unread");
        } catch (e) {
          console.error("markOneRead:", e);
        }
      }
      window._markOneReadFn = markOneRead;

      // ── MARK ALL notifications as read ──
      // ══════════════════════════════════════════════════════
      // REPLIES MODULE
      // ══════════════════════════════════════════════════════

      // Load replies for a spark into the reply sheet
      window._loadRepliesFn = async function (sparkId) {
        const list = document.getElementById("repliesList");
        if (!list) return;

        // Show shimmer skeleton
        list.innerHTML = `
    <div class="reply-item" style="opacity:.5">
      <div class="ri-av" style="background:var(--bg-4);position:relative;overflow:hidden"><div style="position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);animation:sk-shimmer 1.4s infinite"></div></div>
      <div class="ri-body" style="flex:1">
        <div style="height:9px;width:40%;border-radius:4px;background:var(--bg-4);margin-bottom:7px;position:relative;overflow:hidden"><div style="position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);animation:sk-shimmer 1.4s infinite"></div></div>
        <div style="height:11px;width:85%;border-radius:4px;background:var(--bg-4);position:relative;overflow:hidden"><div style="position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);animation:sk-shimmer 1.4s infinite"></div></div>
      </div>
    </div>`;

        try {
          const snap = await getDocs(
            collection(db, "sparks", sparkId, "comments"),
          );
          list.innerHTML = "";

          if (snap.empty) {
            list.innerHTML =
              '<div style="padding:16px 18px;font-size:12px;color:var(--text-3);text-align:center">No replies yet — be the first!</div>';
            return;
          }

          const replies = [];
          snap.forEach((d) => replies.push({ id: d.id, data: d.data() }));
          replies.sort((a, b) => {
            const ta = a.data.createdAt?.toMillis?.() || 0;
            const tb = b.data.createdAt?.toMillis?.() || 0;
            return tb - ta; // newest first
          });

          replies.forEach(({ id, data: r }) => {
            const initial = (r.authorName || "U")[0].toUpperCase();
            const photo = r.authorPhoto || "";
            const avInner = photo
              ? `<img src="${photo}" referrerpolicy="no-referrer" style="width:100%;height:100%;object-fit:cover;border-radius:50%" onerror="this.style.display='none'">`
              : initial;
            const timeStr = r.createdAt ? timeAgo(r.createdAt) : "just now";

            const item = document.createElement("div");
            item.className = "reply-item";
            item.innerHTML = `
        <div class="ri-av" style="background:linear-gradient(135deg,var(--pink),var(--purple))">${avInner}</div>
        <div class="ri-body">
          <span class="ri-author">${r.authorName || "User"}</span>
          <span class="ri-time">${timeStr}</span>
          <p class="ri-text">${r.text || ""}</p>
          <button class="ri-reply-btn" onclick="replyToReplyItem('${(r.authorHandle || r.authorName || "").replace(/'/g, "\\'")}','${(r.uid || "").replace(/'/g, "\\'")}')"><i class="ph-bold ph-arrow-bend-up-left"></i> Reply</button>
        </div>
      `;
            list.appendChild(item);
          });
        } catch (e) {
          console.error("loadReplies error:", e.code, e.message);
          list.innerHTML =
            '<div style="padding:16px 18px;font-size:12px;color:var(--text-3);text-align:center">Could not load replies.</div>';
        }
      };

      // Submit a reply
      window._submitReplyFn = async function (txt) {
        const user = window._sparkUser;
        if (!user || !txt) return;

        const ctx = window._replyCtx || {};
        const {
          sparkId,
          ownerUid,
          ownerHandle,
          author,
          mentionedUid,
          mentionedHandle,
          notifId,
        } = ctx;

        const ud = window._sparkUserData || {};
        const authorName =
          ud.fullName ||
          user.displayName ||
          user.email?.split("@")[0] ||
          "User";
        const authorPhoto = ud.profilePicture?.url || user.photoURL || "";
        const handle = ud.nickname || user.email?.split("@")[0] || "user";

        // Disable submit btn to prevent double submit
        const submitBtn = document.querySelector(".reply-submit");
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Sending…";
        }

        if (!sparkId) {
          // Demo card — just show optimistic item and close
          const list = document.getElementById("repliesList");
          const item = document.createElement("div");
          item.className = "reply-item fu";
          item.innerHTML = `
      <div class="ri-av" style="background:linear-gradient(135deg,var(--pink),var(--purple))">${authorName[0].toUpperCase()}</div>
      <div class="ri-body">
        <span class="ri-author">${authorName}</span>
        <span class="ri-time">just now</span>
        <p class="ri-text">${txt}</p>
      </div>`;
          if (list) list.insertBefore(item, list.firstChild);
          document.getElementById("replyTa").value = "";
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Reply ⚡";
          }
          setTimeout(() => {
            if (typeof window.closeReply === "function") window.closeReply();
          }, 300);
          return;
        }

        try {
          // 1. Write reply to sparks/{sparkId}/comments subcollection
          const replyData = {
            uid: user.uid,
            authorName,
            authorHandle: handle,
            authorPhoto,
            text: txt,
            sparkId,
            createdAt: serverTimestamp(),
          };
          await addDoc(
            collection(db, "sparks", sparkId, "comments"),
            replyData,
          );

          // 2. Fetch updated reply count for this spark and update feed card counter
          const repliesSnap = await getDocs(
            collection(db, "sparks", sparkId, "comments"),
          );
          const newCount = repliesSnap.size;
          const countEl = document.getElementById("replycount-" + sparkId);
          if (countEl) countEl.textContent = newCount;

          // 3. Send notification to post owner (skip self-replies)
          if (ownerUid && ownerUid !== user.uid) {
            try {
              await addDoc(collection(db, "users", ownerUid, "notifications"), {
                type: "reply",
                fromUid: user.uid,
                fromName: authorName,
                fromHandle: handle,
                fromPhoto: authorPhoto,
                sparkId,
                sparkText: txt.slice(0, 80),
                message: `<strong>${authorName}</strong> replied to your Spark`,
                read: false,
                createdAt: serverTimestamp(),
              });
            } catch (ne) {
              console.warn("reply notif error:", ne.code, ne.message);
            }
          }

          // 3b. Send notification to the @mentioned replier (when replying to someone's reply)
          //     Only fires if mentionedUid is set, is not yourself, and is not the spark owner (already notified above)
          if (
            mentionedUid &&
            mentionedUid !== user.uid &&
            mentionedUid !== ownerUid
          ) {
            try {
              await addDoc(
                collection(db, "users", mentionedUid, "notifications"),
                {
                  type: "reply",
                  fromUid: user.uid,
                  fromName: authorName,
                  fromHandle: handle,
                  fromPhoto: authorPhoto,
                  sparkId,
                  sparkText: txt.slice(0, 80),
                  message: `<strong>${authorName}</strong> replied to your comment`,
                  read: false,
                  createdAt: serverTimestamp(),
                },
              );
            } catch (me) {
              console.warn("mention notif error:", me.code, me.message);
            }
          }

          // 4. Log to replier's activity history
          try {
            await addDoc(collection(db, "users", user.uid, "activityHistory"), {
              type: "reply",
              icon: "ph-chat-circle",
              iconColor: "var(--purple)",
              bgClass: "purple-bg",
              text: `<strong>Replied</strong> to @${ownerHandle || author}: "${txt.slice(0, 50)}${txt.length > 50 ? "…" : ""}"`,
              createdAt: serverTimestamp(),
            });
          } catch (ae) {
            console.warn("activity log error:", ae);
          }

          // 4b. Award +40 XP for replying to a spark (increment count by 1; profile.html multiplies by 40)
          try {
            await updateDoc(doc(db, "users", user.uid), {
              "point.reply": increment(1),
            });
          } catch (xpe) {
            console.warn("XP reply award error:", xpe);
          }

          // 5. Clear textarea — DB write confirmed, show toast and close immediately
          document.getElementById("replyTa").value = "";
          // Mark the source notification as read if this reply came from the notif panel
          if (notifId && window._sparkUser?.uid) {
            markOneRead(
              window._sparkUser.uid,
              notifId,
              document.querySelector(`.notif-row[data-notif-id="${notifId}"]`),
            );
          }
          if (typeof window.showToast === "function")
            window.showToast("Reply posted ⚡");
          if (typeof window.closeReply === "function") window.closeReply();

          // 6. Reload replies in the sheet (fire-and-forget, panel may already be closing)
          window._loadRepliesFn(sparkId);
        } catch (e) {
          console.error("submitReply error:", e.code, e.message);
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Reply ⚡";
          }
          return;
        }

        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "Reply ⚡";
        }
      };

      window._markAllReadFn = async function () {
        const uid = window._sparkUser?.uid;
        if (!uid) return;
        try {
          const snap = await getDocs(
            query(
              collection(db, "users", uid, "notifications"),
              where("read", "==", false),
            ),
          );
          if (snap.empty) {
            if (typeof window.closeNotifPanel === "function")
              window.closeNotifPanel();
            return;
          }
          const batch = writeBatch(db);
          snap.forEach((d) => batch.update(d.ref, { read: true }));
          await batch.commit();

          // Remove all unread row highlights
          document
            .querySelectorAll(".notif-row.unread")
            .forEach((r) => r.classList.remove("unread"));

          // Remove all section has-unread states and reset counts
          document
            .querySelectorAll(".notif-section-header.has-unread")
            .forEach((h) => {
              h.classList.remove("has-unread");
              const dot = h.querySelector(".notif-section-dot");
              if (dot) dot.style.display = "none";
              const countEl = h.querySelector(".notif-section-count");
              const body = h.nextElementSibling;
              if (countEl && body) {
                const total = body.querySelectorAll(".notif-row").length;
                countEl.classList.remove("has-new");
                countEl.textContent = total;
              }
              const chevron = h.querySelector(".notif-section-chevron");
              if (chevron) chevron.style.transform = "rotate(0deg)";
              // Collapse the section body
              if (body) body.classList.remove("open");
            });

          // Auto-close panel after short delay so user sees the update
          setTimeout(() => {
            if (typeof window.closeNotifPanel === "function")
              window.closeNotifPanel();
          }, 420);
        } catch (e) {
          console.error("markAllRead:", e);
        }
      };

      // ── SKELETON SHOW/HIDE ──
      function hidePageSkeleton() {
        ["skLeft", "skFeed", "skRight"].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.add("sk-hidden");
        });
        ["realLeft", "realFeed", "realRight"].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.remove("sk-hidden");
        });
      }

      // ── FEED — fetch all standard sparks, sort client-side ──

      function buildSkeleton() {
        const s = document.createElement("div");
        s.className = "skeleton-card";
        s.innerHTML = `
    <div class="skeleton-head">
      <div class="skeleton-av"></div>
      <div class="skeleton-meta">
        <div class="skeleton-line w60"></div>
        <div class="skeleton-line w40"></div>
      </div>
    </div>
    <div class="skeleton-line w90"></div>
    <div class="skeleton-line w75"></div>
    <div class="skeleton-actions">
      <div class="skeleton-act"></div>
      <div class="skeleton-act"></div>
      <div class="skeleton-act"></div>
      <div class="skeleton-act"></div>
    </div>
  `;
        return s;
      }

      async function startFeed() {
        // Target realFeed — the revealed content container inside panel-0
        const container = document.getElementById("realFeed");
        if (!container) return;

        // Remove any previously rendered Firestore cards
        container
          .querySelectorAll(".spark-card[data-spark-id]")
          .forEach((el) => el.remove());

        try {
          const snap = await getDocs(
            query(collection(db, SPARKS_COL), where("tab", "==", "standard")),
          );

          if (snap.empty) return;

          const docs = [];
          snap.forEach((d) => docs.push({ id: d.id, data: d.data() }));

          // Sort newest-first client-side — handles Firestore Timestamp, ISO string, or null
          const toMs = (ts) => {
            if (!ts) return 0;
            if (ts.toMillis) return ts.toMillis();
            const ms = new Date(ts).getTime();
            return isNaN(ms) ? 0 : ms;
          };
          docs.sort((a, b) => toMs(b.data.createdAt) - toMs(a.data.createdAt));

          // ── Fetch rank for each unique author UID ──
          const uniqueUids = [
            ...new Set(
              docs
                .slice(0, 50)
                .map(({ data: d }) => d.uid)
                .filter(Boolean),
            ),
          ];
          const rankCache = {};
          await Promise.all(
            uniqueUids.map(async (uid) => {
              try {
                const uSnap = await getDoc(doc(db, "users", uid));
                if (uSnap.exists()) {
                  const ud = uSnap.data();
                  // Compute level from XP so it's always accurate regardless of stored value
                  const pt = ud.accountStatus?.point || ud.point || {};
                  const totalXP =
                    (pt.spark || 0) * 20 +
                    (pt.like || 0) * 10 +
                    (pt.reply || 0) * 40;
                  const XP_THRESHOLDS = [
                    0, 550, 1650, 3300, 5500, 8250, 11550, 15400, 19800, 24750,
                    30250, 36300, 42900, 50050, 57750, 66000, 74800, 84150,
                    94050, 104500, 115500, 127050, 139150, 151800, 165000,
                    178750, 193050, 207900, 223300, 239250,
                  ];
                  let computedLevel = 1;
                  for (let i = XP_THRESHOLDS.length - 1; i >= 0; i--) {
                    if (totalXP >= XP_THRESHOLDS[i]) {
                      computedLevel = i + 1;
                      break;
                    }
                  }
                  rankCache[uid] = `LV ${computedLevel}`;
                } else {
                  rankCache[uid] = "LV 1";
                }
              } catch (rankErr) {
                console.warn(
                  "rank fetch error for uid",
                  uid,
                  rankErr?.code,
                  rankErr?.message,
                );
                rankCache[uid] = "LV 1";
              }
            }),
          );

          docs
            .slice(0, 50)
            .forEach(({ id, data }) =>
              renderCard(id, data, rankCache[data.uid] || "LV 1"),
            );
        } catch (e) {
          console.error("startFeed error:", e);
        }
      }

      // ── RELATIVE TIME HELPER ──
      function timeAgo(ts) {
        if (!ts) return "just now";
        const date = ts.toDate ? ts.toDate() : new Date(ts);
        const secs = Math.floor((Date.now() - date.getTime()) / 1000);
        if (secs < 30) return "just now";
        if (secs < 60) return `${secs}s ago`;
        const mins = Math.floor(secs / 60);
        if (mins < 60) return `${mins}m ago`;
        const hrs = Math.floor(mins / 60);
        if (hrs < 24) return `${hrs}h ago`;
        const days = Math.floor(hrs / 24);
        if (days < 7) return `${days}d ago`;
        const wks = Math.floor(days / 7);
        if (wks < 5) return `${wks}w ago`;
        const mths = Math.floor(days / 30);
        if (mths < 12) return `${mths}mo ago`;
        return `${Math.floor(mths / 12)}y ago`;
      }

      // ── RENDER ONE CARD INTO FEED ──
      function renderCard(id, d, rankLabel) {
        const panel = document.getElementById("realFeed");
        if (!panel) return;

        const name = d.authorName || "T1ERA User";
        const handle = d.authorHandle || "user";
        const photo = d.authorPhoto || "";
        const txt = d.text || "";
        const initial = name[0].toUpperCase();

        const avBg =
          "background:linear-gradient(135deg,var(--pink),var(--purple))";
        const avInner = photo
          ? `<img src="${photo}" referrerpolicy="no-referrer" style="width:100%;height:100%;object-fit:cover;border-radius:50%;display:block;" onerror="this.style.display='none'">`
          : initial;

        const linkedTxt = txt
          .replace(/(#\w+)/g, '<span class="ht">$1</span>')
          .replace(/(@\w+)/g, '<span class="mn">$1</span>');

        // Detect ```quote ... ``` blocks and extract quote content
        const quoteMatch = txt.match(/```quote\n([\s\S]*?)\n```/);
        const quoteContent = quoteMatch ? quoteMatch[1] : null;
        const displayTxt = quoteContent
          ? linkedTxt.replace(/```quote\n[\s\S]*?\n```/, "").trim()
          : linkedTxt;

        const quoteBlockHtml = quoteContent
          ? `<div class="quote-block"><div class="quote-block-label"><i class="ph-bold ph-quotes"></i> Quote</div>${quoteContent.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>`
          : d.quoteText
            ? `<div class="quote-block"><div class="quote-block-label"><i class="ph-bold ph-quotes"></i> Quote</div>${String(d.quoteText).replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>`
            : "";

        const safeText = txt.replace(/'/g, "\\'").slice(0, 80);
        const safePhoto = photo.replace(/'/g, "\\'");

        const isOwner =
          d.uid && window._sparkUser && d.uid === window._sparkUser.uid;

        const dotsOrDelete = isOwner
          ? `<button class="dots-btn" onclick="event.stopPropagation();deleteSparkCard(this)" title="Delete Spark" style="color:var(--text-3)"><i class="ph-bold ph-trash"></i></button>`
          : `<button class="dots-btn" onclick="event.stopPropagation()"><i class="ph-bold ph-dots-three-vertical"></i></button>`;

        const article = document.createElement("article");
        article.className = "spark-card";
        article.dataset.sparkId = id;
        article.dataset.ownerUid = d.uid || "";
        article.setAttribute("onclick", "openSparkDetail(this)");
        article.innerHTML = `
    <div class="card-head">
      <div class="av-wrap">
        <div class="spark-av" style="${avBg}">${avInner}</div>
      </div>
      <div class="card-meta">
        <div class="meta-row-1">
          <span class="author-name">${name}</span>
          <span class="author-handle">@${handle}</span>
          <span class="spark-time">${timeAgo(d.createdAt)}</span>
        </div>
        <div class="badges-row">
          <span class="badge rank">${rankLabel || "LV 1"}</span>
          ${
            !isOwner
              ? (() => {
                  const isFollowing =
                    window._followingSet &&
                    window._followingSet.has(d.uid || "");
                  return isFollowing
                    ? `<button class="badge follow-badge following" onclick="event.stopPropagation();toggleFollowBadge(this)"><i class="ph-bold ph-check"></i> Following</button>`
                    : `<button class="badge follow-badge" onclick="event.stopPropagation();toggleFollowBadge(this)"><i class="ph-bold ph-user-plus"></i> Follow</button>`;
                })()
              : ""
          }
        </div>
      </div>
      ${dotsOrDelete}
    </div>
    <div class="card-content">
      <p class="spark-text">${displayTxt}</p>
      ${quoteBlockHtml}
      ${
        d.youtubeId
          ? `<div class="yt-card" onclick="event.stopPropagation();openYtModal('` +
            d.youtubeId +
            `')">
        <div class="yt-thumb-wrap">
          <img src="https://i.ytimg.com/vi/` +
            d.youtubeId +
            `/hqdefault.jpg" alt="YouTube video">
          <div class="yt-play-btn"><div class="yt-play-icon"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div></div>
        </div>
        <div class="yt-label">
          <div class="yt-logo"><svg viewBox="0 0 24 24" fill="#fff"><path d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.5 3.5 12 3.5 12 3.5s-7.5 0-9.4.6A3 3 0 0 0 .5 6.2 31.4 31.4 0 0 0 0 12a31.4 31.4 0 0 0 .5 5.8 3 3 0 0 0 2.1 2.1c1.9.6 9.4.6 9.4.6s7.5 0 9.4-.6a3 3 0 0 0 2.1-2.1A31.4 31.4 0 0 0 24 12a31.4 31.4 0 0 0-.5-5.8zM9.7 15.5V8.5l6.3 3.5-6.3 3.5z"/></svg></div>
          <span class="yt-url-text">youtube.com/watch?v=` +
            d.youtubeId +
            `</span>
          <span style="font-size:10px;color:var(--text-3);margin-left:auto;flex-shrink:0;padding-right:4px">▶ Play</span>
        </div>
      </div>`
          : ""
      }
    </div>
    <div class="action-bar">
      <button class="act-btn like" id="like-${id}" onclick="event.stopPropagation();toggleLike(this)"><i class="ph-bold ph-heart"></i><span id="likecount-${id}">0</span></button>
      <button class="act-btn reply" onclick="event.stopPropagation();openReply('${name}','${initial}','#c2185b','${safeText}','${id}','${d.uid || ""}','${handle}','${safePhoto}')"><i class="ph-bold ph-chat-circle"></i><span id="replycount-${id}">0</span></button>
      <button class="act-btn repost" onclick="event.stopPropagation();toggleRepost(this)"><i class="ph-bold ph-repeat"></i><span>${d.reposts || 0}</span></button>
      <button class="act-btn share" onclick="event.stopPropagation();shareSpark()"><i class="ph-bold ph-share-network"></i><span></span></button>
      <button class="act-btn bookmark" onclick="event.stopPropagation();toggleBookmark(this)" style="margin-left:auto"><i class="ph-bold ph-bookmark-simple"></i></button>
    </div>
  `;

        // Place before the first demo card inside realFeed (demo cards have no data-spark-id)
        const firstDemo = panel.querySelector(
          ".spark-card:not([data-spark-id])",
        );
        if (firstDemo) {
          panel.insertBefore(article, firstDemo);
        } else {
          panel.appendChild(article);
        }

        // Fetch likes subcollection — get real count + check if current user liked
        const currentUid = window._sparkUser?.uid;
        getDocs(collection(db, "sparks", id, "likes"))
          .then((likesSnap) => {
            // Real count
            const countEl = document.getElementById("likecount-" + id);
            if (countEl) countEl.textContent = likesSnap.size;
            // Highlight if current user liked
            if (currentUid) {
              const alreadyLiked = likesSnap.docs.some(
                (d) => d.id === currentUid,
              );
              if (alreadyLiked) {
                const likeBtn = document.getElementById("like-" + id);
                if (likeBtn) {
                  likeBtn.classList.add("liked");
                  likeBtn.querySelector("i").className = "ph-fill ph-heart";
                  likeBtn.querySelector("span").textContent = likesSnap.size;
                }
              }
            }
          })
          .catch(() => {
            const countEl = document.getElementById("likecount-" + id);
            if (countEl) countEl.textContent = "0";
          });

        // Fetch reply count from subcollection
        getDocs(collection(db, "sparks", id, "comments"))
          .then((repliesSnap) => {
            const el = document.getElementById("replycount-" + id);
            if (el) el.textContent = repliesSnap.size;
          })
          .catch(() => {});
      }

      // ── DELETE SPARK (owner only) ──
      window.deleteSparkCard = async function (btn) {
        const card = btn.closest(".spark-card[data-spark-id]");
        if (!card) return;
        const sparkId = card.dataset.sparkId;
        if (!sparkId) return;

        if (!confirm("Delete this Spark? This cannot be undone.")) return;

        try {
          await deleteDoc(doc(db, SPARKS_COL, sparkId));
          // Remove card from DOM immediately
          card.remove();
        } catch (e) {
          console.error("Delete failed:", e);
          alert("Failed to delete. Please try again.");
        }
      };

      // ── POST NEW SPARK ──
      window._submitSparkFn = async function () {
        const user = window._sparkUser;
        if (!user) return;

        const txt = document.getElementById("composeTa").value.trim();
        if (!txt) return;

        // Dev bypass — ewm24k@gmail.com unlimited
        const isDev = user.email === DEV_EMAIL;

        if (!isDev && (window._todayCount || 0) >= DAILY_LIMIT) {
          alert(
            `You have reached your daily limit of ${DAILY_LIMIT} Sparks. Come back tomorrow!`,
          );
          return;
        }

        const btn = document.getElementById("submitBtn");
        if (btn) {
          btn.disabled = true;
          btn.textContent = "Posting…";
        }

        const ud = window._sparkUserData || {};
        const name = ud.fullName || user.displayName || "T1ERA User";
        const handle = (user.email || "user").split("@")[0];
        const photo = ud.profilePicture?.url || user.photoURL || "";
        const today = getToday();

        try {
          const sparkData = {
            uid: user.uid,
            authorName: name,
            authorHandle: handle,
            authorPhoto: photo,
            text: txt,
            tab: "standard",
            dateStr: today,
            createdAt: serverTimestamp(),
            likes: 0,
            replies: 0,
            reposts: 0,
          };
          // Attach YouTube video ID if user pasted a YouTube link
          if (window._pendingYtId) {
            sparkData.youtubeId = window._pendingYtId;
          }
          // Attach quoteText if user inserted a ```quote block
          const quoteMatch = txt.match(/```quote\n([\s\S]*?)\n```/);
          if (quoteMatch) {
            sparkData.quoteText = quoteMatch[1];
          }
          await addDoc(collection(db, SPARKS_COL), sparkData);

          // Award +20 XP for posting a spark (increment count by 1; profile.html multiplies by 20)
          try {
            await updateDoc(doc(db, "users", user.uid), {
              "point.spark": increment(1),
            });
          } catch (xpe) {
            console.warn("XP spark award error:", xpe);
          }

          // Show success toast
          if (typeof window.showToast === "function")
            window.showToast("Spark posted ⚡");

          // Reset button
          if (btn) {
            btn.disabled = false;
            btn.textContent = "Spark ⚡";
          }

          // Close compose box
          if (typeof window.closeCompose === "function") window.closeCompose();

          // Reload feed so new post appears immediately
          await startFeed();

          // Refresh quota count
          if (!isDev) await checkQuota(user.uid);
        } catch (e) {
          console.error("Post failed:", e);
          alert("Failed to post. Please try again.");
          if (btn) {
            btn.disabled = false;
            btn.textContent = "Spark ⚡";
          }
        }
      };

      // ── DAILY QUOTA ──
      async function checkQuota(uid) {
        const banner = document.getElementById("quotaBanner");
        const quotaMsg = document.getElementById("quotaMsg");
        const quotaReset = document.getElementById("quotaReset");
        const btn = document.getElementById("submitBtn");
        const toggle = document.getElementById("composeToggle");

        // Dev = unlimited
        if (window._sparkUser && window._sparkUser.email === DEV_EMAIL) {
          banner.classList.remove("show", "warn", "full");
          if (btn)
            btn.disabled =
              document.getElementById("composeTa")?.value.trim().length === 0;
          if (toggle) {
            toggle.style.opacity = "1";
            toggle.style.pointerEvents = "auto";
          }
          window._todayCount = 0;
          return;
        }

        try {
          const today = getToday();
          const snap = await getDocs(
            query(
              collection(db, SPARKS_COL),
              where("uid", "==", uid),
              where("dateStr", "==", today),
              where("tab", "==", "standard"),
            ),
          );
          const count = snap.size;
          window._todayCount = count;

          banner.classList.remove("show", "warn", "full");

          if (count === 0) {
            if (btn)
              btn.disabled =
                document.getElementById("composeTa")?.value.trim().length === 0;
            if (toggle) {
              toggle.style.opacity = "1";
              toggle.style.pointerEvents = "auto";
            }
          } else if (count < DAILY_LIMIT) {
            const remaining = DAILY_LIMIT - count;
            banner.classList.add("show", "warn");
            quotaMsg.textContent = `${count} of ${DAILY_LIMIT} daily Sparks used — ${remaining} remaining`;
            quotaReset.textContent = getMidnightText();
            if (btn)
              btn.disabled =
                document.getElementById("composeTa")?.value.trim().length === 0;
            if (toggle) {
              toggle.style.opacity = "1";
              toggle.style.pointerEvents = "auto";
            }
            setTimeout(() => banner.classList.remove("show", "warn"), 2000);
          } else {
            banner.classList.add("show", "full");
            quotaMsg.textContent = `Daily limit reached — ${DAILY_LIMIT} Sparks per day maximum`;
            quotaReset.textContent = getMidnightText();
            if (btn) btn.disabled = true;
            if (toggle) {
              toggle.style.opacity = "0.45";
              toggle.style.pointerEvents = "none";
            }
            if (typeof window.closeCompose === "function")
              window.closeCompose();
          }
        } catch (e) {
          window._todayCount = 0;
        }
      }

      // ── HELPERS ──
      function getToday() {
        const n = new Date();
        return `${n.getFullYear()}-${String(n.getMonth() + 1).padStart(2, "0")}-${String(n.getDate()).padStart(2, "0")}`;
      }

      function getMidnightText() {
        const now = new Date();
        const mid = new Date(now);
        mid.setHours(24, 0, 0, 0);
        const ms = mid - now;
        const h = Math.floor(ms / 3600000);
        const m = Math.floor((ms % 3600000) / 60000);
        return h > 0 ? `Resets in ${h}h ${m}m` : `Resets in ${m}m`;
      }

      // ── APPLY AVATAR TO COMPOSE BOXES ──
      function applyComposeAvatar(photoURL, initial) {
        const miniAv = document.getElementById("miniAv");
        const composeAv = document.getElementById("composeAv");
        const replyAvs = document.querySelectorAll(".reply-av");

        if (photoURL) {
          [miniAv, composeAv].forEach((el) => {
            if (!el) return;
            el.textContent = "";
            el.style.background = "none";
            el.style.padding = "0";
            const img = document.createElement("img");
            img.src = photoURL;
            img.alt = "avatar";
            img.referrerPolicy = "no-referrer";
            img.style.cssText =
              "width:100%;height:100%;object-fit:cover;border-radius:50%;display:block;";
            img.onerror = () => {
              el.textContent = initial;
              el.style.background = "";
            };
            el.appendChild(img);
          });
          replyAvs.forEach((el) => {
            el.textContent = "";
            el.style.background = "none";
            el.style.padding = "0";
            const img = document.createElement("img");
            img.src = photoURL;
            img.alt = "avatar";
            img.referrerPolicy = "no-referrer";
            img.style.cssText =
              "width:100%;height:100%;object-fit:cover;border-radius:50%;display:block;";
            img.onerror = () => {
              el.textContent = initial;
              el.style.background = "";
            };
            el.appendChild(img);
          });
        } else {
          if (miniAv) miniAv.textContent = initial;
          if (composeAv) composeAv.textContent = initial;
          replyAvs.forEach((el) => {
            el.textContent = initial;
          });
        }
      }
    </script>

    <!-- ═══════════════════════════
     EMOJI PICKER OVERLAY
═══════════════════════════ -->
    <div
      class="emoji-picker-overlay"
      id="emojiPickerOverlay"
      onclick="if (event.target === this) closeEmojiPicker();"
    >
      <div class="emoji-picker-popup">
        <div class="emoji-picker-header">
          <span class="emoji-picker-title"
            ><i class="ph-bold ph-smiley"></i> Pick an Emoji</span
          >
          <button class="emoji-picker-close" onclick="closeEmojiPicker()">
            <i class="ph-bold ph-x"></i>
          </button>
        </div>
        <div class="emoji-picker-grid" id="emojiPickerGrid"></div>
      </div>
    </div>

    <!-- ═══════════════════════════
     YOUTUBE VIDEO MODAL
═══════════════════════════ -->
    <div
      class="yt-modal-overlay"
      id="ytModalOverlay"
      onclick="if (event.target === this) closeYtModal();"
    >
      <div class="yt-modal-inner">
        <button class="yt-modal-close" onclick="closeYtModal()">
          <i class="ph-bold ph-x"></i>
        </button>
        <div class="yt-modal-iframe-wrap" id="ytModalIframeWrap"></div>
      </div>
    </div>

    <!-- ═══════════════════════════
     NOTIFICATION BACKDROP
═══════════════════════════ -->
    <div
      class="notif-backdrop"
      id="notifBackdrop"
      onclick="closeNotifPanel()"
    ></div>

    <!-- ═══════════════════════════
     NOTIFICATION PANEL
═══════════════════════════ -->
    <div class="notif-panel" id="notifPanel">
      <div class="notif-header">
        <div class="notif-title">
          <i class="ph-bold ph-bell"></i> Notifications
        </div>
        <div style="display: flex; align-items: center; gap: 8px">
          <button class="notif-mark-all" onclick="markAllRead()">
            Mark all read
          </button>
          <button
            class="settings-close"
            onclick="closeNotifPanel()"
            title="Close"
            style="width: 24px; height: 24px; font-size: 12px"
          >
            <i class="ph-bold ph-x"></i>
          </button>
        </div>
      </div>
      <div class="notif-list" id="notifList">
        <!-- filled dynamically -->
        <div class="notif-empty" id="notifEmpty">
          <i class="ph-bold ph-bell-slash"></i>
          <p>No notifications yet</p>
        </div>
      </div>
    </div>

    <!-- ═══════════════════════════
     SETTINGS PANEL
═══════════════════════════ -->
    <div
      class="notif-backdrop"
      id="settingsBackdrop"
      onclick="closeSettingsPanel()"
    ></div>
    <div class="settings-panel" id="settingsPanel">
      <div class="settings-header">
        <div class="settings-title">
          <i class="ph-bold ph-gear"></i> Settings
        </div>
        <button class="settings-close" onclick="closeSettingsPanel()">
          <i class="ph-bold ph-x"></i>
        </button>
      </div>
      <div class="settings-body">
        <div>
          <div class="settings-section-label">Account</div>
          <div class="settings-placeholder">
            <i class="ph-bold ph-user-circle"></i>
            <span>Account settings — coming soon</span>
          </div>
        </div>

        <div>
          <div class="settings-section-label">Appearance</div>
          <div class="settings-placeholder">
            <i class="ph-bold ph-paint-brush"></i>
            <span>Theme &amp; display — coming soon</span>
          </div>
        </div>

        <div>
          <div class="settings-section-label">Notifications</div>
          <div class="settings-placeholder">
            <i class="ph-bold ph-bell"></i>
            <span>Notification preferences — coming soon</span>
          </div>
        </div>

        <div>
          <div class="settings-section-label">Privacy &amp; Security</div>
          <div class="settings-placeholder">
            <i class="ph-bold ph-shield"></i>
            <span>Privacy controls — coming soon</span>
          </div>
        </div>

        <div>
          <div class="settings-section-label">Language &amp; Region</div>
          <div class="settings-placeholder">
            <i class="ph-bold ph-translate"></i>
            <span>Language &amp; region — coming soon</span>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
